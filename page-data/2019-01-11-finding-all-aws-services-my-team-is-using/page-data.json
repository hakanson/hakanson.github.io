{"componentChunkName":"component---src-templates-blog-post-js","path":"/2019-01-11-finding-all-aws-services-my-team-is-using","result":{"data":{"site":{"siteMetadata":{"title":"kevinhakanson.com","author":"Kevin Hakanson"}},"markdownRemark":{"id":"831a9966-f805-5209-b12f-036d52f70580","excerpt":"I was reading Automate analyzing your permissions using IAM access advisor APIs | AWS Security Blog and realized it would also be way see what AWS features one…","html":"<p>I was reading <a href=\"https://aws.amazon.com/blogs/security/automate-analyzing-permissions-using-iam-access-advisor/\">Automate analyzing your permissions using IAM access advisor APIs | AWS Security Blog</a> and realized it would also be way see what AWS features one of my project teams (a.k.a. redacted-project) was using.</p>\n<p>So, I put together a Python script to call <a href=\"https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/iam.html#IAM.Client.generate_service_last_accessed_details\">generate_service_last_accessed_details</a> / <a href=\"https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/iam.html#IAM.Client.get_service_last_accessed_details\">get_service_last_accessed_details</a>  then sorted by the most recent LastAuthenticated date to get the ServiceName list.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">2019-01-11 20:23:00+00:00 AWS CodeCommit\n2019-01-11 20:20:00+00:00 AWS Health APIs and Notifications\n2019-01-11 20:20:00+00:00 AWS CloudFormation\n2019-01-11 20:19:00+00:00 AWS Key Management Service\n2019-01-11 20:18:00+00:00 Amazon S3\n2019-01-11 20:12:00+00:00 AWS CodeBuild\n2019-01-11 20:11:00+00:00 AWS CodePipeline\n2019-01-11 20:04:00+00:00 Amazon Elasticsearch Service\n2019-01-11 19:57:00+00:00 AWS AppSync\n2019-01-11 19:56:00+00:00 Amazon DynamoDB\n2019-01-11 19:56:00+00:00 AWS Identity and Access Management\n2019-01-11 19:55:00+00:00 AWS Lambda\n2019-01-11 19:51:00+00:00 Amazon CloudWatch Logs\n2019-01-11 19:28:00+00:00 Amazon SNS\n2019-01-11 18:15:00+00:00 AWS Security Token Service\n2019-01-11 17:40:00+00:00 Amazon CloudWatch\n2019-01-11 17:39:00+00:00 Application Auto Scaling\n2019-01-11 01:00:00+00:00 AWS Cloud9\n2019-01-11 00:36:00+00:00 Amazon Resource Group Tagging API\n2019-01-11 00:36:00+00:00 Amazon EC2\n2019-01-10 21:10:00+00:00 Amazon Cognito User Pools\n2019-01-10 21:09:00+00:00 Amazon Cognito Identity\n2019-01-10 17:35:00+00:00 Amazon CloudWatch Events\n2019-01-10 17:27:00+00:00 Amazon EC2 Auto Scaling\n2019-01-09 23:54:00+00:00 AWS Amplify\n2019-01-09 15:49:00+00:00 AWS CloudTrail\n2019-01-08 23:25:00+00:00 Amazon EC2 Container Registry\n2019-01-08 22:17:00+00:00 AWS Resource Groups\n2019-01-08 17:43:00+00:00 AWS Systems Manager\n2018-12-18 20:46:00+00:00 AWS X-Ray\n2018-12-18 14:40:00+00:00 AWS Serverless Application Repository\n2018-12-18 13:17:00+00:00 Elastic Load Balancing\n2018-12-17 19:29:00+00:00 AWS CodeDeploy\n2018-12-17 19:22:00+00:00 AWS Directory Service\n2018-12-10 19:48:00+00:00 AWS Config\n2018-12-07 22:42:00+00:00 Amazon SimpleDB\n2018-12-07 22:42:00+00:00 Amazon SQS\n2018-12-07 22:42:00+00:00 AWS Elastic Beanstalk\n2018-12-07 20:51:00+00:00 AWS Support\n2018-12-04 17:21:00+00:00 Manage - Amazon API Gateway\n2018-12-03 23:01:00+00:00 Amazon Kinesis\n2018-12-03 20:53:00+00:00 Data Pipeline\n2018-12-03 19:34:00+00:00 Amazon Kinesis Firehose\n2018-11-30 21:33:00+00:00 Amazon CloudFront\n2018-11-29 23:09:00+00:00 AWS Database Migration Service\n2018-11-27 18:00:00+00:00 AWS CodeStar\n2018-11-22 01:52:00+00:00 AWS Trusted Advisor</code></pre></div>\n<p>Here’s the python code (which could likely be much improved)</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> sys\n<span class=\"token keyword\">import</span> time\n<span class=\"token keyword\">import</span> boto3\n\nARG_PROFILE  <span class=\"token operator\">=</span> <span class=\"token string\">'aws-account-alias'</span>\nARN <span class=\"token operator\">=</span> <span class=\"token string\">'arn:aws:sts::123456789012:role/human-role/redacted-project'</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n  session <span class=\"token operator\">=</span> boto3<span class=\"token punctuation\">.</span>session<span class=\"token punctuation\">.</span>Session<span class=\"token punctuation\">(</span>profile_name<span class=\"token operator\">=</span>ARG_PROFILE<span class=\"token punctuation\">)</span>\n  client <span class=\"token operator\">=</span> session<span class=\"token punctuation\">.</span>client<span class=\"token punctuation\">(</span><span class=\"token string\">'iam'</span><span class=\"token punctuation\">)</span>\n\n  response <span class=\"token operator\">=</span> client<span class=\"token punctuation\">.</span>generate_service_last_accessed_details<span class=\"token punctuation\">(</span>\n      Arn<span class=\"token operator\">=</span>ARN\n  <span class=\"token punctuation\">)</span>\n  job_id <span class=\"token operator\">=</span> response<span class=\"token punctuation\">[</span><span class=\"token string\">'JobId'</span><span class=\"token punctuation\">]</span>\n\n  <span class=\"token keyword\">while</span> <span class=\"token boolean\">True</span><span class=\"token punctuation\">:</span>\n    time<span class=\"token punctuation\">.</span>sleep<span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f'checking </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>job_id<span class=\"token punctuation\">}</span></span><span class=\"token string\">'</span></span><span class=\"token punctuation\">)</span>\n    response <span class=\"token operator\">=</span> client<span class=\"token punctuation\">.</span>get_service_last_accessed_details<span class=\"token punctuation\">(</span>\n        JobId<span class=\"token operator\">=</span>job_id\n    <span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> response<span class=\"token punctuation\">[</span><span class=\"token string\">'JobStatus'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span> <span class=\"token string\">'COMPLETED'</span><span class=\"token punctuation\">:</span>\n      <span class=\"token keyword\">break</span>\n  \n  services <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n  <span class=\"token keyword\">for</span> service <span class=\"token keyword\">in</span> response<span class=\"token punctuation\">[</span><span class=\"token string\">'ServicesLastAccessed'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>service<span class=\"token punctuation\">[</span><span class=\"token string\">'TotalAuthenticatedEntities'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n      services<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token string\">'{LastAuthenticated} {ServiceName}'</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span><span class=\"token operator\">**</span>service<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  \n  <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token builtin\">sorted</span><span class=\"token punctuation\">(</span>services<span class=\"token punctuation\">,</span> reverse<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> sep<span class=\"token operator\">=</span><span class=\"token string\">'\\n'</span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">if</span> __name__ <span class=\"token operator\">==</span> <span class=\"token string\">'__main__'</span><span class=\"token punctuation\">:</span>\n    sys<span class=\"token punctuation\">.</span>exit<span class=\"token punctuation\">(</span>main<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>","frontmatter":{"title":"Finding all AWS Services my Team is Using","date":"January 11, 2019","tags":["aws","python","iam"]}}},"pageContext":{"slug":"/2019-01-11-finding-all-aws-services-my-team-is-using","previous":{"fields":{"slug":"/2018-12-18-architecture-decision-records-adrs"},"frontmatter":{"tags":["architecture","agile"]}},"next":{"fields":{"slug":"/2019-04-10-aws-iam-policy-for-service-user-s3-access"},"frontmatter":{"tags":["aws","iam","s3"]}}}}}