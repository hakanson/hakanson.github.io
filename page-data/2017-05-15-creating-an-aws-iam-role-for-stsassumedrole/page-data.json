{"componentChunkName":"component---src-templates-blog-post-js","path":"/2017-05-15-creating-an-aws-iam-role-for-stsassumedrole","result":{"data":{"site":{"siteMetadata":{"title":"kevinhakanson.com","author":"Kevin Hakanson"}},"markdownRemark":{"id":"2669537f-4861-5836-81d4-cb2d0f4d3c75","excerpt":"This post is a research summary of tasks relating to creating an IAM role via the CLI: The “trust policy” only included an explicit single member of the  role…","html":"<p>This post is a research summary of tasks relating to creating an IAM role via the CLI:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ aws iam create-role <span class=\"token punctuation\">\\</span>\n--role-name kjh-wildcard-test-role <span class=\"token punctuation\">\\</span>\n--assume-role-policy-document file://kjh-wildcard-test-role.iam.policy.json</code></pre></div>\n<p>The “trust policy” only included an explicit single member of the <code class=\"language-text\">204503-PowerUser</code> role: kevin.hakanson@example.com</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"Version\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2012-10-17\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"Statement\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"Effect\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Allow\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"Principal\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"AWS\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n          <span class=\"token string\">\"arn:aws:sts::123456789012:assumed-role/204503-PowerUser/kevin.hakanson@example.com\"</span>\n        <span class=\"token punctuation\">]</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"Action\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"sts:AssumeRole\"</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Test if it works via the CLI, and it does.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ aws sts assume-role <span class=\"token punctuation\">\\</span>\n--role-arn arn:aws:iam::123456789012:role/kjh-wildcard-test-role <span class=\"token punctuation\">\\</span>\n--role-session-name cli-kjh-wildcard-test-role</code></pre></div>\n<p>Update <code class=\"language-text\">~/.aws/config</code> to enable the <code class=\"language-text\">--profile</code> CLI option:</p>\n<div class=\"gatsby-highlight\" data-language=\"ini\"><pre class=\"language-ini\"><code class=\"language-ini\"><span class=\"token selector\">[profile kjh-wildcard-test-role]</span>\n<span class=\"token constant\">role_arn</span> <span class=\"token attr-value\"><span class=\"token punctuation\">=</span> arn:aws:iam::123456789012:role/kjh-wildcard-test-role</span>\n<span class=\"token constant\">source_profile</span> <span class=\"token attr-value\"><span class=\"token punctuation\">=</span> xx-sandbox</span></code></pre></div>\n<p>Try something “easy”, like <code class=\"language-text\">get-role</code></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ aws iam --profile kjh-wildcard-test-role <span class=\"token punctuation\">\\</span>\nget-role --role-name kjh-wildcard-test-role\n\nAn error occurred <span class=\"token punctuation\">(</span>AccessDenied<span class=\"token punctuation\">)</span> when calling the GetRole operation: User: arn:aws:sts::123456789012:assumed-role/kjh-wildcard-test-role/AWS-CLI-session-1494616606 is not authorized to perform: iam:GetRole on resource: role kjh-wildcard-test-role</code></pre></div>\n<p>It didn’t work because that new role has no permissions. Add an inline policy document via the console which lets this role get itself:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"Version\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2012-10-17\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Statement\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">\"Sid\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Stmt1494616662000\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"Effect\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Allow\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"Action\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n                <span class=\"token string\">\"iam:GetRole\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"iam:GetRolePolicy\"</span>\n            <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"Resource\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n                <span class=\"token string\">\"arn:aws:iam::123456789012:role/kjh-wildcard-test-role\"</span>\n            <span class=\"token punctuation\">]</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Try again and see a result. </p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ aws iam --profile kjh-wildcard-test-role <span class=\"token punctuation\">\\</span>\nget-role --role-name kjh-wildcard-test-role\n\n<span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"Role\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"AssumeRolePolicyDocument\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"Version\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2012-10-17\"</span>,\n            <span class=\"token string\">\"Statement\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span>\n                <span class=\"token punctuation\">{</span>\n                    <span class=\"token string\">\"Action\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"sts:AssumeRole\"</span>,\n                    <span class=\"token string\">\"Effect\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"Allow\"</span>,\n                    <span class=\"token string\">\"Principal\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n                        <span class=\"token string\">\"AWS\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"arn:aws:sts::123456789012:assumed-role/204503-PowerUser/kevin.hakanson@example.com\"</span>\n                    <span class=\"token punctuation\">}</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">]</span>\n        <span class=\"token punctuation\">}</span>,\n        <span class=\"token string\">\"RoleId\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"AROAZZZZZZZZZZZZZZZZZ\"</span>,\n        <span class=\"token string\">\"CreateDate\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2017-05-12T19:09:07Z\"</span>,\n        <span class=\"token string\">\"RoleName\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"kjh-wildcard-test-role\"</span>,\n        <span class=\"token string\">\"Path\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"/\"</span>,\n        <span class=\"token string\">\"Arn\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"arn:aws:iam::123456789012:role/kjh-wildcard-test-role\"</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Since this only applies to kevin.hakanson@example.com, I’ll try and expand to “everyone” in <code class=\"language-text\">204503-PowerUser</code>, but wildcards don’t work here.</p>\n<blockquote>\n<p>An error occurred: Invalid principal in policy: “AWS”:“arn:aws:sts::123456789012:assumed-role/204503-PowerUser/*”</p>\n</blockquote>\n<p>Instead, find the <code class=\"language-text\">RoleId</code> for <code class=\"language-text\">204503-PowerUser</code></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ aws iam get-role --role-name <span class=\"token number\">204503</span>-PowerUser\n\n<span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"Role\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"AssumeRolePolicyDocument\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"Version\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2012-10-17\"</span>,\n            <span class=\"token string\">\"Statement\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span>\n                <span class=\"token punctuation\">{</span>\n                    <span class=\"token string\">\"Action\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"sts:AssumeRoleWithSAML\"</span>,\n                    <span class=\"token string\">\"Effect\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"Allow\"</span>,\n                    <span class=\"token string\">\"Condition\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n                        <span class=\"token string\">\"StringEquals\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n                            <span class=\"token string\">\"SAML:aud\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"https://signin.aws.amazon.com/saml\"</span>\n                        <span class=\"token punctuation\">}</span>\n                    <span class=\"token punctuation\">}</span>,\n                    <span class=\"token string\">\"Principal\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n                        <span class=\"token string\">\"Federated\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"arn:aws:iam::123456789012:saml-provider/ADFS\"</span>\n                    <span class=\"token punctuation\">}</span>\n                <span class=\"token punctuation\">}</span>,\n                <span class=\"token punctuation\">{</span>\n                    <span class=\"token string\">\"Action\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"sts:AssumeRole\"</span>,\n                    <span class=\"token string\">\"Effect\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"Allow\"</span>,\n                    <span class=\"token string\">\"Principal\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n                        <span class=\"token string\">\"Service\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"lambda.amazonaws.com\"</span>\n                    <span class=\"token punctuation\">}</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">]</span>\n        <span class=\"token punctuation\">}</span>,\n        <span class=\"token string\">\"RoleId\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"AROAXXXXXXXXXXXXXXXXX\"</span>,\n        <span class=\"token string\">\"CreateDate\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2017-04-05T14:28:24Z\"</span>,\n        <span class=\"token string\">\"RoleName\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"204503-PowerUser\"</span>,\n        <span class=\"token string\">\"Path\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"/204503/\"</span>,\n        <span class=\"token string\">\"Arn\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"arn:aws:iam::123456789012:role/204503/204503-PowerUser\"</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Then add a <code class=\"language-text\">Condition</code> that uses <code class=\"language-text\">aws:userId</code>, which is based on <code class=\"language-text\">RoleId</code> mentioned above.</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"Version\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2012-10-17\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"Statement\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"Effect\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Allow\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"Principal\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"AWS\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"arn:aws:iam::123456789012:root\"</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"Action\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"sts:AssumeRole\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"Condition\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"StringLike\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token property\">\"aws:userId\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"AROAXXXXXXXXXXXXXXXXX:*\"</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Try again and see a result that includes the new <code class=\"language-text\">AssumeRolePolicyDocument</code> section.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ aws iam --profile kjh-wildcard-test-role <span class=\"token punctuation\">\\</span>\nget-role --role-name kjh-wildcard-test-role\n\n<span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"Role\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"AssumeRolePolicyDocument\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"Version\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2012-10-17\"</span>,\n            <span class=\"token string\">\"Statement\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span>\n                <span class=\"token punctuation\">{</span>\n                    <span class=\"token string\">\"Action\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"sts:AssumeRole\"</span>,\n                    <span class=\"token string\">\"Effect\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"Allow\"</span>,\n                    <span class=\"token string\">\"Condition\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n                        <span class=\"token string\">\"StringLike\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n                            <span class=\"token string\">\"aws:userId\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"AROAXXXXXXXXXXXXXXXXX:*\"</span>\n                        <span class=\"token punctuation\">}</span>\n                    <span class=\"token punctuation\">}</span>,\n                    <span class=\"token string\">\"Principal\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n                        <span class=\"token string\">\"AWS\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"arn:aws:iam::123456789012:root\"</span>\n                    <span class=\"token punctuation\">}</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">]</span>\n        <span class=\"token punctuation\">}</span>,\n        <span class=\"token string\">\"RoleId\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"AROAZZZZZZZZZZZZZZZZZ\"</span>,\n        <span class=\"token string\">\"CreateDate\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2017-05-12T19:09:07Z\"</span>,\n        <span class=\"token string\">\"RoleName\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"kjh-wildcard-test-role\"</span>,\n        <span class=\"token string\">\"Path\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"/\"</span>,\n        <span class=\"token string\">\"Arn\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"arn:aws:iam::123456789012:role/kjh-wildcard-test-role\"</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Next steps are probably to automate as part of a Python script or CloudFormation template that creates these service roles, looking up the <code class=\"language-text\">RoleId</code> and building the trust policy there.</p>","frontmatter":{"title":"Creating an AWS IAM Role for sts:AssumedRole","description":null,"date":"May 15, 2017","tags":["aws","iam","cli"],"canonical":null}}},"pageContext":{"slug":"/2017-05-15-creating-an-aws-iam-role-for-stsassumedrole","previous":{"fields":{"slug":"/2017-04-27-amazon-rds-and-tag-based-permissions"},"frontmatter":{"tags":["aws","iam","rds"]}},"next":{"fields":{"slug":"/2017-06-25-amazon-elasticsearch-service-and-iam-policies-on-http-methods"},"frontmatter":{"tags":["aws","iam","elasticsearch"]}}}},"staticQueryHashes":["2589769190","3567236516"]}