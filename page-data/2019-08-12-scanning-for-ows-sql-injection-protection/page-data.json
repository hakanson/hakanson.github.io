{"componentChunkName":"component---src-templates-blog-post-js","path":"/2019-08-12-scanning-for-ows-sql-injection-protection","webpackCompilationHash":"7d39e4954020dd9078cb","result":{"data":{"site":{"siteMetadata":{"title":"kevinhakanson.com","author":"Kevin Hakanson"}},"markdownRemark":{"id":"237e3d9f-16e1-5a4d-9a55-2405684b2721","excerpt":"A few months ago, I was reviewing some code that was flagged by Veracode for multiple CWE-89: Improper Neutralization of Special Elements used in an SQL Command…","html":"<p>A few months ago, I was reviewing some code that was flagged by Veracode for multiple <strong><a href=\"http://cwe.mitre.org/data/definitions/89.html\">CWE-89</a>: Improper Neutralization of Special Elements used in an SQL Command (‘SQL Injection’)</strong> flaws. When working with the development team, they demonstrated that the SQL generation which triggers these flaws is part of <a href=\"http://www.openwebstudio.com/\">OpenWebStudio</a> (OWS) and is driven by configuration data.  I said that if we can prove we are generating from safe input, I could mitigate, but I wanted an in-depth review of the code paths.</p>\n<p>OWS does include the ability to <a href=\"http://www.openwebstudio.com/topic/Action_Variable.aspx#Protect_Against_SQL_Injection\">Protect Against SQL Injection</a> and even explicitly mentions to <strong>“ALWAYS check the box to protect against SQL Injection”</strong>.  Here is a screenshot from the <a href=\"http://www.openwebstudio.com/topic/Action_Variable.aspx\">Variable</a> documentation.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/634c8f77a3d614bc097171cc5af0049b/eaa3b/action.variable.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 49.7822931785196%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAKABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAgADBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAe4gTWMf/8QAFxAAAwEAAAAAAAAAAAAAAAAAAAEQMf/aAAgBAQABBQLKxT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAUEAEAAAAAAAAAAAAAAAAAAAAg/9oACAEBAAY/Al//xAAaEAACAgMAAAAAAAAAAAAAAAAAARARIUFR/9oACAEBAAE/IXgrElwqG5bP/9oADAMBAAIAAwAAABATD//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EABsQAQADAAMBAAAAAAAAAAAAAAEAESExUWGR/9oACAEBAAE/EKLNbtbFaCnYnoiU1uJvTzPR+z//2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"OWS Variable configuration\"\n        title=\"OWS Variable configuration\"\n        src=\"/static/634c8f77a3d614bc097171cc5af0049b/c739e/action.variable.jpg\"\n        srcset=\"/static/634c8f77a3d614bc097171cc5af0049b/8ee9c/action.variable.jpg 148w,\n/static/634c8f77a3d614bc097171cc5af0049b/ebbe7/action.variable.jpg 295w,\n/static/634c8f77a3d614bc097171cc5af0049b/c739e/action.variable.jpg 590w,\n/static/634c8f77a3d614bc097171cc5af0049b/eaa3b/action.variable.jpg 689w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Since OWS is open source, I was able to search the code and find that the <code class=\"language-text\">FormatQueryVariable</code> implementation inside <a href=\"https://github.com/kevinmschreiner/OpenWebStudio/blob/e4c16a349c33db82e25aa2200353cfff8d01f0cd/Source/Code/r2i.OWS/Engine/Plugins/Renderers/Render.Variable.vb#L1762\">Render.Variable.vb</a> works as expected.</p>\n<div class=\"gatsby-highlight\" data-language=\"vbnet\"><pre class=\"language-vbnet\"><code class=\"language-vbnet\">  <span class=\"token keyword\">If</span> EscapeQuotes <span class=\"token keyword\">Then</span>\n      Value <span class=\"token operator\">=</span> Value.Replace<span class=\"token punctuation\">(</span><span class=\"token string\">\"'\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"''\"</span><span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">If</span> <span class=\"token punctuation\">(</span><span class=\"token function\">Left</span> <span class=\"token keyword\">Is</span> <span class=\"token keyword\">Nothing</span> <span class=\"token keyword\">OrElse</span> <span class=\"token function\">Left</span>.<span class=\"token function\">Length</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">AndAlso</span> <span class=\"token punctuation\">(</span><span class=\"token function\">Right</span> <span class=\"token keyword\">Is</span> <span class=\"token keyword\">Nothing</span> <span class=\"token keyword\">OrElse</span> <span class=\"token function\">Right</span>.<span class=\"token function\">Length</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">Then</span>\n          <span class=\"token comment\">'NO LEFT AND RIGHT ARE PROVIDED, BUT SQL INJECTION IS CHECKED</span>\n          Firewall.Firewall<span class=\"token punctuation\">(</span>Value<span class=\"token punctuation\">,</span> <span class=\"token keyword\">False</span><span class=\"token punctuation\">,</span> Utilities.Firewall.FirewallDirectiveEnum.Any<span class=\"token punctuation\">,</span> <span class=\"token keyword\">False</span><span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">End</span> <span class=\"token keyword\">If</span>\n  <span class=\"token keyword\">End</span> <span class=\"token keyword\">If</span></code></pre></div>\n<p>The configuration from that Variable UI Dialog above is serialized as JSON data into an XML based Microsoft ResX file.</p>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>data</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>Module.Load<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\"><span class=\"token namespace\">xml:</span>space</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>preserve<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>value</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token comment\">&lt;!-- OWS JSON configuration --></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>value</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>data</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>Inside that JSON configuration string is a block for each of the Variable configurations.  The JSON sample below is representative of the UI Dialog above.  Note that <code class=\"language-text\">Protected</code> is set to <code class=\"language-text\">&quot;true&quot;</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\">  <span class=\"token property\">\"ChildActions\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"Index\"</span><span class=\"token operator\">:</span> <span class=\"token number\">66</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"Level\"</span><span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"Parameters\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token property\">\"VariableType\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"&amp;lt;Form&amp;gt;\"</span><span class=\"token punctuation\">,</span>\n          <span class=\"token property\">\"VariableDataType\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Any\"</span><span class=\"token punctuation\">,</span>\n          <span class=\"token property\">\"Formatters\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n          <span class=\"token property\">\"QuerySource\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"frmContent\"</span><span class=\"token punctuation\">,</span>\n          <span class=\"token property\">\"QueryTarget\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"@frmContent\"</span><span class=\"token punctuation\">,</span>\n          <span class=\"token property\">\"QueryTargetLeft\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"'\"</span><span class=\"token punctuation\">,</span>\n          <span class=\"token property\">\"QueryTargetRight\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"'\"</span><span class=\"token punctuation\">,</span>\n          <span class=\"token property\">\"QueryTargetEmpty\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"NULL\"</span><span class=\"token punctuation\">,</span>\n          <span class=\"token property\">\"EscapeListX\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"0\"</span><span class=\"token punctuation\">,</span>\n          <span class=\"token property\">\"Protected\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"true\"</span><span class=\"token punctuation\">,</span>\n          <span class=\"token property\">\"EscapeHTML\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"false\"</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"ActionType\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Template-Variable\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"ChildActions\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span></code></pre></div>\n<p>I had asked the team to write a script to scan all <code class=\"language-text\">.ascx.resx</code> files in the project and verify SQL Protection is being set as expected.  However, when I checked back with them, this was still on the backlog.  I took this as an opportunity to help out and write the code myself.  I usually use python for my utility scripts, but I decided to try out PowerShell for this since it would be more familiar to that .NET based team.</p>\n<p>The first thing I wanted to do was initialize some counters and recursively find all the <code class=\"language-text\">*.ascx.resx</code> files.  Since I kept seeing examples using <code class=\"language-text\">|</code> in my google results, I read up on <a href=\"https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_pipelines?view=powershell-6#how-pipelines-work\">How Pipelines Work</a> in PowerShell, including the <a href=\"https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_foreach?view=powershell-6\"><code class=\"language-text\">ForEach-Object</code></a> function and the <a href=\"https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_automatic_variables?view=powershell-6#_\"><code class=\"language-text\">$_</code></a> automatic variable.</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\"><span class=\"token variable\">$FileCount</span> = 0\n<span class=\"token variable\">$IndexCount</span> = 0\n<span class=\"token variable\">$FilePathLength</span> = <span class=\"token punctuation\">(</span><span class=\"token function\">Get-Location</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>Path<span class=\"token punctuation\">.</span>Length <span class=\"token operator\">+</span> 1\n\n<span class=\"token function\">Get-ChildItem</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">.</span>ascx<span class=\"token punctuation\">.</span>resx <span class=\"token operator\">-</span>Recurse <span class=\"token punctuation\">|</span> <span class=\"token function\">ForEach-Object</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token variable\">$CurrentFile</span> = <span class=\"token variable\">$_</span><span class=\"token punctuation\">.</span>FullName<span class=\"token punctuation\">.</span>substring<span class=\"token punctuation\">(</span><span class=\"token variable\">$FilePathLength</span><span class=\"token punctuation\">)</span>\n  <span class=\"token namespace\">[String[]]</span> <span class=\"token variable\">$FileMessages</span> = @<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  \n  <span class=\"token comment\"># continued below</span></code></pre></div>\n<p>I used <a href=\"https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/select-xml?view=powershell-6\"><code class=\"language-text\">Select-Xml</code></a> with an <code class=\"language-text\">XPath</code> selector of <code class=\"language-text\">//data[@name=&#39;Module.Load&#39;]/value</code>, eventually converting the JSON string value into a <code class=\"language-text\">PSCustomObject</code> using <a href=\"https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/convertfrom-json?view=powershell-6\"><code class=\"language-text\">ConvertFrom-Json</code></a>.  I then iterated over the <code class=\"language-text\">ChildActions</code> and called a <code class=\"language-text\">ScanChildActions</code> function I created to return an array of any violations.</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\">  <span class=\"token variable\">$obj</span> = <span class=\"token function\">Select-Xml</span> <span class=\"token operator\">-</span>Path <span class=\"token variable\">$_</span><span class=\"token punctuation\">.</span>FullName <span class=\"token operator\">-</span>XPath <span class=\"token string\">\"//data[@name='Module.Load']/value\"</span> <span class=\"token punctuation\">|</span>\n  <span class=\"token function\">ForEach-Object</span> <span class=\"token punctuation\">{</span><span class=\"token variable\">$_</span><span class=\"token punctuation\">.</span>node<span class=\"token punctuation\">.</span>InnerXML<span class=\"token punctuation\">}</span> <span class=\"token punctuation\">|</span>\n  <span class=\"token function\">ConvertFrom-Json</span>\n\n  <span class=\"token variable\">$obj</span><span class=\"token punctuation\">.</span>messageItems <span class=\"token punctuation\">|</span> <span class=\"token function\">ForEach-Object</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token variable\">$_</span><span class=\"token punctuation\">.</span>ChildActions <span class=\"token punctuation\">|</span> <span class=\"token function\">ForEach-Object</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token variable\">$FileMessages</span> = ScanChildActions <span class=\"token variable\">$_</span> <span class=\"token variable\">$FileMessages</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n  \n  <span class=\"token comment\"># continued below</span></code></pre></div>\n<p>The <code class=\"language-text\">ChildActions</code> function is a recursive scan that looks for any <code class=\"language-text\">ActionType</code> of <code class=\"language-text\">Template-Variable</code> and inspects the <code class=\"language-text\">Protected</code> parameter.  If <code class=\"language-text\">&quot;false&quot;</code>, it appends an error message with the <code class=\"language-text\">️Index</code> value as the key for finding the offending <code class=\"language-text\">Variable</code> later.</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\"><span class=\"token keyword\">function</span> ScanChildActions<span class=\"token punctuation\">(</span><span class=\"token variable\">$ChildActions</span><span class=\"token punctuation\">,</span> <span class=\"token namespace\">[String[]]</span><span class=\"token variable\">$ErrorMessages</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token variable\">$ChildActions</span> <span class=\"token punctuation\">|</span> <span class=\"token function\">ForEach-Object</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$_</span><span class=\"token punctuation\">.</span>ActionType <span class=\"token operator\">-eq</span> <span class=\"token string\">\"Template-Variable\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$_</span><span class=\"token punctuation\">.</span>Parameters<span class=\"token punctuation\">.</span>Protected <span class=\"token operator\">-eq</span> <span class=\"token string\">\"false\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token variable\">$message</span> = <span class=\"token string\">\"️Index=<span class=\"token function\">$<span class=\"token punctuation\">(</span><span class=\"token variable\">$_</span><span class=\"token punctuation\">.</span>Index<span class=\"token punctuation\">)</span></span>  Protected=false\"</span>\n        <span class=\"token variable\">$ErrorMessages</span> <span class=\"token operator\">+=</span> <span class=\"token variable\">$message</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token variable\">$ErrorMessages</span> = <span class=\"token namespace\">[String[]]</span><span class=\"token punctuation\">(</span>ScanChildActions <span class=\"token variable\">$_</span><span class=\"token punctuation\">.</span>ChildActions <span class=\"token variable\">$ErrorMessages</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token variable\">$ErrorMessages</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>With all the error messages gathered for the file, it was time to output the results and increment <code class=\"language-text\">$FileCount</code> / <code class=\"language-text\">$IndexCount</code> and output either a success (✅) or failure (❌) line for that filename.</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\">  <span class=\"token comment\"># ... continued from above</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$FileMessages</span><span class=\"token punctuation\">.</span>length <span class=\"token operator\">-eq</span> 0<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">Write-Output</span> <span class=\"token string\">\"✅  <span class=\"token function\">$<span class=\"token punctuation\">(</span><span class=\"token variable\">$CurrentFile</span><span class=\"token punctuation\">)</span></span>\"</span>\n\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token variable\">$script</span>:FileCount+<span class=\"token operator\">+</span>\n    <span class=\"token variable\">$script</span>:IndexCount <span class=\"token operator\">+=</span> <span class=\"token variable\">$FileMessages</span><span class=\"token punctuation\">.</span>Length\n\n    <span class=\"token function\">Write-Output</span> <span class=\"token string\">\"❌  <span class=\"token function\">$<span class=\"token punctuation\">(</span><span class=\"token variable\">$CurrentFile</span><span class=\"token punctuation\">)</span></span>\"</span>\n    <span class=\"token variable\">$FileMessages</span> <span class=\"token punctuation\">|</span> <span class=\"token function\">ForEach-Object</span> <span class=\"token punctuation\">{</span> <span class=\"token function\">Write-Output</span> <span class=\"token string\">\"️  ☒ <span class=\"token function\">$<span class=\"token punctuation\">(</span><span class=\"token variable\">$_</span><span class=\"token punctuation\">)</span></span>\"</span> <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Because I intended for this to be run as part of the build, I made sure to return a non-zero exit code so this script could be used to fail either the build or a pre-commit hook or whatever worked for the team’s development flow.</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\"><span class=\"token function\">Write-Output</span> <span class=\"token string\">\"<span class=\"token function\">$<span class=\"token punctuation\">(</span><span class=\"token variable\">$FileCount</span><span class=\"token punctuation\">)</span></span> files had <span class=\"token function\">$<span class=\"token punctuation\">(</span><span class=\"token variable\">$IndexCount</span><span class=\"token punctuation\">)</span></span> instances of Variable SQL Injection\"</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$FileCount</span> <span class=\"token operator\">-gt</span> 0<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">exit</span> <span class=\"token operator\">-</span>1\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">exit</span> 0</code></pre></div>\n<p>I am early in my PowerShell script development journey, so there are likely improvements I could make to this code.  However, since my goal was to improve security through automation, I feel good about the solution.</p>","frontmatter":{"title":"Scanning for OWS SQL Injection Protection","date":"August 12, 2019","tags":["security","codequality","devops","powershell"]}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/2019-08-12-scanning-for-ows-sql-injection-protection","previous":{"fields":{"slug":"/2019-07-07-aws-signature-authorization-using-postman"},"frontmatter":{"tags":["http","aws","security"]}},"next":{"fields":{"slug":"/2019-08-21-using-the-jfrog-artifactory-cli-with-api-keys-or-access-tokens"},"frontmatter":{"tags":["devops","cli","security"]}}}}}