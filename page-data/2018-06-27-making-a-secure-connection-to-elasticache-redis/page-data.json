{"componentChunkName":"component---src-templates-blog-post-js","path":"/2018-06-27-making-a-secure-connection-to-elasticache-redis","webpackCompilationHash":"2ff2dae5022005648504","result":{"data":{"site":{"siteMetadata":{"title":"kevinhakanson.com","author":"Kevin Hakanson"}},"markdownRemark":{"id":"4c086e1d-d039-5859-8a91-daaeb21fbd14","excerpt":"In Redis Security Investigation, I recommended enabling both Encryption in-transit and Redis Auth.  Below is an ElastiCache Redis server I created to test…","html":"<p>In <a href=\"../2018-06-22-redis-security-investigation\">Redis Security Investigation</a>, I recommended enabling both Encryption in-transit and Redis Auth.  Below is an ElastiCache Redis server I created to test against.  Note that instead of port 6379, I specified 6380 (which seems to be the common Redis “SSL” port).</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/0bace684c26c851bf3763ce568a6eeff/a987b/pastedImage_2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 38.4375%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAABIUlEQVQoz11S2bKFIAzz///PXURBR9z35a2XdAbHcx8KTAlpmuKVSpEfRFQqTcYYquua0jQlrTUJISjPc44oiqgoChJFTkorvgNOSsl7HMfUti15jelIaEOZVNQ0DSe7rqNlWTjGcaS+7zmvbfFQxCR1Yc+aiyMcft938joLlDK31SUTArCuKx3HwYD7vjme56Hzusg0tovqF3PZPAIYDyRaV0ykrAK0DUXDMPB+nucbIIAVUDvP80vk7pkQl77vsw84u0pOmXuAHWqcvyBE/othQiwwNssyVjVN048qR7ZtG5MlSfLiy7Jk/9D+2zKqhWHIAEwTD7+qnAoowiSDIOBpwyI3CFjxKqyqir8EvgEU4vF/hY4USuA5ukAx1+635T+1L1h/F8lrCgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Redis Cluster Information\"\n        title=\"Redis Cluster Information\"\n        src=\"/static/0bace684c26c851bf3763ce568a6eeff/b9e4f/pastedImage_2.png\"\n        srcset=\"/static/0bace684c26c851bf3763ce568a6eeff/cf440/pastedImage_2.png 148w,\n/static/0bace684c26c851bf3763ce568a6eeff/d2d38/pastedImage_2.png 295w,\n/static/0bace684c26c851bf3763ce568a6eeff/b9e4f/pastedImage_2.png 590w,\n/static/0bace684c26c851bf3763ce568a6eeff/f9b6a/pastedImage_2.png 885w,\n/static/0bace684c26c851bf3763ce568a6eeff/2d849/pastedImage_2.png 1180w,\n/static/0bace684c26c851bf3763ce568a6eeff/a987b/pastedImage_2.png 1920w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>However, the <code class=\"language-text\">redis-cli</code> doesn’t support encrypted connections so I had to install <code class=\"language-text\">stunnel</code> with help from <a href=\"https://help.compose.com/docs/redis-and-redis-cli#section-using-redis-cli-with-ssltls\">Using redis-cli with SSL/TLS | Compose Help</a> and <a href=\"https://docs.microsoft.com/en-us/azure/redis-cache/cache-how-to-redis-cli-tool\">How to use redis-cli with Azure Redis Cache | Microsoft Docs</a> to create my <code class=\"language-text\">stunnel.conf</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">cat</span> /etc/stunnel/stunnel.conf\npid <span class=\"token operator\">=</span> /run/stunnel-redis.pid\n\n<span class=\"token punctuation\">[</span>redis-cli<span class=\"token punctuation\">]</span>\nclient <span class=\"token operator\">=</span> <span class=\"token function\">yes</span>\naccept <span class=\"token operator\">=</span> <span class=\"token number\">127.0</span>.0.1:6379\nconnect <span class=\"token operator\">=</span> master.a204503-kjh-auth.jbfxlf.use1.cache.amazonaws.com:6380</code></pre></div>\n<p>This allowed me to connect to localhost:6379 which would be an SSL proxy to the remote Redis server.  You can also see the connection is refused without the proper AUTH token.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ redis-cli -h <span class=\"token number\">127.0</span>.0.1 -p <span class=\"token number\">6379</span> <span class=\"token function\">ping</span>\n<span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> NOAUTH Authentication required.\n\n$ redis-cli -h <span class=\"token number\">127.0</span>.0.1 -p <span class=\"token number\">6379</span> -a <span class=\"token punctuation\">[</span>REDACTED<span class=\"token punctuation\">]</span> <span class=\"token function\">ping</span>\nPONG</code></pre></div>\n<p>Note: [REDACTED] isn’t my real AUTH token. See <a href=\"../2018-06-27-selecting-an-elasticache-redis-auth-token\">Selecting an ElastiCache (Redis) AUTH token</a> for recommendations on this topic.</p>\n<p>To show this is the server from the screenshot above, here are some select lines from the <code class=\"language-text\">info</code> command:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ redis-cli -h <span class=\"token number\">127.0</span>.0.1 -p <span class=\"token number\">6379</span> -a <span class=\"token punctuation\">[</span>REDACTED<span class=\"token punctuation\">]</span> info\n<span class=\"token comment\"># Server</span>\nredis_version:4.0.10\nredis_mode:standalone\nos:Amazon ElastiCache\ntcp_port:6380\n\n<span class=\"token comment\"># SSL</span>\nssl_enabled:yes</code></pre></div>\n<p><a href=\"https://help.compose.com/docs/redis-and-python\">Redis and Python | Compose Help</a> provided me with sample Python code I also tested with.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> redis\n\n<span class=\"token comment\"># connection string and initialization</span>\nr <span class=\"token operator\">=</span> redis<span class=\"token punctuation\">.</span>StrictRedis<span class=\"token punctuation\">(</span>\n    host<span class=\"token operator\">=</span><span class=\"token string\">'master.a204503-kjh-auth.jbfxlf.use1.cache.amazonaws.com'</span><span class=\"token punctuation\">,</span>\n    port<span class=\"token operator\">=</span><span class=\"token number\">6380</span><span class=\"token punctuation\">,</span>\n    password<span class=\"token operator\">=</span><span class=\"token string\">'[REDACTED]'</span><span class=\"token punctuation\">,</span>\n    ssl<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">#test the connection</span>\nvalue <span class=\"token operator\">=</span> r<span class=\"token punctuation\">.</span>info<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span></code></pre></div>\n<p>For Java users, Jedis can use the <a href=\"https://www.iana.org/assignments/uri-schemes/prov/rediss\">rediss</a> scheme to connect. Sample code derived from <a href=\"https://github.com/xetorthio/jedis/blob/master/src/test/java/redis/clients/jedis/tests/SSLJedisTest.java\">jedis/SSLJedisTest.java</a>.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">  <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">connectWithUrl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// The \"rediss\" scheme instructs jedis to open a SSL/TLS connection.</span>\n    <span class=\"token class-name\">Jedis</span> jedis <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Jedis</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"rediss://master.a204503-kjh-auth.jbfxlf.use1.cache.amazonaws.com:6380\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    jedis<span class=\"token punctuation\">.</span><span class=\"token function\">auth</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"[REDACTED]\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">assertEquals</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"PONG\"</span><span class=\"token punctuation\">,</span> jedis<span class=\"token punctuation\">.</span><span class=\"token function\">ping</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    jedis<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span></code></pre></div>\n<p>For C# users, set <a href=\"https://stackexchange.github.io/StackExchange.Redis/Configuration.html\">StackExchange.Redis</a> ConfigurationOptions this way:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">var</span> options <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ConfigurationOptions</span>\n<span class=\"token punctuation\">{</span>\n    Endpoint <span class=\"token operator\">=</span> <span class=\"token string\">\"master.a204503-kjh-auth.jbfxlf.use1.cache.amazonaws.com\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token comment\">// Endpoints without an explicit port will use 6379 if ssl is not enabled, and 6380 if ssl is enabled</span>\n    Password <span class=\"token operator\">=</span> <span class=\"token string\">\"[Redacted]\"</span><span class=\"token punctuation\">,</span>\n    Ssl <span class=\"token operator\">=</span> True\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>","frontmatter":{"title":"Making a secure connection to ElastiCache (Redis)","date":"June 27, 2018","tags":["aws","redis","security","networking"]}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/2018-06-27-making-a-secure-connection-to-elasticache-redis","previous":{"fields":{"slug":"/2018-06-27-selecting-an-elasticache-redis-auth-token"},"frontmatter":{"tags":["aws","secretsmanager","redis","security"]}},"next":{"fields":{"slug":"/2018-07-05-first-thoughts-on-aws-cloud9"},"frontmatter":{"tags":["aws","cloud9","python"]}}}}}