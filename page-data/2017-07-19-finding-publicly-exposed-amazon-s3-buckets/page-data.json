{"componentChunkName":"component---src-templates-blog-post-js","path":"/2017-07-19-finding-publicly-exposed-amazon-s3-buckets","result":{"data":{"site":{"siteMetadata":{"title":"kevinhakanson.com","author":"Kevin Hakanson"}},"markdownRemark":{"id":"bff8bf6d-01c3-52e2-96f1-6a8bc80fc12c","excerpt":"You may have read recent news about millions of Verizon customers having their data exposed (see Experts Warn Too Often AWS S3 Buckets Are Misconfigured, Leak…","html":"<p>You may have read recent news about millions of Verizon customers having their data exposed (see <a href=\"https://threatpost.com/experts-warn-too-often-aws-s3-buckets-are-misconfigured-leak-data/126826/\">Experts Warn Too Often AWS S3 Buckets Are Misconfigured, Leak Data</a>).</p>\n<p>Possibly, people are confused about what the <strong>Authenticated Users group</strong> means. From <a href=\"http://docs.aws.amazon.com/AmazonS3/latest/dev/acl-overview.html\">Access Control List (ACL) Overview - Amazon Simple Storage Service</a>:</p>\n<blockquote>\n<p>Represented by <a href=\"http://acs.amazonaws.com/groups/global/AuthenticatedUsers\">http://acs.amazonaws.com/groups/global/AuthenticatedUsers</a>.<br>\nThis group represents all AWS accounts. Access permission to this group allows any AWS account to access the resource. However, all requests must be signed (authenticated).</p>\n</blockquote>\n<p>This doesn’t just mean IAM Users from their account, but <em>any</em> user from <em>any</em> AWS account.</p>\n<p>How do we check this on our accounts?  There are a couple of options.</p>\n<p>Use a <a href=\"http://www.capitalone.io/cloud-custodian/docs/policy/resources/s3.html\">Cloud Custodian S3 filter </a> with a <code class=\"language-text\">policy.yml</code> like:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">policies</span><span class=\"token punctuation\">:</span>\r\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> s3<span class=\"token punctuation\">-</span>global\r\n  <span class=\"token key atrule\">resource</span><span class=\"token punctuation\">:</span> s3\r\n  <span class=\"token key atrule\">description</span><span class=\"token punctuation\">:</span> Publicly Exposed S3 Buckets\r\n  <span class=\"token key atrule\">filters</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> global<span class=\"token punctuation\">-</span>grants</code></pre></div>\n<p>Then run the <a href=\"https://github.com/capitalone/cloud-custodian\">custodian</a> tool and use <a href=\"https://stedolan.github.io/jq/\">jq</a> to filter the output, I find a bucket (names changed to protect the innocent).</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ custodian run --output-dir<span class=\"token operator\">=</span>. policy.yml <span class=\"token parameter variable\">--region</span><span class=\"token operator\">=</span>us-west-2\r\n\r\n$ jq <span class=\"token string\">'.[].Name'</span> s3-global/resources.json\r\n<span class=\"token string\">\"project1-test-bucket1\"</span></code></pre></div>\n<p>Amazon also has a utility called <a href=\"https://aws.amazon.com/premiumsupport/trustedadvisor/\">Trusted Advisor</a> that can report on several items, including <strong>Amazon S3 Bucket Permissions</strong>.  That has both a Console UI and is callable via API or CLI (via <a href=\"http://docs.aws.amazon.com/cli/latest/reference/support/describe-trusted-advisor-check-result.html\">describe-trusted-advisor-check-result</a>):</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ aws support describe-trusted-advisor-check-result <span class=\"token punctuation\">\\</span>\r\n--check-id Pfx0RwqBli <span class=\"token punctuation\">\\</span>\r\n<span class=\"token parameter variable\">--query</span> <span class=\"token string\">'result.flaggedResources[*].metadata[2]'</span>\r\n<span class=\"token punctuation\">[</span>\r\n    <span class=\"token string\">\"project1-portal-ui\"</span>,\r\n    <span class=\"token string\">\"project1-test-bucket1\"</span>,\r\n<span class=\"token punctuation\">]</span></code></pre></div>\n<p>However, that list has 2 items vs. the 1 which Cloud Custodian found using its global-grants filter.  It appears that Cloud Custodian is filtering out buckets set up for website hosting (see <a href=\"https://docs.aws.amazon.com/AmazonS3/latest/dev/WebsiteHosting.html\">Hosting a Static Website on Amazon S3</a>), which seems like a valid result.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 309px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c00af066905dc9e6e25efbdc3e7f3902/532e8/pastedImage_140.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 75%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsTAAALEwEAmpwYAAACP0lEQVQ4y5VS7XKbMBD0u/dZ+gL905+dOk0ckwDGYLDBX9iY2ICRCd8gsR0piRO3STvRzI7uhLTc3m0vJgR5ngukWQZyOiF5fMQpSUScpqn4lmWZwHsx38uyBCEEPf7wo9XhcysMQ/SOhIjk5maAfv8KkiRB08ZYuy5upTv8+HkFRVEwGNzgXhnB0A3oug5ZUTEcDjFSVazdzRvCOBaJZVm4k+4gyzJG4zGcxRL9q1/oX19jKEkYjVTIqobVagVN0zCU7mHbNoaDW9xK94IjeKmwrOuL0hmAlrFPyw7fEvJeciRpCn4WkRgkSRDFsRgMb3pVVcjEAAoxiKLIUVaVOD8T8gd124qejXUdS3eD2WwKczrFYr2GYRgwJxMsVytsvR3M2QzedgPbngvJW8+D/7B/JeTWKKpKkC5WS8iKgpm9wNS2oRs65oslbGcOa2rDcRxBNLUdWJYJVdNBTsmlZO4j1nWi9KwohOS8KFGUJRijoJSibZ9AaStyDi6zrmtQytB13SXhU/e7iwE0tMPYS2H6GTxSQfNSBGnzvl+fCaMoQi9NM3SsO//5BbyitKxRVA3qpkVRtahbCsaYAH3eRUzpa4V5/lQhZfSflug6JiS37d9omuaVMHgI8fXLN4RejIllwJiYkGUFC2cOfWJCVRRh+jwvzvL+BHv2rCBMyCPk7wbKlHvxhCg6IghC4bM4Jjgejzjs90L2/xa/2/N9H8dTBP/Bx+FwQBAEAvv9/pwfDgH4Pc/zsNvtPoTruvgNfQ5xt4y1kO0AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"S3 Static website hosting\"\n        title=\"S3 Static website hosting\"\n        src=\"/static/c00af066905dc9e6e25efbdc3e7f3902/532e8/pastedImage_140.png\"\n        srcset=\"/static/c00af066905dc9e6e25efbdc3e7f3902/12f09/pastedImage_140.png 148w,\n/static/c00af066905dc9e6e25efbdc3e7f3902/e4a3f/pastedImage_140.png 295w,\n/static/c00af066905dc9e6e25efbdc3e7f3902/532e8/pastedImage_140.png 309w\"\n        sizes=\"(max-width: 309px) 100vw, 309px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>","frontmatter":{"title":"Finding Publicly Exposed Amazon S3 Buckets","description":null,"date":"July 19, 2017","tags":["aws","devops","security","s3"],"canonical":null}}},"pageContext":{"slug":"/2017-07-19-finding-publicly-exposed-amazon-s3-buckets","previous":{"fields":{"slug":"/2017-07-06-the-geographical-center-of-the-united-states-and-ip-addresses"},"frontmatter":{"tags":["random","networking"]}},"next":{"fields":{"slug":"/2017-07-20-application-security-testing-sast-dast-and-iast"},"frontmatter":{"tags":["security","codequality"]}}}},"staticQueryHashes":["2589769190","97908498"]}