{"componentChunkName":"component---src-templates-blog-post-js","path":"/2025-03-29-vibe-architecting-an-api-gateway-http-api/","result":{"data":{"site":{"siteMetadata":{"title":"kevinhakanson.com","author":"Kevin Hakanson"}},"markdownRemark":{"id":"715578b9-9e5b-52f0-acbe-f1dd489f2856","excerpt":"“Vibe coding” is the latest hype, so I thought I would give it a try.  I was working with a customer to understand some security boundaries between an API…","html":"<p>“Vibe coding” is the latest hype, so I thought I would give it a try.  I was working with a customer to understand some security boundaries between an API Gateway HTTP API and a ALB target.  Basically I wanted to “vibe architect” the CDK version of the image below:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a645a26c5cb4c75b033b75da1c28dff2/ad164/VPCLink.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 29.72972972972973%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAADLAAAAywAEoZFrbAAABSUlEQVR42jWRy3LTQBBF/c98D0uKH2BNVaisU9gJcQgmkJewpZYlzUOj0Wh0aNnJ4s7t2z19ex4rYGZZ5hNxffOD0FUaTdx9g8etR45HDoeGqmoZhvyGmah41zFq3Oe0ejc8meZMsS8o/1zDYPlyK3y+uaeVkn1dM6REnCZG3bfwMKnOZ53mjO3T2TDGiLUdXTUjT4nn11eKlwLxkafygKi2TYMphb7tkH97grU6NNJ3HZXWS4XpQlrtfv+dt3f3bH+uufgInz5ALTWbzQbX9njnKR50oPFcXV5S1w0vv4I2W0J9pHeW5nnLev2dprZp1Rkzj2Miz4ndlWP91RBCOD2BNYGURpya5SlDvxgZHnaPeO+Zfa/5SestWa9+OqH2LT8gKU0CoyJKmpIsOe8nadsg3kUxyq0ZxClM48UubM95b0dpm16cS/v/63DIOtELwFsAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"HTTP API VPC Link to ALB\"\n        title=\"\"\n        src=\"/static/a645a26c5cb4c75b033b75da1c28dff2/fcda8/VPCLink.png\"\n        srcset=\"/static/a645a26c5cb4c75b033b75da1c28dff2/12f09/VPCLink.png 148w,\n/static/a645a26c5cb4c75b033b75da1c28dff2/e4a3f/VPCLink.png 295w,\n/static/a645a26c5cb4c75b033b75da1c28dff2/fcda8/VPCLink.png 590w,\n/static/a645a26c5cb4c75b033b75da1c28dff2/efc66/VPCLink.png 885w,\n/static/a645a26c5cb4c75b033b75da1c28dff2/c83ae/VPCLink.png 1180w,\n/static/a645a26c5cb4c75b033b75da1c28dff2/ad164/VPCLink.png 3680w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>So I used this prompt with AWS Q Developer inside Visual Studio Code for a CDK project.</p>\n<blockquote>\n<p>create an AWS CDK project with the following components: 1) a API Gateway HTTP API targeting an ALB as the integration. 2) create a lambda custom authorizer for the HTTP API that adds data to the context. 3) have the integration from REST API to ALB add the context as a custom HTTP header. 4) create a new VPC for the ALB, and add a VPC Link to the HTTP API. 5) add another lambda function as the target for the ALB and print out the custom header. 6) recommend any security group logic to only allow HTTP traffic from the API Gateway HTTP API</p>\n</blockquote>\n<p>It deployed, but when I tested using <code class=\"language-text\">curl</code> it didn’t work, but why?  I looked at the code and realized it missed my “step 6” and didn’t create a security group for VPC link.  I vibed coded some more with <code class=\"language-text\">vpcLinkSecurityGroup = new ec2.SecurityGroup(...)</code>, added to ALB with <code class=\"language-text\">albSecurityGroup.addIngressRule(vpcLinkSecurityGroup, ...)</code>, and included <code class=\"language-text\">securityGroups: [vpcLinkSecurityGroup]</code> on the <code class=\"language-text\">apigatewayv2.VpcLink</code>.</p>\n<p>Tried again, and still didn’t work - but where?  I had no idea because there wasn’t enough logging.  I did some more vibe coding to add ALB Access Logging and VPC Flow logging.</p>\n<p>I still was not seeing any logs indication my ALB targeted Lambda function was being called.  But with the ALB and VPC logging, I realized it wasn’t leaving the API Gateway.  I next found a problem with HTTP API access logging which was missing the <code class=\"language-text\">$context.authorizer.error</code> <a href=\"https://docs.aws.amazon.com/apigateway/latest/developerguide/http-api-logging-variables.html\">variable</a> to resolve</p>\n<p>Now I had the clue my <a href=\"https://docs.aws.amazon.com/apigateway/latest/developerguide/http-api-lambda-authorizer.html\">HTTP API Lambda authorizer</a> was generated to return a 2.0 payload format, but the <code class=\"language-text\">HttpLambdaAuthorizer</code> was not configured for <code class=\"language-text\">responseTypes: [apigatewayv2_authorizers.HttpLambdaResponseType.SIMPLE]</code></p>\n<p>At least now my Lambda function was being called, but I still needed to tweak some <code class=\"language-text\">.appendHeader</code> vs <code class=\"language-text\">replaceHeader</code> <a href=\"https://docs.aws.amazon.com/apigateway/latest/developerguide/http-api-parameter-mapping.html\">parameters mappings</a></p>\n<p>I’m asking myself if this was better than doing everything myself.  It was faster to get the CDK project setup and deployed.  However, I still had to understand the stack was missing parts of the architecture, debug from the logs, and understand key details of the implementation like authorizer payload format and api parameters mappings.</p>","frontmatter":{"title":"Vibe Architecting an API Gateway HTTP API","description":null,"date":"March 29, 2025","tags":["aws","http","security"],"canonical":null}}},"pageContext":{"slug":"/2025-03-29-vibe-architecting-an-api-gateway-http-api/","previous":{"fields":{"slug":"/2025-01-18-fun-with-cypress-fixture-files/"},"frontmatter":{"tags":["javascript","codequality","webdev"]}},"next":{"fields":{"slug":"/2025-05-25-redacting-tokens-in-lambda-function-events/"},"frontmatter":{"tags":["javascript","python","security","aws","lambda"]}}}},"staticQueryHashes":["2589769190","97908498"],"slicesMap":{}}