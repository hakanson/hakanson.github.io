{"componentChunkName":"component---src-templates-blog-post-js","path":"/2017-01-15-aws-x-ray-investigation","result":{"data":{"site":{"siteMetadata":{"title":"kevinhakanson.com","author":"Kevin Hakanson"}},"markdownRemark":{"id":"c2654bc9-26f8-5bae-91a6-1dcc97dcec63","excerpt":"In Zipkin JS Investigation and Zipkin JS Investigation (Part 2), I took a simple Express (Node.js) based web application and added zipkin tracing. I updated…","html":"<p>In <a href=\"../2016-06-10-zipkin-js-investigation\">Zipkin JS Investigation</a> and <a href=\"../2016-07-20-zipkin-js-investigation-part-2\">Zipkin JS Investigation (Part 2)</a>, I took a simple <a href=\"http://expressjs.com/\">Express</a> (Node.js) based web application and added <a href=\"http://zipkin.io/\">zipkin</a> tracing. I updated that application with support for <a href=\"https://aws.amazon.com/xray/\">AWS X-Ray</a> (Preview).   The code snippet below was based on instructions found at <a href=\"http://docs.aws.amazon.com/xray-sdk-for-nodejs/latest/reference/\">http://docs.aws.amazon.com/xray-sdk-for-nodejs/latest/reference/</a>.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">var</span> express <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'express'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">var</span> http <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'http'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">var</span> AWSXRay <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'aws-xray-sdk'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">var</span> <span class=\"token constant\">AWS</span> <span class=\"token operator\">=</span> AWSXRay<span class=\"token punctuation\">.</span><span class=\"token function\">captureAWS</span><span class=\"token punctuation\">(</span><span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'aws-sdk'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">var</span> app <span class=\"token operator\">=</span> <span class=\"token function\">express</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'port'</span><span class=\"token punctuation\">,</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">PORT</span> <span class=\"token operator\">||</span> <span class=\"token number\">3000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'servicename'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'helloservice'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nAWSXRay<span class=\"token punctuation\">.</span><span class=\"token function\">config</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>AWSXRay<span class=\"token punctuation\">.</span>plugins<span class=\"token punctuation\">.</span>ElasticBeanstalk<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nAWSXRay<span class=\"token punctuation\">.</span><span class=\"token function\">captureHTTPs</span><span class=\"token punctuation\">(</span>http<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// below not working, need to start with: XRAY_TRACING_NAME=helloservice node index.js</span>\nAWSXRay<span class=\"token punctuation\">.</span><span class=\"token function\">setDefaultName</span><span class=\"token punctuation\">(</span><span class=\"token string\">'helloservice'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>AWSXRay<span class=\"token punctuation\">.</span>express<span class=\"token punctuation\">.</span><span class=\"token function\">openSegment</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n <span class=\"token comment\">// handler code here uses http.request()</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>AWSXRay<span class=\"token punctuation\">.</span>express<span class=\"token punctuation\">.</span><span class=\"token function\">closeSegment</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Looking on the X-Ray Console, here is a screenshot of the result of calling: <code class=\"language-text\">http://dev-env.3tp23hiz9p.us-east-1.elasticbeanstalk.com/?count=3</code>.  I have also included the <a href=\"/97dd5d29efde57b873a6260d0fb6ec77/1-587c35e2-c21cf7e73003b660d10e33ea.json.zip\">raw JSON data</a> for this trace.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/051de3e72ec3003848485fd3f8d71ffa/eff2e/pastedImage_6.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 25.3125%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsSAAALEgHS3X78AAAA8klEQVQY03WQ22rDMAyG8/5vsruN7QnGyi5WdoJSVtbuUBLHdmI5sh3IofnnuN1VN8GHkBGfJGeVriDyPYQQ8N7DWovaGBBZjOMBc0z/8FdksixQihxFFEopoZQCW0JggqMaTBUacyLWv3l+t2TSAjNElMiU0iijiJlhuUETGKt9jdu1wGJTYvFW4mGrsdwdefw45ruNxLeyCN7BOZeuCyEga9v2ZI9TXJQODtyO2GqPz6rFTgfcvApcPQtcPhW4WOa4fhFpqDSMvuvQDwOmaUpks92YOq3NwaPp/dm/UOiisMD9u8aXtFA29owdDuNw1vsDjYB7NuLQBGQAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"X-Ray Trace Timeline\"\n        title=\"X-Ray Trace Timeline\"\n        src=\"/static/051de3e72ec3003848485fd3f8d71ffa/799d3/pastedImage_6.png\"\n        srcset=\"/static/051de3e72ec3003848485fd3f8d71ffa/00d96/pastedImage_6.png 148w,\n/static/051de3e72ec3003848485fd3f8d71ffa/0b23c/pastedImage_6.png 295w,\n/static/051de3e72ec3003848485fd3f8d71ffa/799d3/pastedImage_6.png 590w,\n/static/051de3e72ec3003848485fd3f8d71ffa/2a3d6/pastedImage_6.png 885w,\n/static/051de3e72ec3003848485fd3f8d71ffa/ae92f/pastedImage_6.png 1180w,\n/static/051de3e72ec3003848485fd3f8d71ffa/eff2e/pastedImage_6.png 1920w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Amazon uses the <strong>X-Amzn-Trace-Id</strong> HTTP header with <strong>Root</strong> and <strong>Parent</strong> segments for carrying trace ids (see <a href=\"http://docs.aws.amazon.com/elasticloadbalancing/latest/application/load-balancer-request-tracing.html\">Request Tracing for Your Application Load Balancer</a> for syntax).  For example:</p>\n<blockquote>\n<p>X-Amzn-Trace-Id: Root=1-587c35e2-c21cf7e73003b660d10e33ea; Parent=06b7ad9dfdae682a; Sampled=1</p>\n</blockquote>\n<p>To learn more about AWS X-Ray, you can watch <a href=\"https://www.youtube.com/watch?v=s8tB3YhZd9U\">AWS re:Invent 2016: NEW LAUNCH! Introduction to AWS X-Ray (DEV316) - YouTube</a>.</p>","frontmatter":{"title":"AWS X-Ray Investigation","date":"January 15, 2017","tags":["aws","xray","javascript","monitoring"]}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/2017-01-15-aws-x-ray-investigation","previous":{"fields":{"slug":"/2017-01-13-hacked-by-baiduspider-and-yandexmetrika"},"frontmatter":{"tags":["aws","xray","security","monitoring"]}},"next":{"fields":{"slug":"/2017-01-27-yahoo-maps"},"frontmatter":{"tags":["random"]}}}}}