{"componentChunkName":"component---src-templates-blog-post-js","path":"/2017-10-02-searching-cloudtrail-using-amazon-athena-sql","webpackCompilationHash":"ea9e41e646c8f86c1300","result":{"data":{"site":{"siteMetadata":{"title":"kevinhakanson.com","author":"Kevin Hakanson"}},"markdownRemark":{"id":"96f2ff8f-381f-5d72-af44-af7d1c15f903","excerpt":"I was querying CloudTrail event history for a specific user, , and it only listed two events when I knew there were more. The AWS Console had a message…","html":"<p>I was querying CloudTrail event history for a specific user, <code class=\"language-text\">projectID-AppUser</code>, and it only listed two events when I knew there were more. The AWS Console had a message explaining why:</p>\n<blockquote>\n<p>Your event history contains the create, modify, and delete activities for supported services taken by people, groups, or AWS services in your AWS account. To view a complete log of your CloudTrail events, create a trail and then go to your Amazon S3 bucket or CloudWatch Logs.</p>\n</blockquote>\n<p>How do I find all the events?  I know the exact day and time (if I can convert to UTC), but didn’t want to download 300 .gz files from an S3 bucket and search through them.  Then I remembered Amazon Athena (serverless, interactive query service) and found exactly the blog post that could help me:  <a href=\"https://aws.amazon.com/blogs/big-data/aws-cloudtrail-and-amazon-athena-dive-deep-to-analyze-security-compliance-and-operational-activity/\">Analyze Security, Compliance, and Operational Activity Using AWS CloudTrail and Amazon Athena | AWS Big Data Blog</a>.  I followed the instructions, but because I only cared about a specific day of CloudTrail logs for a specific region, I created a smaller table using that restriction.  The lines from the “create table” SQL I changed were:</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">CREATE</span> EXTERNAL <span class=\"token keyword\">TABLE</span> cloudtrail_logs_useast1_20170928\n\nLOCATION <span class=\"token string\">'s3://123456789012-cloudtrail-acct-logs/localadmin/AWSLogs/123456789012/CloudTrail/us-east-1/2017/09/28/'</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Now, my “User name” of “projectID-AppUser” query would find 15 events (Run time: 6.15 seconds, Data scanned: 28.85MB).</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">select</span> useridentity<span class=\"token punctuation\">.</span>username<span class=\"token punctuation\">,</span> eventid<span class=\"token punctuation\">,</span> eventtime<span class=\"token punctuation\">,</span> eventname \n<span class=\"token keyword\">from</span> sampledb<span class=\"token punctuation\">.</span>cloudtrail_logs_useast1_20170928\n<span class=\"token keyword\">where</span> useridentity<span class=\"token punctuation\">.</span>username <span class=\"token operator\">=</span> <span class=\"token string\">'projectID-AppUser'</span>\n<span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> eventtime<span class=\"token punctuation\">;</span></code></pre></div>\n<p>I could even get the full details on the two <code class=\"language-text\">eventid</code> entries I saw from the AWS Console CloudTrail Event history.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">select</span> <span class=\"token operator\">*</span>\n<span class=\"token keyword\">from</span> sampledb<span class=\"token punctuation\">.</span>cloudtrail_logs_useast1_20170928\n<span class=\"token keyword\">where</span> eventid <span class=\"token operator\">=</span> <span class=\"token string\">'bbc83507-e7a0-4464-8684-51d32757d3c8'</span> \n   <span class=\"token operator\">or</span> eventid <span class=\"token operator\">=</span> <span class=\"token string\">'5a602970-f337-4441-be78-0470e827b28f'</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>If I wanted everything related to <code class=\"language-text\">projectID-AppUser</code>, my query would find 40 events (Run time: 20.94 seconds, Data scanned: 28.87MB)</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">select</span> eventid<span class=\"token punctuation\">,</span> eventtime<span class=\"token punctuation\">,</span> eventname<span class=\"token punctuation\">,</span> requestparameters\n<span class=\"token keyword\">from</span> sampledb<span class=\"token punctuation\">.</span>cloudtrail_logs_useast1_20170928\n<span class=\"token keyword\">where</span> requestparameters <span class=\"token operator\">like</span> <span class=\"token string\">'%projectID-AppUser%'</span>\n<span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> eventtime<span class=\"token punctuation\">;</span></code></pre></div>\n<p>I used the web console for my interactive queries, but <a href=\"http://docs.aws.amazon.com/athena/latest/ug/connect-with-jdbc.html\">Accessing Amazon Athena with JDBC</a> is also possible.</p>\n<p>This seems like we should “turn on” for the whole account — more work to add to the backlog.</p>","frontmatter":{"title":"Searching CloudTrail using Amazon Athena SQL","date":"October 02, 2017","tags":["aws","cloudtrail","athena","sql"]}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/2017-10-02-searching-cloudtrail-using-amazon-athena-sql","previous":{"fields":{"slug":"/2017-09-27-customer-data-encryption-at-rest-options"},"frontmatter":{"tags":["aws","encryption","security"]}},"next":{"fields":{"slug":"/2017-10-04-iam-roles-trust-policy-assume-role-policy"},"frontmatter":{"tags":["aws","iam"]}}}}}