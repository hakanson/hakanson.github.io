{"componentChunkName":"component---src-templates-blog-post-js","path":"/2024-05-03-rds-iam-authentication-and-mysql-error-1045/","result":{"data":{"site":{"siteMetadata":{"title":"kevinhakanson.com","author":"Kevin Hakanson"}},"markdownRemark":{"id":"1dd862bf-07b5-513c-9531-a91ee0d2ceb9","excerpt":"Are you trying to connect to your MySQL DB instance using IAM authentication using the AWS CLI and mysql client and getting this error? ERROR 1045 (2800…","html":"<p>Are you trying to <a href=\"https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/UsingWithRDS.IAMDBAuth.Connecting.AWSCLI.html\">connect to your MySQL DB instance using IAM authentication using the AWS CLI and mysql client</a> and getting this error?</p>\n<blockquote>\n<p>ERROR 1045 (28000): Access denied for user ‘user1’@‘172.31.9.140’ (using password: YES)</p>\n</blockquote>\n<p>Lucky you!  Well not lucky so far, but hopefully lucky now.  I fought with a scenario for longer than I will admit in public, but this post documents my struggle and how I ended up blaming <a href=\"https://aws.amazon.com/cloud9/\">AWS Cloud9</a>.</p>\n<p>✅ Watched <a href=\"https://www.youtube.com/watch?v=y2QsuwZGZ54\">IAM Authentication with Amazon Aurora MySQL</a> to see how everything works.</p>\n<p>✅ <a href=\"https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/UsingWithRDS.IAMDBAuth.IAMPolicy.html\">Created an IAM policy for database access</a> after finding DB instance resource ID using CLI</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">aws rds describe-db-instances --db-instance-identifier database-1-instance-1 <span class=\"token operator\">|</span> jq <span class=\"token parameter variable\">-r</span> <span class=\"token string\">\".DBInstances[].DbiResourceId\"</span>\ndb-XXXXXXXXXXXXXXXXXXXXXXXXXX</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"Version\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2012-10-17\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"Statement\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"Effect\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Allow\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"Action\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token string\">\"rds-db:connect\"</span>\n      <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"Resource\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token string\">\"arn:aws:rds-db:us-east-1:123456789012:dbuser:db-XXXXXXXXXXXXXXXXXXXXXXXXXX/user1\"</span>\n      <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Since I want to follow <a href=\"https://aws.amazon.com/blogs/database/security-best-practices-for-amazon-rds-for-mysql-and-mariadb-instances/\">Security best practices for Amazon RDS for MySQL and MariaDB instances</a>, my database is only accessible from its VPC. I created a Cloud9 instance with the right security groups to access the database host and port.</p>\n<p>✅ Downloaded the <a href=\"https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/UsingWithRDS.SSL.html\">Certificate bundles for all AWS Regions</a> to Cloud9 using <code class=\"language-text\">wget</code></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">wget</span> https://truststore.pki.rds.amazonaws.com/global/global-bundle.pem</code></pre></div>\n<p>✅ Connected to database as <code class=\"language-text\">admin</code> without having my password appear in <code class=\"language-text\">.bash_history</code></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token assign-left variable\">RDSHOST</span><span class=\"token operator\">=</span><span class=\"token string\">\"database-1.cluster-xxxxxxxxxxxx.us-east-1.rds.amazonaws.com\"</span>\nmysql <span class=\"token parameter variable\">--host</span><span class=\"token operator\">=</span><span class=\"token variable\">$RDSHOST</span> <span class=\"token parameter variable\">--port</span><span class=\"token operator\">=</span><span class=\"token number\">3306</span> --ssl-ca<span class=\"token operator\">=</span>global-bundle.pem  <span class=\"token parameter variable\">--user</span><span class=\"token operator\">=</span>admin <span class=\"token parameter variable\">--password</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token builtin class-name\">read</span> -s<span class=\"token punctuation\">;</span><span class=\"token builtin class-name\">echo</span> <span class=\"token environment constant\">$REPLY</span><span class=\"token variable\">)</span></span>\nWelcome to the MariaDB monitor.  Commands end with <span class=\"token punctuation\">;</span> or <span class=\"token punctuation\">\\</span>g.\nYour MySQL connection <span class=\"token function\">id</span> is <span class=\"token number\">8128</span>\nServer version: <span class=\"token number\">8.0</span>.28 Source distribution\n\nCopyright <span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">)</span> <span class=\"token number\">2000</span>, <span class=\"token number\">2018</span>, Oracle, MariaDB Corporation Ab and others.\n\nType <span class=\"token string\">'help;'</span> or <span class=\"token string\">'\\h'</span> <span class=\"token keyword\">for</span> help. Type <span class=\"token string\">'\\c'</span> to <span class=\"token function\">clear</span> the current input statement.\n\nMySQL <span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span>none<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token operator\">></span></code></pre></div>\n<p>✅ Create <code class=\"language-text\">user1</code> in the database using IAM authentication</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">USER</span> user1 IDENTIFIED <span class=\"token keyword\">WITH</span> AWSAuthenticationPlugin <span class=\"token keyword\">as</span> <span class=\"token string\">'RDS'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">ALTER</span> <span class=\"token keyword\">USER</span> <span class=\"token string\">'user1'</span><span class=\"token variable\">@'%'</span> <span class=\"token keyword\">REQUIRE</span> SSL<span class=\"token punctuation\">;</span></code></pre></div>\n<p>✅ Generated token using bash command copied from <a href=\"https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/UsingWithRDS.IAMDBAuth.Connecting.AWSCLI.html\">Connecting to a DB instance</a></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token assign-left variable\">TOKEN</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\"><span class=\"token variable\">$(</span>aws rds generate-db-auth-token <span class=\"token parameter variable\">--hostname</span> $RDSHOST <span class=\"token parameter variable\">--port</span> <span class=\"token number\">3306</span> <span class=\"token parameter variable\">--region</span> us-east-1 <span class=\"token parameter variable\">--username</span> user1 <span class=\"token variable\">)</span></span>\"</span></code></pre></div>\n<p>❌ Failed to connect to database using <code class=\"language-text\">$TOKEN</code></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">mysql <span class=\"token parameter variable\">--host</span><span class=\"token operator\">=</span><span class=\"token variable\">$RDSHOST</span> <span class=\"token parameter variable\">--port</span><span class=\"token operator\">=</span><span class=\"token number\">3306</span> --ssl-ca<span class=\"token operator\">=</span>global-bundle.pem  <span class=\"token parameter variable\">--user</span><span class=\"token operator\">=</span>user1 <span class=\"token parameter variable\">--password</span><span class=\"token operator\">=</span><span class=\"token variable\">$TOKEN</span>\nERROR <span class=\"token number\">1045</span> <span class=\"token punctuation\">(</span><span class=\"token number\">28000</span><span class=\"token punctuation\">)</span>: Access denied <span class=\"token keyword\">for</span> user <span class=\"token string\">'user1'</span>@<span class=\"token string\">'172.31.9.140'</span> <span class=\"token punctuation\">(</span>using password: YES<span class=\"token punctuation\">)</span></code></pre></div>\n<p>✅ Verified from RDS logs that I connected to the database</p>\n<p><code class=\"language-text\">RDS > Databases > database-1 > database-1-instance-1 > error/mysql-error.log</code></p>\n<blockquote>\n<p>2024-05-03T00:00:00.000000Z 5281 [Note] [MY-010926] [Server] Access denied for user ‘user1’@‘172.31.9.140’ (using password: YES) (sql_authentication.cc:1412)</p>\n</blockquote>\n<p>This must be an IAM issue - I even changed the IAM policy to use resource <code class=\"language-text\">arn:aws:rds-db:us-east-1:123456789012:dbuser:*/*</code> and after another <code class=\"language-text\">aws rds generate-db-auth-token</code> there was still access denied.</p>\n<p>✅ Verified <code class=\"language-text\">user1</code> was created correctly</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">MySQL [(none)]> SELECT User, Host, plugin, authentication_string FROM mysql.user WHERE user = \"user1\";\n+-------+------+-------------------------+-----------------------+\n| User  | Host | plugin                  | authentication_string |\n+-------+------+-------------------------+-----------------------+\n| user1 | %    | AWSAuthenticationPlugin | RDS                   |\n+-------+------+-------------------------+-----------------------+\n1 row in set (0.063 sec)</code></pre></div>\n<p>✅ Be confused, but eventually blame <a href=\"https://docs.aws.amazon.com/cloud9/latest/user-guide/security-iam.html#auth-and-access-control-temporary-managed-credentials\">AWS managed temporary credentials</a> and their restrictions on <code class=\"language-text\">iam</code> and <code class=\"language-text\">sts</code> actions.</p>\n<p>I temporarily solved this by running <code class=\"language-text\">aws rds generate-db-auth-token</code> outside of Cloud9, copying that string value, and pasting into my Cloud9 terminal session (e.g. <code class=\"language-text\">TOKEN=\"&lt;pasted token>\"</code>).  After that I was able to connect as expected and have the <a href=\"https://dev.mysql.com/doc/refman/8.0/en/information-functions.html#function_current-user\"><code class=\"language-text\">SELECT CURRENT_USER()</code></a> to prove it.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">MySQL [(none)]> SELECT CURRENT_USER();\n+----------------+\n| CURRENT_USER() |\n+----------------+\n| user1@%        |\n+----------------+\n1 row in set (0.073 sec)</code></pre></div>","frontmatter":{"title":"RDS IAM authentication and MySQL ERROR 1045","description":null,"date":"May 3, 2024","tags":["aws","iam","database","cloud9"],"canonical":null}}},"pageContext":{"slug":"/2024-05-03-rds-iam-authentication-and-mysql-error-1045/","previous":{"fields":{"slug":"/2024-02-12-testing-a-visual-studio-code-extension-inside-github-actions/"},"frontmatter":{"tags":["vscode","github","codequality"]}},"next":{"fields":{"slug":"/2024-10-04-asking-claude-haiku-to-redefine-ab-testing/"},"frontmatter":{"tags":["genai"]}}}},"staticQueryHashes":["2589769190","97908498"],"slicesMap":{}}