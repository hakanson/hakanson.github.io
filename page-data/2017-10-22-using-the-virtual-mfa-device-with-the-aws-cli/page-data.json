{"componentChunkName":"component---src-templates-blog-post-js","path":"/2017-10-22-using-the-virtual-mfa-device-with-the-aws-cli","result":{"data":{"site":{"siteMetadata":{"title":"kevinhakanson.com","author":"Kevin Hakanson"}},"markdownRemark":{"id":"b6b87199-3555-5cff-aa40-6d72966412d6","excerpt":"In Creating and Using an AWS Virtual MFA Device with the AWS SDK for Python, some Python code was used to add a Virtual MFA Device to IAM User  as well as use…","html":"<p>In <a href=\"../2017-10-21-creating-and-using-an-aws-virtual-mfa-device-with-python\">Creating and Using an AWS Virtual MFA Device with the AWS SDK for Python</a>, some Python code was used to add a Virtual MFA Device to IAM User <code class=\"language-text\">kjh-SuperDuperUser</code> as well as use that to call <a href=\"http://boto3.readthedocs.io/en/latest/reference/services/sts.html#STS.Client.assume_role\"><code class=\"language-text\">STS.Client.assume_role</code></a>.  This document uses the AWS CLI to call <a href=\"http://docs.aws.amazon.com/cli/latest/reference/sts/assume-role.html\"><code class=\"language-text\">assume-role</code></a> using the Virtual MFA Device.</p>\n<p>As background, recall that <code class=\"language-text\">kjh-DuperRole</code> has this Trust Policy which requires MFA to be present for <code class=\"language-text\">sts:AssumeRole</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\r\n  <span class=\"token property\">\"Version\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2012-10-17\"</span><span class=\"token punctuation\">,</span>\r\n  <span class=\"token property\">\"Statement\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\r\n    <span class=\"token punctuation\">{</span>\r\n      <span class=\"token property\">\"Effect\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Allow\"</span><span class=\"token punctuation\">,</span>\r\n      <span class=\"token property\">\"Principal\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token property\">\"AWS\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"arn:aws:iam::123456789012:user/service-user/kjh-SuperDuperUser\"</span>\r\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n      <span class=\"token property\">\"Action\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"sts:AssumeRole\"</span><span class=\"token punctuation\">,</span>\r\n      <span class=\"token property\">\"Condition\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token property\">\"Bool\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\r\n          <span class=\"token property\">\"aws:MultiFactorAuthPresent\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"true\"</span>\r\n        <span class=\"token punctuation\">}</span>\r\n      <span class=\"token punctuation\">}</span>\r\n    <span class=\"token punctuation\">}</span>\r\n  <span class=\"token punctuation\">]</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>An attempt to assume role will fail (which is expected):</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ aws <span class=\"token parameter variable\">--profile</span> kjh-SuperDuperUser sts assume-role <span class=\"token punctuation\">\\</span>\r\n--role-arn arn:aws:iam::123456789012:role/kjh-DuperRole <span class=\"token punctuation\">\\</span>\r\n--role-session-name my-cli-session\r\n\r\nAn error occurred <span class=\"token punctuation\">(</span>AccessDenied<span class=\"token punctuation\">)</span> when calling the AssumeRole operation: User: arn:aws:iam::123456789012:user/service-user/kjh-SuperDuperUser is not authorized to perform: sts:AssumeRole on resource: arn:aws:iam::123456789012:role/kjh-DuperRole</code></pre></div>\n<p>However, when the MFA serial number and token code are supplied, there is a success.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ aws <span class=\"token parameter variable\">--profile</span> kjh-SuperDuperUser sts assume-role <span class=\"token punctuation\">\\</span>\r\n--role-arn arn:aws:iam::123456789012:role/kjh-DuperRole <span class=\"token punctuation\">\\</span>\r\n--role-session-name my-cli-session <span class=\"token punctuation\">\\</span>\r\n--serial-number arn:aws:iam::123456789012:mfa/service-user/kjh-SuperDuperUser <span class=\"token punctuation\">\\</span>\r\n--token-code 000000\r\n\r\n<span class=\"token punctuation\">{</span>\r\n\r\n  <span class=\"token string\">\"Credentials\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token string\">\"AccessKeyId\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"ASIAXXXXXXXXXXXXXXXX\"</span>,\r\n    <span class=\"token string\">\"SecretAccessKey\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"[redacted]\"</span>,\r\n    <span class=\"token string\">\"SessionToken\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"[redacted]\"</span>,\r\n    <span class=\"token string\">\"Expiration\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2017-10-21T22:59:21Z\"</span>\r\n  <span class=\"token punctuation\">}</span>,\r\n  <span class=\"token string\">\"AssumedRoleUser\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token string\">\"AssumedRoleId\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"AROAXXXXXXXXXXXXXXXXX:my-cli-session\"</span>,\r\n    <span class=\"token string\">\"Arn\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"arn:aws:sts::123456789012:assumed-role/kjh-DuperRole/my-cli-session\"</span>\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Alternatively, a profile can be created in <code class=\"language-text\">~/.aws/config</code> which specifies both the <code class=\"language-text\">role_arn</code> and <code class=\"language-text\">mfa_serial</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"ini\"><pre class=\"language-ini\"><code class=\"language-ini\"><span class=\"token section\"><span class=\"token punctuation\">[</span><span class=\"token section-name selector\">profile kjh-DuperRole</span><span class=\"token punctuation\">]</span></span>\r\n<span class=\"token key attr-name\">role_arn</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">arn:aws:iam::123456789012:role/kjh-DuperRole</span>\r\n<span class=\"token key attr-name\">source_profile</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">kjh-SuperDuperUser</span>\r\n<span class=\"token key attr-name\">mfa_serial</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">arn:aws:iam::123456789012:mfa/service-user/kjh-SuperDuperUser</span></code></pre></div>\n<p>This causes the AWS CLI to automatically assume-role and prompt for the MFA code (and store the temporary credentials in a file in the <code class=\"language-text\">~/.aws/cache/</code> directory).</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ aws <span class=\"token parameter variable\">--profile</span> kjh-DuperRole sts get-caller-identity\r\nEnter MFA code: 000000\r\n<span class=\"token punctuation\">{</span>\r\n  <span class=\"token string\">\"UserId\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"AROAXXXXXXXXXXXXXXXXX:AWS-CLI-session-1508622621\"</span>,\r\n  <span class=\"token string\">\"Account\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"123456789012\"</span>,\r\n  <span class=\"token string\">\"Arn\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"arn:aws:sts::123456789012:assumed-role/kjh-DuperRole/AWS-CLI-session-1508622621\"</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>","frontmatter":{"title":"Using the Virtual MFA Device with the AWS CLI","description":null,"date":"October 22, 2017","tags":["aws","cli","iam","mfa","security"],"canonical":null}}},"pageContext":{"slug":"/2017-10-22-using-the-virtual-mfa-device-with-the-aws-cli","previous":{"fields":{"slug":"/2017-10-21-hashicorp-vault-supports-aws-sts-assumerole-and-totp"},"frontmatter":{"tags":["aws","iam","mfa","security"]}},"next":{"fields":{"slug":"/2017-10-30-aws-certificate-manager-and-certificate-pinning"},"frontmatter":{"tags":["aws","http","security"]}}}},"staticQueryHashes":["2589769190","97908498"],"slicesMap":{}}