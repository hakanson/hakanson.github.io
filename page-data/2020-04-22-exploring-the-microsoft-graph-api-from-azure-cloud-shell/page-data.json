{"componentChunkName":"component---src-templates-blog-post-js","path":"/2020-04-22-exploring-the-microsoft-graph-api-from-azure-cloud-shell","result":{"data":{"site":{"siteMetadata":{"title":"kevinhakanson.com","author":"Kevin Hakanson"}},"markdownRemark":{"id":"343b680e-5c23-53b8-bc7a-3368fc98390c","excerpt":"When I’m first exploring a new API, it is comfortable to use a GUI based API explorer tool.  For the Microsoft Graph API, this is the Graph Explorer and a tool…","html":"<p>When I’m first exploring a new API, it is comfortable to use a GUI based API explorer tool.  For the Microsoft Graph API, this is the Graph Explorer and a tool I enjoy working with.  Try it out with this direct link which will query <a href=\"https://developer.microsoft.com/en-US/graph/graph-explorer?request=me&#x26;method=GET&#x26;version=v1.0&#x26;GraphUrl=https://graph.microsoft.com&#x26;requestBody=dW5kZWZpbmVk\">https://graph.microsoft.com/v1.0/me/</a> and get a response similar to:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"@odata.context\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"https://graph.microsoft.com/v1.0/$metadata#users/$entity\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"businessPhones\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"displayName\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Kevin Hakanson\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"givenName\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Kevin\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"jobTitle\"</span><span class=\"token operator\">:</span> <span class=\"token null keyword\">null</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"mail\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"kevin.hakanson@example.com\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"mobilePhone\"</span><span class=\"token operator\">:</span> <span class=\"token null keyword\">null</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"officeLocation\"</span><span class=\"token operator\">:</span> <span class=\"token null keyword\">null</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"preferredLanguage\"</span><span class=\"token operator\">:</span> <span class=\"token null keyword\">null</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"surname\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Hakanson\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"userPrincipalName\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"kevin.hakanson@example.com\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"11112222-3333-4444-5555-666677778888\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Other times I want to explore an API using the command line, since it is easier for me to document my research in markdown than using browser screenshots.  I opened up <a href=\"https://shell.azure.com/\">Azure Cloud Shell</a> …\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 73.64864864864865%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAABYlAAAWJQFJUiTwAAADA0lEQVQ4y31Ue0+SYRR/UZEXvHFRvEUqYKggMlC5JJJujk34x0/XF2grp1aaIAq6Zhpqaig6czgTvIRctPwCv3aOY62y/vjtvL/znPvznFdwudzweJ5iYGAALpcLg4OD8Hq9GBoaQl9fHxwOB2w2GzweD+x2O5xOJ9uRPZ2RJL3ZbIbFYoHwzDeMcf8YBx0ZGeFgfr8fY2Nj6O/vZ53b7cbExARGR0cxPj6OYDCIQCDAdsFAAD6fD11dXRxUmHwbwovZGObm5jA7N8+YnJrG7Lt5TM28xstXk5ieeYP58ALCkUWEFiIIhSMswwv3fCGyhKXoMhajMQiLiQyex4tYj28huryC1Q/riG9sYeX9KtbW44gsRbG6to7CzXdkc0Vc54u4LtywzOYK9zxfxFU2xxCOjr7g5PQMxZtb/Li7Y3lze4t8voDsdQ65fAHXuRzSmXOkMxmk0xmcfj3D+cUlrq6+4eLiEmfpNPsUikUIsVgM4XAIh4cHOEmlkEwmGYlEAjs7O0ju72MvkcDu7i62t7ex9WkT8c2P2P28g/3kHvYPEtjY2EAqlcLx8TEEp8vFAx4eHuZLcHs86O7uhslk4hul26Zhe71DsPXZYTQ/Ro+vESanFpaRJtj8zWjUqSDKFKiqqoLQ0tLCDoT29nb09PRAq9XCYDBwYOKtra2QSqWQSCQQBOEXJMLvnFBbWwuFQoHq6mrOIIoig3QlTpLsZDIZ24kyERJB8ncwQmdnJ4xGI1eo1+vR0NCA5uZmbrnEqXLipKfHS/YU/MEqSxWVlZWxLC8v5/ZIUpUVFRUsS2c1NTUPV1ZCb28vgsEAz83hsHN2g0GPjo4OXiuqiNbRarXyPGnNVCoV1Go1lEol6urq2Jc4JRTUqnpYLTbIpHIoazV4YuyCWCmHSqVkA7oQCk4zpLZ1Oh1X2dbWxutGI6FEpOeANVopFA0CVDopNHop5PUC6horUV5RyT8Hcvxvi39C/UiEpl2Epk2GJpP8/lsnhyiv4pYpOxnSjOnZlJ7Ov75/AtU5Mt6/ik5OAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Azure Cloud Shell\"\n        title=\"Azure Cloud Shell\"\n        src=\"/static/93fef210b157719c8e24a229d4c921b2/fcda8/AzureCloudShell.png\"\n        srcset=\"/static/93fef210b157719c8e24a229d4c921b2/12f09/AzureCloudShell.png 148w,\n/static/93fef210b157719c8e24a229d4c921b2/e4a3f/AzureCloudShell.png 295w,\n/static/93fef210b157719c8e24a229d4c921b2/fcda8/AzureCloudShell.png 590w,\n/static/93fef210b157719c8e24a229d4c921b2/2e195/AzureCloudShell.png 782w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>…and gave <code class=\"language-text\">curl</code> a try:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">kevin@Azure:~$ <span class=\"token function\">curl</span> https://graph.microsoft.com/v1.0/me/\n<span class=\"token punctuation\">{</span>\n  <span class=\"token string\">\"error\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"code\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"InvalidAuthenticationToken\"</span>,\n    <span class=\"token string\">\"message\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"Access token is empty.\"</span>,\n    <span class=\"token string\">\"innerError\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token string\">\"request-id\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"613cf582-fd4f-4c28-8504-063e78d5334e\"</span>,\n      <span class=\"token string\">\"date\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2020-05-27T14:01:22\"</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This error makes sense, because without an access token, how would it know who <code class=\"language-text\">/me/</code> was?  Using browser DevTools to look at the outgoing HTTP request from Graph Explorer, I see it includes an <code class=\"language-text\">Authorization</code> header with a <code class=\"language-text\">Bearer</code> token.</p>\n<div class=\"gatsby-highlight\" data-language=\"http\"><pre class=\"language-http\"><code class=\"language-http\"><span class=\"token request-line\"><span class=\"token method property\">GET</span> <span class=\"token request-target url\">/v1.0/me/</span> <span class=\"token http-version property\">HTTP/1.1</span></span>\n<span class=\"token header\"><span class=\"token header-name keyword\">Host</span><span class=\"token punctuation\">:</span> <span class=\"token header-value\">graph.microsoft.com</span></span>\n<span class=\"token header\"><span class=\"token header-name keyword\">SdkVersion</span><span class=\"token punctuation\">:</span> <span class=\"token header-value\">GraphExplorer/4.0, graph-js/2.0.0 (featureUsage=6)</span></span>\n<span class=\"token header\"><span class=\"token header-name keyword\">Authorization</span><span class=\"token punctuation\">:</span> <span class=\"token header-value\">Bearer [redacted]</span></span></code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/37de597778c1205b098d8921d124b9d0/5bd27/GraphAccessToken.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 33.78378378378378%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAABOElEQVQoz42P20rDQBRF82m+ifg3fo0Pih8hXn7A0iuFYhET05aU1CQzaZrL5GLaLJnUFhUfPLDYc/Zszpwxzm/mnF7NOLuecXJpc3HrUm+35EpR11t2u11LXdc0TYMnEszZO28Ln9lSYM49bEdgLXxWQmE8TCX3z5LHlzV305AnO6IoS5RSVFVFURSUZUmptfpgJVOW3npPEBPFGZtEtZrlFUZTZmhoKqhziiQijmOSJGmHRVFEtNm0XqoUr6uIqSOYzH3mIuN3GXGSkqQZeVHy39p98VcZjuPgui6e5xEEAUKIH3o4H9F94BNKgZR7T0p5VKPf7zOZTBiPxwyHQwaDAd1ul16v1/b6fjQatWhPoz2Nzmp0rtPptGpYloVt25im2aI3Pryo8X3/qHrbMAyP2x9y33/xCRhFBsWsoFlFAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Graph API Access Token\"\n        title=\"Graph API Access Token\"\n        src=\"/static/37de597778c1205b098d8921d124b9d0/fcda8/GraphAccessToken.png\"\n        srcset=\"/static/37de597778c1205b098d8921d124b9d0/12f09/GraphAccessToken.png 148w,\n/static/37de597778c1205b098d8921d124b9d0/e4a3f/GraphAccessToken.png 295w,\n/static/37de597778c1205b098d8921d124b9d0/fcda8/GraphAccessToken.png 590w,\n/static/37de597778c1205b098d8921d124b9d0/efc66/GraphAccessToken.png 885w,\n/static/37de597778c1205b098d8921d124b9d0/c83ae/GraphAccessToken.png 1180w,\n/static/37de597778c1205b098d8921d124b9d0/5bd27/GraphAccessToken.png 1432w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>How can I get a token without having to cut/paste from Graph Explorer?  Luckily, one can <a href=\"https://docs.microsoft.com/en-us/azure/cloud-shell/msi-authorization#acquire-access-token-in-cloud-shell\">acquire an access token in Cloud Shell</a> by using the <code class=\"language-text\">$MSI_ENDPOINT</code>. I pipe the output through <a href=\"https://stedolan.github.io/jq/\">jq</a> for formatting and use <a href=\"https://curl.haxx.se/docs/manpage.html#-s\">—silent</a> to not have the progress meter get in the way.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">kevin@Azure:~$ <span class=\"token function\">curl</span> <span class=\"token variable\">$MSI_ENDPOINT</span> <span class=\"token parameter variable\">-d</span> <span class=\"token string\">\"resource\"</span><span class=\"token operator\">=</span><span class=\"token string\">\"https://graph.microsoft.com/\"</span> <span class=\"token parameter variable\">--header</span> <span class=\"token string\">\"metadata: true\"</span> <span class=\"token parameter variable\">--silent</span> <span class=\"token operator\">|</span> jq\n<span class=\"token punctuation\">{</span>\n  <span class=\"token string\">\"access_token\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"[redacted]\"</span>,\n  <span class=\"token string\">\"refresh_token\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"\"</span>,\n  <span class=\"token string\">\"expires_in\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"3851\"</span>,\n  <span class=\"token string\">\"expires_on\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1587590674\"</span>,\n  <span class=\"token string\">\"not_before\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1587586823\"</span>,\n  <span class=\"token string\">\"resource\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"https://graph.microsoft.com/\"</span>,\n  <span class=\"token string\">\"token_type\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"Bearer\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>That worked great for inspection, but now to save it in the <code class=\"language-text\">$GRAPH_JWT</code> environment variable for later use.  I’ll also generate a link to the <a href=\"https://jwt.ms/\">jwt.ms</a> website to decode the token and inspect the claims.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">kevin@Azure:~$ <span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">GRAPH_JWT</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">`</span><span class=\"token function\">curl</span> $MSI_ENDPOINT <span class=\"token parameter variable\">--data</span> <span class=\"token string\">\"resource=https://graph.microsoft.com/\"</span> <span class=\"token parameter variable\">--header</span> <span class=\"token string\">\"metadata: true\"</span> <span class=\"token parameter variable\">--silent</span> <span class=\"token operator\">|</span> jq .access_token <span class=\"token parameter variable\">-r</span><span class=\"token variable\">`</span></span>\n\nkevin@Azure:~$ <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"https://jwt.ms/?#access_token=<span class=\"token variable\">$GRAPH_JWT</span>\"</span></code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/965a82dc97fdc970f6fe338fb5254295/6297e/CloudShellOpenLink.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 45.94594594594595%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAABs0lEQVQoz42QS48SURCFL8QFf4dXQgIhQMv7DeG5IDSGmJ7h4ZIV0A109yigYYEk/CdXM466HaBh/BHHVBkmxo0uvpy656ZO3briy/cD7h9+4P7hEV8fv+HpeMLT4YTD0cLxdMbROrMeThZO1gXn5584X35jXZ5f6iti/n6CT5/vsFx/wHr9EavVCsvlEpvNBrvdDtvtlnW/37M3n8+h6zpjmCYMw4CuGy+eqDUqUHpvodwoGAwGzHA4ZO33++j1elAUhb1Op4NAIIDXkoRoNApJkhCJRBAKheDz+eD3+yGowTRNaJqG6XSK8XiMyWTCUE3ebDZjRqMRarUaGo0G6vU68vk8crkcQ3WpVIK4vbmFps6gqRpUVeUgCqfVSBeLBes1sFgscnM8HkcqlWKSySQKhQIj6q0SlHcy5DdtNJtNBINBuFwueDwexu12w+l0snq9Xg7LZrMc8mcg+YlEAsL+SoAQNgEh/k21WuW1M5kMQ4EUVKlU+D/F3w02mw12u531Cp3pzuFwIJ1O8x/S6lTHYjGmXC4jHA5DUMP/vOwaSK/rdrtotVpot9uQZZkHEDTgF8hvePqFfmqAAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Go to &quot;https://jwt.ms/?#access_token=...&quot;\"\n        title=\"Go to &quot;https://jwt.ms/?#access_token=...&quot;\"\n        src=\"/static/965a82dc97fdc970f6fe338fb5254295/fcda8/CloudShellOpenLink.png\"\n        srcset=\"/static/965a82dc97fdc970f6fe338fb5254295/12f09/CloudShellOpenLink.png 148w,\n/static/965a82dc97fdc970f6fe338fb5254295/e4a3f/CloudShellOpenLink.png 295w,\n/static/965a82dc97fdc970f6fe338fb5254295/fcda8/CloudShellOpenLink.png 590w,\n/static/965a82dc97fdc970f6fe338fb5254295/efc66/CloudShellOpenLink.png 885w,\n/static/965a82dc97fdc970f6fe338fb5254295/c83ae/CloudShellOpenLink.png 1180w,\n/static/965a82dc97fdc970f6fe338fb5254295/6297e/CloudShellOpenLink.png 2044w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Since I am submitting the request to <code class=\"language-text\">/me/</code>, you would expect the data values to match.  However, the JWT claims of “name”, “oid”, and “upn” don’t exact the keys of “displayName”, “id”, and “userPrincipalName from the Graph API JSON.  Here is a subset of the JWT claims:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\">  <span class=\"token property\">\"aud\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"https://graph.microsoft.com/\"</span><span class=\"token punctuation\">,</span>\n\n  <span class=\"token property\">\"app_displayname\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"AzurePortal Console App\"</span><span class=\"token punctuation\">,</span>\n\n  <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Kevin Hakanson\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"oid\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"11112222-3333-4444-5555-666677778888\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"upn\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"kevin.hakanson@example.com\"</span><span class=\"token punctuation\">,</span></code></pre></div>\n<p>Let’s run that <code class=\"language-text\">curl</code> request using the <code class=\"language-text\">$GRAPH_JWT</code> as the Bearer token in our Authorization header:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">kevin@Azure:~$ <span class=\"token function\">curl</span> https://graph.microsoft.com/v1.0/me/ <span class=\"token parameter variable\">--header</span> <span class=\"token string\">\"Authorization: Bearer <span class=\"token variable\">$GRAPH_JWT</span>\"</span> <span class=\"token parameter variable\">--silent</span> <span class=\"token operator\">|</span> jq\n<span class=\"token punctuation\">{</span>\n  <span class=\"token string\">\"@odata.context\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"https://graph.microsoft.com/v1.0/<span class=\"token variable\">$metadata</span>#users/<span class=\"token variable\">$entity</span>\"</span>,\n  <span class=\"token string\">\"businessPhones\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>,\n  <span class=\"token string\">\"displayName\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"Kevin Hakanson\"</span>,\n  <span class=\"token string\">\"givenName\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"Kevin\"</span>,\n  <span class=\"token string\">\"jobTitle\"</span><span class=\"token builtin class-name\">:</span> null,\n  <span class=\"token string\">\"mail\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"kevin.hakanson@example.com\"</span>,\n  <span class=\"token string\">\"mobilePhone\"</span><span class=\"token builtin class-name\">:</span> null,\n  <span class=\"token string\">\"officeLocation\"</span><span class=\"token builtin class-name\">:</span> null,\n  <span class=\"token string\">\"preferredLanguage\"</span><span class=\"token builtin class-name\">:</span> null,\n  <span class=\"token string\">\"surname\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"Hakanson\"</span>,\n  <span class=\"token string\">\"userPrincipalName\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"kevin.hakanson@example.com\"</span>,\n  <span class=\"token string\">\"id\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"11112222-3333-4444-5555-666677778888\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>There’s a lot of <code class=\"language-text\">null</code> value fields in that response I want to ignore, so let’s add an OData <code class=\"language-text\">$select</code> to the URL.  In the examples above that included <code class=\"language-text\">$MSI_ENDPOINT</code> or <code class=\"language-text\">$GRAPH_JWT</code>, the <code class=\"language-text\">$</code> indicated an environment variable, but the <code class=\"language-text\">$select</code> below is a literal string so we need to escape the <code class=\"language-text\">$</code> as <code class=\"language-text\">\\$</code> for it to work correctly.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">kevin@Azure:~$ <span class=\"token function\">curl</span> <span class=\"token string\">\"https://graph.microsoft.com/v1.0/me/?\\<span class=\"token variable\">$select</span>=id,userPrincipalName,displayName\"</span> <span class=\"token parameter variable\">--header</span> <span class=\"token string\">\"Authorization: Bearer <span class=\"token variable\">$GRAPH_JWT</span>\"</span> <span class=\"token parameter variable\">--silent</span> <span class=\"token operator\">|</span> jq\n<span class=\"token punctuation\">{</span>\n  <span class=\"token string\">\"@odata.context\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"https://graph.microsoft.com/v1.0/<span class=\"token variable\">$metadata</span>#users(id,userPrincipalName,displayName)/<span class=\"token variable\">$entity</span>\"</span>,\n  <span class=\"token string\">\"id\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"11112222-3333-4444-5555-666677778888\"</span>,\n  <span class=\"token string\">\"userPrincipalName\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"kevin.hakanson@example.com\"</span>,\n  <span class=\"token string\">\"displayName\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"Kevin Hakanson\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The Azure CLI includes an <a href=\"https://docs.microsoft.com/en-us/cli/azure/reference-index?view=azure-cli-latest#az-rest\">az rest</a> command that invokes a request and automatically authenticates using the logged in credentials.  Therefore, there is no need to pass the <code class=\"language-text\">$GRAPH_JWT</code> ourselves.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">kevin@Azure:~$ az rest <span class=\"token parameter variable\">--url</span> <span class=\"token string\">\"https://graph.microsoft.com/v1.0/me/?\\<span class=\"token variable\">$select</span>=id,userPrincipalName,displayName\"</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token string\">\"@odata.context\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"https://graph.microsoft.com/v1.0/<span class=\"token variable\">$metadata</span>#users(id,userPrincipalName,displayName)/<span class=\"token variable\">$entity</span>\"</span>,\n  <span class=\"token string\">\"displayName\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"Kevin Hakanson\"</span>,\n  <span class=\"token string\">\"id\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"11112222-3333-4444-5555-666677778888\"</span>,\n  <span class=\"token string\">\"userPrincipalName\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"kevin.hakanson@example.com\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The result is the same, but the JSON fields are in a different order.  Let’s redirect the output to a file and compare.  It looks like <code class=\"language-text\">az rest</code> is not preserving the original order and sorting them instead.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">kevin@Azure:~$ az rest <span class=\"token parameter variable\">--url</span> <span class=\"token string\">\"https://graph.microsoft.com/v1.0/me/?\\<span class=\"token variable\">$select</span>=id,userPrincipalName,displayName\"</span> --output-file me.json\n\nkevin@Azure:~$ <span class=\"token function\">cat</span> me.json <span class=\"token operator\">|</span> jq\n<span class=\"token punctuation\">{</span>\n  <span class=\"token string\">\"@odata.context\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"https://graph.microsoft.com/v1.0/<span class=\"token variable\">$metadata</span>#users(id,userPrincipalName,displayName)/<span class=\"token variable\">$entity</span>\"</span>,\n  <span class=\"token string\">\"id\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"11112222-3333-4444-5555-666677778888\"</span>,\n  <span class=\"token string\">\"userPrincipalName\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"kevin.hakanson@example.com\"</span>,\n  <span class=\"token string\">\"displayName\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"Kevin Hakanson\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Note: Each of these Graph API URLs return the same JSON response:</p>\n<ul>\n<li><a href=\"https://graph.microsoft.com/v1.0/me/\">https://graph.microsoft.com/v1.0/me/</a></li>\n<li><a href=\"https://graph.microsoft.com/v1.0/users/11112222-3333-4444-5555-666677778888\">https://graph.microsoft.com/v1.0/users/11112222-3333-4444-5555-666677778888</a></li>\n<li><a href=\"https://graph.microsoft.com/v1.0/users(&#x27;11112222-3333-4444-5555-666677778888\">https://graph.microsoft.com/v1.0/users(‘11112222-3333-4444-5555-666677778888</a>‘)</li>\n</ul>\n<p>The same user data can be fetched using <code class=\"language-text\">/directoryObjects</code> but this response includes an <code class=\"language-text\">@odata.type</code> field with the <code class=\"language-text\">#microsoft.graph.user</code> value.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">kevin@Azure:~$ az rest <span class=\"token parameter variable\">--url</span> <span class=\"token string\">\"https://graph.microsoft.com/v1.0/directoryObjects/11112222-3333-4444-5555-666677778888?\\<span class=\"token variable\">$select</span>=id,userPrincipalName,displayName\"</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token string\">\"@odata.context\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"https://graph.microsoft.com/v1.0/<span class=\"token variable\">$metadata</span>#directoryObjects(id,userPrincipalName,displayName)/<span class=\"token variable\">$entity</span>\"</span>,\n  <span class=\"token string\">\"@odata.type\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"#microsoft.graph.user\"</span>,\n  <span class=\"token string\">\"displayName\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"Kevin Hakanson\"</span>,\n  <span class=\"token string\">\"id\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"11112222-3333-4444-5555-666677778888\"</span>,\n  <span class=\"token string\">\"userPrincipalName\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"kevin.hakanson@example.com\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Yet another way to get this data is calling <code class=\"language-text\">/users</code> with using a <code class=\"language-text\">$filter</code> of my <code class=\"language-text\">id</code>, but that response is a <code class=\"language-text\">value[]</code> of users.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">kevin@Azure:~$ az rest <span class=\"token parameter variable\">--url</span> <span class=\"token string\">\"https://graph.microsoft.com/v1.0/users?\\<span class=\"token variable\">$filter</span>=id eq '11112222-3333-4444-5555-666677778888'&amp;\\<span class=\"token variable\">$select</span>=id,userPrincipalName,displayName\"</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token string\">\"@odata.context\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"https://graph.microsoft.com/v1.0/<span class=\"token variable\">$metadata</span>#users(id,userPrincipalName,displayName)\"</span>,\n  <span class=\"token string\">\"value\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token string\">\"displayName\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"Kevin Hakanson\"</span>,\n      <span class=\"token string\">\"id\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"11112222-3333-4444-5555-666677778888\"</span>,\n      <span class=\"token string\">\"userPrincipalName\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"kevin.hakanson@example.com\"</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>I bet you are sick of <code class=\"language-text\">/me/</code> by now - I know I just want to <code class=\"language-text\">curl</code> up and <code class=\"language-text\">rest</code> after all this exploration.</p>","frontmatter":{"title":"Exploring the Microsoft Graph API from Azure Cloud Shell","description":null,"date":"April 22, 2020","tags":["azure","cli","odata","cloudshell"],"canonical":null}}},"pageContext":{"slug":"/2020-04-22-exploring-the-microsoft-graph-api-from-azure-cloud-shell","previous":{"fields":{"slug":"/2020-04-18-will-the-real-azure-please-stand-up"},"frontmatter":{"tags":["azure","random"]}},"next":{"fields":{"slug":"/2020-05-20-connecting-to-azure-cache-for-redis-from-redisinsight"},"frontmatter":{"tags":["azure","redis","security","networking"]}}}},"staticQueryHashes":["2589769190","97908498"]}