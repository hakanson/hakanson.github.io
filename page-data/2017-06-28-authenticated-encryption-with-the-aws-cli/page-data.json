{"componentChunkName":"component---src-templates-blog-post-js","path":"/2017-06-28-authenticated-encryption-with-the-aws-cli/","result":{"data":{"site":{"siteMetadata":{"title":"kevinhakanson.com","author":"Kevin Hakanson"}},"markdownRemark":{"id":"7b07686a-c15e-5466-aadc-b1b10088b371","excerpt":"I wanted to understand Authenticated Encryption better as a follow up to my research on Encrypted Properties and AWS IAM Roles.  I decide to try and learn…","html":"<p>I wanted to understand <a href=\"http://docs.aws.amazon.com/kms/latest/developerguide/crypto_authen.html\">Authenticated Encryption</a> better as a follow up to my research on <a href=\"../2017-06-26-encrypted-properties-and-aws-iam-roles\">Encrypted Properties and AWS IAM Roles</a>.  I decide to try and learn interactively, so I saved some “sensitive” data into a file.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token builtin class-name\">echo</span> <span class=\"token parameter variable\">-n</span> <span class=\"token string\">\"P@ssword1\"</span> <span class=\"token operator\">></span> pw1.txt</code></pre></div>\n<p>Then using <a href=\"http://docs.aws.amazon.com/cli/latest/reference/kms/encrypt.html\">aws kms encrypt</a> from the AWS CLI, I tried to encrypt one of the values.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ aws kms encrypt <span class=\"token punctuation\">\\</span>\r\n--key-id arn:aws:kms:us-west-2:123456789012:key/79cce4f6-7e4d-42ab-9942-9e6bb05b6121 <span class=\"token punctuation\">\\</span>\r\n<span class=\"token parameter variable\">--plaintext</span> fileb://pw1.txt\r\n\r\nAn error occurred <span class=\"token punctuation\">(</span>NotFoundException<span class=\"token punctuation\">)</span> when calling the Encrypt operation: Invalid arn</code></pre></div>\n<p>Hmm, that didn’t work despite using the full ARN (which includes the region). I need to set the AWS region explicitly and <code class=\"language-text\">--region</code> is one of the general options for the AWS CLI (see <a href=\"http://docs.aws.amazon.com/cli/latest/topic/config-vars.html?highlight=region\">AWS CLI Configuration Variables</a>).  If you didn’t know about the region restriction, that error message wouldn’t be very helpful.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ aws kms encrypt <span class=\"token punctuation\">\\</span>\r\n<span class=\"token parameter variable\">--region</span> us-west-2 <span class=\"token punctuation\">\\</span>\r\n--key-id 79cce4f6-7e4d-42ab-9942-9e6bb05b6121 <span class=\"token punctuation\">\\</span>\r\n<span class=\"token parameter variable\">--plaintext</span> fileb://pw1.txt\r\n\r\n<span class=\"token punctuation\">{</span>\r\n    <span class=\"token string\">\"CiphertextBlob\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"AQECAHizfom2LowDtrU53mpnuTkvNGUC8c+nPE8dtp40x+QLMAAAAGcwZQYJKoZIhvcNAQcGoFgwVgIBADBRBgkqhkiG9w0BBwEwHgYJYIZIAWUDBAEuMBEEDEubUtCeZ5dJiDjQ4QIBEIAkhYDNKHuwbu5FSxP1sknpWa5K0lOVnXBLIXg6K+ekvSyrOW+M\"</span>,\r\n    <span class=\"token string\">\"KeyId\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"arn:aws:kms:us-west-2:123456789012:key/79cce4f6-7e4d-42ab-9942-9e6bb05b6121\"</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>If I encrypt it again, the <code class=\"language-text\">CiphertextBlob</code> value is different (but starts with many of the same characters).</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ aws kms encrypt <span class=\"token punctuation\">\\</span>\r\n<span class=\"token parameter variable\">--region</span> us-west-2 <span class=\"token punctuation\">\\</span>\r\n--key-id 79cce4f6-7e4d-42ab-9942-9e6bb05b6121 <span class=\"token punctuation\">\\</span>\r\n<span class=\"token parameter variable\">--plaintext</span> fileb://pw1.txt\r\n\r\n<span class=\"token punctuation\">{</span>\r\n    <span class=\"token string\">\"CiphertextBlob\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"AQECAHizfom2LowDtrU53mpnuTkvNGUC8c+nPE8dtp40x+QLMAAAAGcwZQYJKoZIhvcNAQcGoFgwVgIBADBRBgkqhkiG9w0BBwEwHgYJYIZIAWUDBAEuMBEEDJyjJV/HtiuS0S8pFAIBEIAkMe2atLnrx1L2/TtuGx4hS+9bN/76AgaEkK5lvUbiCA+xhC+Y\"</span>,\r\n    <span class=\"token string\">\"KeyId\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"arn:aws:kms:us-west-2:123456789012:key/79cce4f6-7e4d-42ab-9942-9e6bb05b6121\"</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>I went back to the original example from the AWS CLI documentation, and saved the binary, encrypted data to a file:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ aws kms encrypt <span class=\"token punctuation\">\\</span>\r\n<span class=\"token parameter variable\">--region</span> us-west-2 <span class=\"token punctuation\">\\</span>\r\n--key-id 79cce4f6-7e4d-42ab-9942-9e6bb05b6121 <span class=\"token punctuation\">\\</span>\r\n<span class=\"token parameter variable\">--plaintext</span> fileb://pw1.txt <span class=\"token punctuation\">\\</span>\r\n<span class=\"token parameter variable\">--output</span> text <span class=\"token punctuation\">\\</span>\r\n<span class=\"token parameter variable\">--query</span> CiphertextBlob <span class=\"token punctuation\">\\</span>\r\n<span class=\"token operator\">|</span> base64 <span class=\"token parameter variable\">--decode</span> <span class=\"token operator\">></span> ExampleEncryptedFile</code></pre></div>\n<p>Then it was time to decrypt and verify I could get my original data back.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ aws kms decrypt <span class=\"token punctuation\">\\</span>\r\n--ciphertext-blob fileb://ExampleEncryptedFile <span class=\"token punctuation\">\\</span>\r\n<span class=\"token parameter variable\">--output</span> text <span class=\"token punctuation\">\\</span>\r\n<span class=\"token parameter variable\">--query</span> Plaintext\r\n\r\nAn error occurred <span class=\"token punctuation\">(</span>AccessDeniedException<span class=\"token punctuation\">)</span> when calling the Decrypt operation: The ciphertext refers to a customer master key that does not exist, does not exist <span class=\"token keyword\">in</span> this region, or you are not allowed to access.</code></pre></div>\n<p>Notice I didn’t need to provide the KMS key id. However, I have the same region problem - but this time, I had an error message that gives me a hint.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ aws kms decrypt <span class=\"token punctuation\">\\</span>\r\n<span class=\"token parameter variable\">--region</span> us-west-2 <span class=\"token punctuation\">\\</span>\r\n--ciphertext-blob fileb://ExampleEncryptedFile <span class=\"token punctuation\">\\</span>\r\n<span class=\"token parameter variable\">--output</span> text <span class=\"token punctuation\">\\</span>\r\n<span class=\"token parameter variable\">--query</span> Plaintext\r\n\r\nUEBzc3dvcmQx</code></pre></div>\n<p>That worked but didn’t look like my password.  I needed to base64 decode the value.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ aws kms decrypt <span class=\"token punctuation\">\\</span>\r\n<span class=\"token parameter variable\">--region</span> us-west-2 <span class=\"token punctuation\">\\</span>\r\n--ciphertext-blob fileb://ExampleEncryptedFile <span class=\"token punctuation\">\\</span>\r\n<span class=\"token parameter variable\">--output</span> text <span class=\"token punctuation\">\\</span>\r\n<span class=\"token parameter variable\">--query</span> Plaintext <span class=\"token punctuation\">\\</span>\r\n<span class=\"token operator\">|</span> base64 <span class=\"token parameter variable\">--decode</span>\r\n\r\nP@ssword1</code></pre></div>\n<p>Back to Authenticated Encryption, where I need to provide a name-value pair that specifies the encryption context using the <code class=\"language-text\">--encryption-context</code> parameter.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ aws kms encrypt <span class=\"token punctuation\">\\</span>\r\n<span class=\"token parameter variable\">--region</span> us-west-2 <span class=\"token punctuation\">\\</span>\r\n--key-id 79cce4f6-7e4d-42ab-9942-9e6bb05b6121 <span class=\"token punctuation\">\\</span>\r\n--encryption-context <span class=\"token assign-left variable\">database_username</span><span class=\"token operator\">=</span>service1 <span class=\"token punctuation\">\\</span>\r\n<span class=\"token parameter variable\">--plaintext</span> fileb://pw1.txt <span class=\"token punctuation\">\\</span>\r\n<span class=\"token parameter variable\">--output</span> text <span class=\"token punctuation\">\\</span>\r\n<span class=\"token parameter variable\">--query</span> CiphertextBlob <span class=\"token punctuation\">\\</span>\r\n<span class=\"token operator\">|</span> base64 <span class=\"token parameter variable\">--decode</span> <span class=\"token operator\">></span> ExampleAuthenticatedEncryptedFile</code></pre></div>\n<p>And for the decrypt, I need to provide the same <code class=\"language-text\">--encryption-context</code> parameter.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ aws kms decrypt <span class=\"token punctuation\">\\</span>\r\n<span class=\"token parameter variable\">--region</span> us-west-2 <span class=\"token punctuation\">\\</span>\r\n--encryption-context <span class=\"token assign-left variable\">database_username</span><span class=\"token operator\">=</span>service1 <span class=\"token punctuation\">\\</span>\r\n--ciphertext-blob fileb://ExampleAuthenticatedEncryptedFile <span class=\"token punctuation\">\\</span>\r\n<span class=\"token parameter variable\">--output</span> text <span class=\"token punctuation\">\\</span>\r\n<span class=\"token parameter variable\">--query</span> Plaintext <span class=\"token punctuation\">\\</span>\r\n<span class=\"token operator\">|</span> base64 <span class=\"token parameter variable\">--decode</span>\r\n\r\nP@ssword1</code></pre></div>\n<p>With an incorrect context, I get an <code class=\"language-text\">InvalidCiphertextException</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ aws kms decrypt <span class=\"token punctuation\">\\</span>\r\n<span class=\"token parameter variable\">--region</span> us-west-2 <span class=\"token punctuation\">\\</span>\r\n--encryption-context <span class=\"token assign-left variable\">database_username</span><span class=\"token operator\">=</span>service2 <span class=\"token punctuation\">\\</span>\r\n--ciphertext-blob fileb://ExampleAuthenticatedEncryptedFile <span class=\"token punctuation\">\\</span>\r\n<span class=\"token parameter variable\">--output</span> text <span class=\"token punctuation\">\\</span>\r\n<span class=\"token parameter variable\">--query</span> Plaintext <span class=\"token punctuation\">\\</span>\r\n<span class=\"token operator\">|</span> base64 <span class=\"token parameter variable\">--decode</span>\r\n\r\nAn error occurred <span class=\"token punctuation\">(</span>InvalidCiphertextException<span class=\"token punctuation\">)</span> when calling the Decrypt operation:</code></pre></div>","frontmatter":{"title":"Authenticated Encryption with the AWS CLI","description":null,"date":"June 28, 2017","tags":["aws","cli","encryption"],"canonical":null}}},"pageContext":{"slug":"/2017-06-28-authenticated-encryption-with-the-aws-cli/","previous":{"fields":{"slug":"/2017-06-26-encrypted-properties-and-aws-iam-roles/"},"frontmatter":{"tags":["aws","iam","encryption","database","security"]}},"next":{"fields":{"slug":"/2017-07-05-capital-one-cloud-custodian-test-drive/"},"frontmatter":{"tags":["aws","python","devops","security"]}}}},"staticQueryHashes":["2589769190","97908498"],"slicesMap":{}}