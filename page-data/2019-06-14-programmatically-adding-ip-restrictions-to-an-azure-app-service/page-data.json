{"componentChunkName":"component---src-templates-blog-post-js","path":"/2019-06-14-programmatically-adding-ip-restrictions-to-an-azure-app-service","result":{"data":{"site":{"siteMetadata":{"title":"kevinhakanson.com","author":"Kevin Hakanson"}},"markdownRemark":{"id":"92805a2b-98f3-50df-b10d-2e06494f4f1d","excerpt":"For a proof-of-concept I was working on, I needed to add an IP access restriction to an Azure App Service instance.  This can easily be done in the Portal UI…","html":"<p>For a proof-of-concept I was working on, I needed to add an IP access restriction to an Azure App Service instance.  This can easily be done in the Portal UI, but not via PowerShell according to <a href=\"https://docs.microsoft.com/en-us/azure/app-service/app-service-ip-restrictions#programmatic-manipulation-of-access-restriction-rules\">Programmatic manipulation of access restriction rules</a>.</p>\n<blockquote>\n<p>There currently is no CLI or PowerShell for the new Access Restrictions capability but the values can be set manually with an Azure REST API PUT operation on the app configuration in Resource Manager.</p>\n</blockquote>\n<p>I decide to open up <a href=\"https://shell.azure.com/\">Azure Cloud Shell</a> and try to call that REST API using PowerShell.  This was going to be a learning experience as I am new to PowerShell (so please view the code below with empathy).</p>\n<p><a href=\"https://docs.microsoft.com/en-us/powershell/module/az.websites/get-azwebapp?view=azps-3.1.0\">Get-AzWebApp</a> gets information about an Azure App Service (a.k.a. Web App).  I need the <code class=\"language-text\">id</code> property later.</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\"><span class=\"token variable\">$Subscription</span> = <span class=\"token string\">\"[redacted]\"</span>\n<span class=\"token variable\">$ResourceGroupName</span> = <span class=\"token string\">\"Default-Web-NorthCentralUS\"</span>\n<span class=\"token variable\">$AppServiceName</span> = <span class=\"token string\">\"[redacted]\"</span>\n\n<span class=\"token variable\">$WebApp</span> = <span class=\"token function\">Get-AzWebApp</span> <span class=\"token operator\">-</span>ResourceGroupName <span class=\"token variable\">$ResourceGroupName</span> <span class=\"token operator\">-</span>Name <span class=\"token variable\">$AppServiceName</span></code></pre></div>\n<p>To use <a href=\"https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/invoke-restmethod?view=powershell-6#examples\">Invoke-RestMethod</a> to call the Azure REST API directly, I need an Access Token.  I looked at the <a href=\"https://docs.microsoft.com/en-us/azure/cloud-shell/msi-authorization\">Acquire access token in Cloud Shell</a> section of “Use managed identities for Azure resources in Azure Cloud Shell” to understand how to get my MSI Access Token.  I created the <code class=\"language-text\">Get-KJHAuthorizationHeaders</code> code below as a helper to correctly format the <code class=\"language-text\">Authorization</code> HTTP header.</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\"><span class=\"token keyword\">function</span> <span class=\"token function\">Get-KJHAuthorizationHeaders</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token variable\">$response</span> = <span class=\"token function\">Invoke-WebRequest</span> <span class=\"token operator\">-</span>Uri <span class=\"token variable\">$env</span>:MSI_ENDPOINT <span class=\"token operator\">-</span>Headers @<span class=\"token punctuation\">{</span><span class=\"token string\">\"Metadata\"</span>=<span class=\"token string\">\"true\"</span><span class=\"token punctuation\">}</span> <span class=\"token operator\">-</span>Body @<span class=\"token punctuation\">{</span><span class=\"token string\">\"resource\"</span>=<span class=\"token string\">\"https://management.azure.com/\"</span><span class=\"token punctuation\">}</span>\n\n    <span class=\"token variable\">$access_token</span> = <span class=\"token punctuation\">(</span><span class=\"token function\">ConvertFrom-Json</span> <span class=\"token operator\">-</span>InputObject <span class=\"token variable\">$response</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>access_token\n\n    <span class=\"token variable\">$headers</span> = <span class=\"token function\">New-Object</span> <span class=\"token string\">\"System.Collections.Generic.Dictionary[[String],[String]]\"</span>\n    <span class=\"token variable\">$headers</span><span class=\"token punctuation\">.</span>Add<span class=\"token punctuation\">(</span><span class=\"token string\">\"Authorization\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Bearer \"</span> <span class=\"token operator\">+</span> <span class=\"token variable\">$access_token</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token variable\">$headers</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Next, I created a <code class=\"language-text\">Put-KJHIPSecurityRestrictions</code> helper that would take an IP address parameter and submit the JSON payload that would set the IP Restrictions.  This needed the <code class=\"language-text\">$WebApp.id</code> value I mentioned above.</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\"><span class=\"token keyword\">function</span> Put<span class=\"token operator\">-</span>KJHIPSecurityRestrictions\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">Param</span>\n    <span class=\"token punctuation\">(</span>\n        <span class=\"token variable\">$WebApp</span><span class=\"token punctuation\">,</span>\n        <span class=\"token variable\">$Headers</span><span class=\"token punctuation\">,</span>\n        <span class=\"token variable\">$IP</span>\n    <span class=\"token punctuation\">)</span>\n    <span class=\"token variable\">$uri</span> = <span class=\"token string\">\"https://management.azure.com\"</span> <span class=\"token operator\">+</span> <span class=\"token variable\">$WebApp</span><span class=\"token punctuation\">.</span>id <span class=\"token operator\">+</span> <span class=\"token string\">\"/config/web?api-version=2018-02-01\"</span>\n    <span class=\"token variable\">$body</span> = @<span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"properties\"</span> = @<span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"ipSecurityRestrictions\"</span> = @<span class=\"token punctuation\">(</span>\n                 @<span class=\"token punctuation\">{</span>\n                     <span class=\"token string\">\"ipAddress\"</span> = <span class=\"token variable\">$IP</span>\n                     <span class=\"token string\">\"action\"</span> = <span class=\"token string\">\"Allow\"</span>\n                     <span class=\"token string\">\"tag\"</span> = <span class=\"token string\">\"Default\"</span>\n                     <span class=\"token string\">\"priority\"</span> = 100\n                     <span class=\"token string\">\"name\"</span> = <span class=\"token string\">\"KJHIPSecurityRestrictions\"</span>\n                 <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token variable\">$bodyJSON</span> = <span class=\"token function\">ConvertTo-Json</span> <span class=\"token variable\">$body</span> <span class=\"token operator\">-</span>Depth 3\n    <span class=\"token variable\">$response</span> = <span class=\"token function\">Invoke-RestMethod</span> <span class=\"token operator\">-</span>uri <span class=\"token variable\">$uri</span> <span class=\"token operator\">-</span>Headers <span class=\"token variable\">$Headers</span> <span class=\"token operator\">-</span>Method <span class=\"token string\">'PUT'</span> <span class=\"token operator\">-</span>ContentType <span class=\"token string\">'application/json'</span> <span class=\"token operator\">-</span>Body <span class=\"token variable\">$bodyJSON</span>\n\n    <span class=\"token variable\">$response</span><span class=\"token punctuation\">.</span>properties<span class=\"token punctuation\">.</span>ipSecurityRestrictions\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>I ran into early trouble passing <code class=\"language-text\">-Body $body</code> with an “The request content was invalid and could not be deserialized” error message. Some internet searching led me to using the <code class=\"language-text\">-Depth</code> parameter above.  Below is an example of how that affected serialization.</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\"><span class=\"token function\">PS</span> Azure:\\> <span class=\"token function\">ConvertTo-Json</span> <span class=\"token variable\">$body</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token string\">\"properties\"</span>: <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"ipSecurityRestrictions\"</span>: <span class=\"token punctuation\">[</span>\n      <span class=\"token string\">\"System.Collections.Hashtable\"</span>\n    <span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function\">PS</span> Azure:\\> <span class=\"token function\">ConvertTo-Json</span> <span class=\"token variable\">$body</span> <span class=\"token operator\">-</span>Depth 3\n<span class=\"token punctuation\">{</span>\n  <span class=\"token string\">\"properties\"</span>: <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"ipSecurityRestrictions\"</span>: <span class=\"token punctuation\">[</span>\n      <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"tag\"</span>: <span class=\"token string\">\"Default\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"name\"</span>: <span class=\"token string\">\"KJHIPSecurityRestrictions\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"ipAddress\"</span>: <span class=\"token string\">\"198.179.137.206/32\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"priority\"</span>: 100<span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"action\"</span>: <span class=\"token string\">\"Allow\"</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>It was time to put in all together and add an Access Restriction for my IP to my App Service.</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\"><span class=\"token function\">PS</span> Azure:\\> <span class=\"token variable\">$headers</span> = <span class=\"token function\">Get-KJHAuthorizationHeaders</span>\n<span class=\"token function\">PS</span> Azure:\\> Put<span class=\"token operator\">-</span>KJHIPSecurityRestrictions <span class=\"token operator\">-</span>WebApp <span class=\"token variable\">$WebApp</span> <span class=\"token operator\">-</span>Headers <span class=\"token variable\">$headers</span> <span class=\"token operator\">-</span>IP <span class=\"token string\">\"198.179.137.206/32\"</span>\n\nipAddress : 198<span class=\"token punctuation\">.</span>179<span class=\"token punctuation\">.</span>137<span class=\"token punctuation\">.</span>206<span class=\"token operator\">/</span>32\naction    : Allow\ntag       : Default\npriority  : 100\nname      : KJHIPSecurityRestrictions</code></pre></div>\n<p>I was also able to verify via the Azure Portal UI.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e61f50dd7965a40417b8f4d06e38c5f5/29beb/AccessRestrictions.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 12.837837837837837%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAi0lEQVQI1z1OSQ6DMBDjB5BMOkrCIQpk4dJDH9D/P8vFI9GDNYsXeYkxYl1XeO9Ra0UIAdu2/W9VhXPOcJ4nxhxIKZtH1OM4DtPSQ83CQD5EBNd1Yc6J3jtKKTZbaxZEntqUEoK8oFHw+WaMMYxjBsss+77bQVBMEwmC7Sjm/rQw3E30/r9zxlPowQ8zDUx/vN7GRQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Access Restrictions\"\n        title=\"Access Restrictions\"\n        src=\"/static/e61f50dd7965a40417b8f4d06e38c5f5/fcda8/AccessRestrictions.png\"\n        srcset=\"/static/e61f50dd7965a40417b8f4d06e38c5f5/12f09/AccessRestrictions.png 148w,\n/static/e61f50dd7965a40417b8f4d06e38c5f5/e4a3f/AccessRestrictions.png 295w,\n/static/e61f50dd7965a40417b8f4d06e38c5f5/fcda8/AccessRestrictions.png 590w,\n/static/e61f50dd7965a40417b8f4d06e38c5f5/efc66/AccessRestrictions.png 885w,\n/static/e61f50dd7965a40417b8f4d06e38c5f5/c83ae/AccessRestrictions.png 1180w,\n/static/e61f50dd7965a40417b8f4d06e38c5f5/29beb/AccessRestrictions.png 1830w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>","frontmatter":{"title":"Programmatically Adding IP Restrictions to an Azure App Service","description":null,"date":"June 14, 2019","tags":["security","azure","powershell","cloudshell"],"canonical":null}}},"pageContext":{"slug":"/2019-06-14-programmatically-adding-ip-restrictions-to-an-azure-app-service","previous":{"fields":{"slug":"/2019-06-09-uml-sequence-diagrams-using-plantuml"},"frontmatter":{"tags":["uml"]}},"next":{"fields":{"slug":"/2019-07-07-aws-signature-authorization-using-postman"},"frontmatter":{"tags":["http","aws","security"]}}}},"staticQueryHashes":["2589769190","3567236516"]}