{"componentChunkName":"component---src-templates-blog-post-js","path":"/2017-07-05-capital-one-cloud-custodian-test-drive","webpackCompilationHash":"b9cb1a030f9c4ce8c0c0","result":{"data":{"site":{"siteMetadata":{"title":"kevinhakanson.com","author":"Kevin Hakanson"}},"markdownRemark":{"id":"b9c258cd-bd68-5216-82cc-1980bb777a82","excerpt":"I’ve mentioned capitalone/cloud-custodian: Rules engine for AWS management before but hadn’t taken it for a “test drive” yet. However, instead of following the…","html":"<p>I’ve mentioned <a href=\"https://github.com/capitalone/cloud-custodian\">capitalone/cloud-custodian: Rules engine for AWS management</a> before but hadn’t taken it for a “test drive” yet.</p>\n<p>However, instead of following the instructions, I wanted to use the <a href=\"https://www.continuum.io/what-is-anaconda\">Anaconda</a> distribution of Python, so I used these install commands.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ conda create --name custodian <span class=\"token assign-left variable\">python</span><span class=\"token operator\">=</span><span class=\"token number\">2.7</span>\n$ <span class=\"token builtin class-name\">source</span> activate custodian\n$ pip <span class=\"token function\">install</span> c7n</code></pre></div>\n<p>I wanted something simple to test, and easy to verify, so I created this <code class=\"language-text\">policy.yml</code> to find any running ec2 instances without the <code class=\"language-text\">xx:financial-identifier</code> tag:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">policies</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> tag<span class=\"token punctuation\">-</span>compliance\n  <span class=\"token key atrule\">resource</span><span class=\"token punctuation\">:</span> ec2\n  <span class=\"token key atrule\">filters</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">State.Name</span><span class=\"token punctuation\">:</span> running\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">\"tag:xx:financial-identifier\"</span><span class=\"token punctuation\">:</span> absent</code></pre></div>\n<p>I ran <code class=\"language-text\">custodian</code> using the command line to first validate the <code class=\"language-text\">policy.yml</code> and the execute a dry run:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ custodian validate policy.yml \n<span class=\"token number\">2017</span>-07-05 <span class=\"token number\">10</span>:31:35,651: custodian.commands:INFO Configuration valid: policy.yml\n\n$ custodian run --dryrun -s out policy.yml\n<span class=\"token number\">2017</span>-07-05 <span class=\"token number\">10</span>:31:41,651: custodian.policy:INFO policy: tag-compliance resource:ec2 region:us-east-1 count:24 time:0.01</code></pre></div>\n<p>It found 24 instances!  If I look in <code class=\"language-text\">out/tag-compliance/resources.json</code> I can see the full details, or I can just grep for the <code class=\"language-text\">InstanceId</code> values and see something like:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">grep</span> InstanceId out/tag-compliance/resources.json\n    <span class=\"token string\">\"InstanceId\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"i-01234567890123456\"</span>,\n    <span class=\"token string\">\"InstanceId\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"i-01234567\"</span></code></pre></div>\n<p>I chose this filter because I can use the AWS Console Tag Editor to verify that count.</p>\n<p>Now that I know it works, time to start crafting some interesting policies.</p>","frontmatter":{"title":"Capital One Cloud Custodian \"Test Drive\"","date":"July 05, 2017","tags":["aws","python","devops","security"]}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/2017-07-05-capital-one-cloud-custodian-test-drive","previous":{"fields":{"slug":"/2017-06-28-authenticated-encryption-with-the-aws-cli"},"frontmatter":{"tags":["aws","cli","encryption"]}},"next":{"fields":{"slug":"/2017-07-06-the-geographical-center-of-the-united-states-and-ip-addresses"},"frontmatter":{"tags":["random","networking"]}}}}}