{"componentChunkName":"component---src-templates-blog-post-js","path":"/2022-08-06-refactoring-python-based-aws-lambda-functions-for-testing","result":{"data":{"site":{"siteMetadata":{"title":"kevinhakanson.com","author":"Kevin Hakanson"}},"markdownRemark":{"id":"d2d0ee28-5fe4-5a47-a972-f49e84b1b075","excerpt":"I’ve been looking at serverless, event-driven architectures using AWS Lambda and how to test individual components.  In this post, I take an example AWS Lambda…","html":"<p>I’ve been looking at serverless, <a href=\"https://docs.aws.amazon.com/lambda/latest/operatorguide/event-driven-architectures.html\">event-driven architectures</a> using AWS Lambda and how to test individual components.  In this post, I take an example AWS Lambda function using the Python <a href=\"https://docs.aws.amazon.com/lambda/latest/dg/lambda-runtimes.html\">runtime</a> which was not designed for testability.  I then incrementally introduce changes that result in an updated version.</p>\n<h2>Example Scenario</h2>\n<p>A developer is using their local development environment to code and test an AWS Lambda function. The Python-based Lambda function implements a simple hit counter, using Amazon DynamoDB to persist the counts.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/86cf661b05302ad57da78e7112f94cfd/339e3/DevEnv.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 32.43243243243243%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABcSAAAXEgFnn9JSAAABdUlEQVQY0y2Qv2tTURiGs/r/ODg6OLr5F3Sv4OIoFB2cSoe6WsFFIdLWwUUqOMRCJsFIpDExmt40Tb3JPb/vj3POfeQefLf34+GB7+01PlA3DdtCsRWaQmiEMihtqKqaLj8upuw9P+D3nwWLy4w8z7HWYq2hdBZnbdRao5Qa97wPtC2YskEZhysrpHasc4stQxIuLpf0Tz4gN2tEvkyiLnUTMS7iAzHG8F8YIsRAlGui9wkcDCUP9644fOsIoaFqAtFskG92cEe3af9+S1z//TW7T9f0z+oILULqcc/HlrZ2VJNzSiUTeHyScff+Vx49uyaGBu1qNoufzJ/cYfn4FuV8kLjDFxPuPRix/3Ibu14UatxrvCfLMr6PRlytVgmcTXOOXg35+GmaeseoYsvs8ym/zl6jNyt8CHwZTHh3fMH5cB61Fhhju5cD3Y6FEHjv056uNGTZjJubJSG21HWNVApdeYTzGOswxmCMIHiN0UWUUnW38T+pHLhkWkv8sQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Development Environment\"\n        title=\"Development Environment\"\n        src=\"/static/86cf661b05302ad57da78e7112f94cfd/fcda8/DevEnv.png\"\n        srcset=\"/static/86cf661b05302ad57da78e7112f94cfd/12f09/DevEnv.png 148w,\n/static/86cf661b05302ad57da78e7112f94cfd/e4a3f/DevEnv.png 295w,\n/static/86cf661b05302ad57da78e7112f94cfd/fcda8/DevEnv.png 590w,\n/static/86cf661b05302ad57da78e7112f94cfd/efc66/DevEnv.png 885w,\n/static/86cf661b05302ad57da78e7112f94cfd/339e3/DevEnv.png 977w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>The Python code below represents the first iteration which was not designed for testability.  The <code class=\"language-text\">lambda_handler</code> receives an <code class=\"language-text\">event</code> object with a string <code class=\"language-text\">key</code> and optional integer between 1 and 9 (inclusive). If the validation logics passes, it creates or updates a DynamoDB table item, adding the <code class=\"language-text\">increment</code> value to the <code class=\"language-text\">hits</code> field, and returns a response with the updated <code class=\"language-text\">count</code> value.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># \"before\" version of hitcounter - not designed for testability</span>\n<span class=\"token keyword\">import</span> os\n<span class=\"token keyword\">import</span> boto3\n\n<span class=\"token comment\"># run once when the execution environment is created</span>\nDYNAMODB_TABLE_NAME <span class=\"token operator\">=</span> os<span class=\"token punctuation\">.</span>environ<span class=\"token punctuation\">[</span><span class=\"token string\">\"DYNAMODB_TABLE_NAME\"</span><span class=\"token punctuation\">]</span>\ndynamodb_resource <span class=\"token operator\">=</span> boto3<span class=\"token punctuation\">.</span>resource<span class=\"token punctuation\">(</span><span class=\"token string\">'dynamodb'</span><span class=\"token punctuation\">)</span>\ndynamodb_table <span class=\"token operator\">=</span> dynamodb_resource<span class=\"token punctuation\">.</span>Table<span class=\"token punctuation\">(</span>DYNAMODB_TABLE_NAME<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">lambda_handler</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    increment <span class=\"token operator\">=</span> event<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'increment'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>increment <span class=\"token operator\">&lt;</span> <span class=\"token number\">1</span> <span class=\"token keyword\">or</span> increment <span class=\"token operator\">></span> <span class=\"token number\">9</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"count\"</span><span class=\"token punctuation\">:</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">}</span>\n\n    response <span class=\"token operator\">=</span> dynamodb_table<span class=\"token punctuation\">.</span>update_item<span class=\"token punctuation\">(</span>\n        Key<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"PK\"</span><span class=\"token punctuation\">:</span> event<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'key'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        UpdateExpression<span class=\"token operator\">=</span><span class=\"token string\">\"ADD hits :num\"</span><span class=\"token punctuation\">,</span>\n        ExpressionAttributeValues<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\":num\"</span><span class=\"token punctuation\">:</span> increment\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        ReturnValues<span class=\"token operator\">=</span><span class=\"token string\">\"UPDATED_NEW\"</span>\n    <span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"count\"</span><span class=\"token punctuation\">:</span> response<span class=\"token punctuation\">[</span><span class=\"token string\">'Attributes'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">'hits'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span></code></pre></div>\n<p>This code follows the <a href=\"https://docs.aws.amazon.com/lambda/latest/dg/best-practices.html\">best practices for working with AWS Lambda functions</a> recommendations of using <a href=\"https://docs.aws.amazon.com/lambda/latest/dg/configuration-envvars.html\">environment variables</a> to pass operational parameters (<code class=\"language-text\">DYNAMODB_TABLE_NAME</code>) and initializing the DynamoDB connection outside of the function handler for reuse by subsequent invocations processed by the same instance.  However, it did not separate the Lambda handler and core logic to make a more unit-testable function.  The developer wants to test the full functionality of this Lambda function prior to deployment in AWS, including its interactions with the DynamoDB table.</p>\n<h2>Defining an Event Schema</h2>\n<p>An <a href=\"https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-concepts.html#gettingstarted-concepts-event\">event</a> is a JSON-formatted document that contains data for a Lambda function to process. The Python runtime converts this event into a <a href=\"https://docs.python.org/3/c-api/dict.html\">dictionary object</a> and passes it to the handler.  When a Lambda function is invoked synchronously, the function’s response is sent back to the invoker.  From inspecting the Python code above, you can infer the event and response structure have the following shape.</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token comment\">// sample event</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"key\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"SampleEvent\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"increment\"</span><span class=\"token operator\">:</span> <span class=\"token number\">2</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// sample response</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"count\"</span><span class=\"token operator\">:</span> <span class=\"token number\">2</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Type annotations are a more formal way to define the event and response structures.  The Python <a href=\"https://docs.python.org/3/library/typing.html\">typing</a> module provides runtime support for type hints with <a href=\"https://docs.python.org/3/library/typing.html#typing.TypedDict\">TypeDict</a> being a special construct which declares a dictionary type.  The <a href=\"https://awslabs.github.io/aws-lambda-powertools-python/latest/\">AWS Lambda Powertools for Python</a> provides a static typing class for <a href=\"https://awslabs.github.io/aws-lambda-powertools-python/latest/utilities/typing/#lambdacontext\"><code class=\"language-text\">LambdaContext</code></a> and a <a href=\"https://awslabs.github.io/aws-lambda-powertools-python/latest/utilities/parser/\">Parser</a> utility for data validation.</p>\n<p>The code below creates <a href=\"https://docs.python.org/3/tutorial/classes.html\">Python classes</a> for <code class=\"language-text\">HitCounterEvent</code> and <code class=\"language-text\">HitCounterResponse</code>, then annotates the <code class=\"language-text\">lambda_handler</code> function with them.  This is not enforced by the Python runtime, but enables type checking and autocompletion inside IDEs. The <code class=\"language-text\">HitCounterEvent</code> class inherits from <code class=\"language-text\">BaseModel</code> which supports decorating of methods to provide validation.  The logic that defaults the <code class=\"language-text\">increment</code> value to 1 and performs a range check between 1 and 9 (inclusive) has moved out of <code class=\"language-text\">lambda_handler</code> and into <code class=\"language-text\">HitCounterEvent</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> typing <span class=\"token keyword\">import</span> TypedDict\n<span class=\"token keyword\">from</span> aws_lambda_powertools<span class=\"token punctuation\">.</span>utilities<span class=\"token punctuation\">.</span>parser <span class=\"token keyword\">import</span> BaseModel<span class=\"token punctuation\">,</span> parse<span class=\"token punctuation\">,</span> validator\n<span class=\"token keyword\">from</span> aws_lambda_powertools<span class=\"token punctuation\">.</span>utilities<span class=\"token punctuation\">.</span>typing <span class=\"token keyword\">import</span> LambdaContext\n\n<span class=\"token comment\"># new class definitions for Event and Response</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">HitCounterEvent</span><span class=\"token punctuation\">(</span>BaseModel<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    key<span class=\"token punctuation\">:</span> <span class=\"token builtin\">str</span>\n    increment<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span>\n\n    <span class=\"token decorator annotation punctuation\">@validator</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"increment\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">set_increment</span><span class=\"token punctuation\">(</span>cls<span class=\"token punctuation\">,</span> v<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>v <span class=\"token operator\">&lt;</span> <span class=\"token number\">1</span> <span class=\"token keyword\">or</span> v <span class=\"token operator\">></span> <span class=\"token number\">9</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">raise</span> ValueError<span class=\"token punctuation\">(</span><span class=\"token string\">\"increment must be between 1-9 (inclusive)\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> v\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">HitCounterResponse</span><span class=\"token punctuation\">(</span>TypedDict<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    count<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">lambda_handler</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">:</span> HitCounterEvent<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">:</span> LambdaContext<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> HitCounterResponse<span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># function body from above returning result</span></code></pre></div>\n<h2>First Unit Tests</h2>\n<p>By using well-defined event and response objects, writing unit tests is simplified by not searching for dictionary key string values.  The <code class=\"language-text\">@validator</code> decorated method is executed when constructing <code class=\"language-text\">HitCounterEvent</code> objects.   The tests below use the <a href=\"https://docs.python.org/3/library/unittest.html\">unittest</a> unit testing framework which look similar to other testing frameworks from other languages.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> unittest <span class=\"token keyword\">import</span> TestCase\n<span class=\"token keyword\">from</span> src<span class=\"token punctuation\">.</span>hitcounter2<span class=\"token punctuation\">.</span>app <span class=\"token keyword\">import</span> <span class=\"token punctuation\">(</span>HitCounterEvent<span class=\"token punctuation\">,</span> HitCounterResponse<span class=\"token punctuation\">,</span> lambda_handler<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">TestHitCounterEventValidation</span><span class=\"token punctuation\">(</span>TestCase<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">test_get_increment_default</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        event <span class=\"token operator\">=</span> HitCounterEvent<span class=\"token punctuation\">(</span>key<span class=\"token operator\">=</span><span class=\"token string\">\"test\"</span><span class=\"token punctuation\">)</span>\n        self<span class=\"token punctuation\">.</span>assertEqual<span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">.</span>increment<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">test_get_increment_2</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        event <span class=\"token operator\">=</span> HitCounterEvent<span class=\"token punctuation\">(</span>key<span class=\"token operator\">=</span><span class=\"token string\">\"test\"</span><span class=\"token punctuation\">,</span> increment<span class=\"token operator\">=</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n        self<span class=\"token punctuation\">.</span>assertEqual<span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">.</span>increment<span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">test_get_increment_0</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">with</span> self<span class=\"token punctuation\">.</span>assertRaises<span class=\"token punctuation\">(</span>ValueError<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n            event <span class=\"token operator\">=</span> HitCounterEvent<span class=\"token punctuation\">(</span>key<span class=\"token operator\">=</span><span class=\"token string\">\"test\"</span><span class=\"token punctuation\">,</span> increment<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h2>Next Unit Test</h2>\n<p>The Lambda runtime doesn’t know about or construct <code class=\"language-text\">HitCounterEvent</code>, but as mentioned earlier, deserializes JSON into a dictionary object.  The <code class=\"language-text\">lambda_handler</code> needs to explicitly call parse with the <code class=\"language-text\">event</code> object and specify the <code class=\"language-text\">HitCounterEvent</code> model.  The Lambda handler is still responsible for handling <code class=\"language-text\">ValueError</code> and returning a <code class=\"language-text\">HitCounterResponse</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">lambda_handler</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">:</span> HitCounterEvent<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">:</span> LambdaContext<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> HitCounterResponse<span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">try</span><span class=\"token punctuation\">:</span>\n        event <span class=\"token operator\">=</span> parse<span class=\"token punctuation\">(</span>event<span class=\"token operator\">=</span>event<span class=\"token punctuation\">,</span> model<span class=\"token operator\">=</span>HitCounterEvent<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">except</span> ValueError<span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">return</span> HitCounterResponse<span class=\"token punctuation\">(</span>count<span class=\"token operator\">=</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n        \n    <span class=\"token comment\"># remaining function body from above returning result</span></code></pre></div>\n<p>The test below creates a <code class=\"language-text\">dict</code> with the <code class=\"language-text\">increment</code> value of 0 and calls the <code class=\"language-text\">lambda_handler</code> . Since this is outside of the allowed range, the test expects validation failure and asserts the <code class=\"language-text\">HitCounterResponse</code> has a <code class=\"language-text\">count</code> of -1.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">    <span class=\"token keyword\">def</span> <span class=\"token function\">test_lambda_handler_increment_0</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        test_event_dict <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"key\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"HandlerTest\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"increment\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">}</span>\n        test_response<span class=\"token punctuation\">:</span> HitCounterResponse <span class=\"token operator\">=</span> lambda_handler<span class=\"token punctuation\">(</span>\n            event<span class=\"token operator\">=</span>test_event_dict<span class=\"token punctuation\">,</span> context<span class=\"token operator\">=</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">)</span>\n        self<span class=\"token punctuation\">.</span>assertEqual<span class=\"token punctuation\">(</span>test_response<span class=\"token punctuation\">[</span><span class=\"token string\">\"count\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h2>Preparing for Mocking</h2>\n<p>The original code unconditionally creates DynamoDB resources, causing challenges for mocking and patching inside unit tests.  To continue the best practice to create once and reuse, I declare a global variable named <code class=\"language-text\">_SERVICES</code> and initially set to <a href=\"https://docs.python.org/3/c-api/none.html\"><em>None</em></a>.  I also create a <code class=\"language-text\">Services</code> class to hold the set of AWS resource, using resource names as incoming parameters to remove the dependency on specific environment variable names.  Finding one of the <a href=\"https://docs.aws.amazon.com/lambda/latest/dg/configuration-envvars.html#configuration-envvars-runtime\">defined runtime environment variables</a> indicates this code is running inside a Lambda runtime, and a <code class=\"language-text\">Services</code> object should be constructed.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># define a Services class for AWS service resources</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Services</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> dynamodb_table_name<span class=\"token punctuation\">:</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        self<span class=\"token punctuation\">.</span>dynamodb_resource <span class=\"token operator\">=</span> boto3<span class=\"token punctuation\">.</span>resource<span class=\"token punctuation\">(</span><span class=\"token string\">'dynamodb'</span><span class=\"token punctuation\">)</span>\n        self<span class=\"token punctuation\">.</span>dynamodb_table <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>dynamodb_resource<span class=\"token punctuation\">.</span>Table<span class=\"token punctuation\">(</span>\n            dynamodb_table_name<span class=\"token punctuation\">)</span>\n\n_SERVICES<span class=\"token punctuation\">:</span> Services <span class=\"token operator\">=</span> <span class=\"token boolean\">None</span>\n<span class=\"token keyword\">if</span> os<span class=\"token punctuation\">.</span>getenv<span class=\"token punctuation\">(</span><span class=\"token string\">\"AWS_LAMBDA_FUNCTION_NAME\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># only initialize _SERVICES under Lambda runtime</span>\n    _SERVICES <span class=\"token operator\">=</span> Services<span class=\"token punctuation\">(</span>dynamodb_table_name<span class=\"token operator\">=</span>os<span class=\"token punctuation\">.</span>getenv<span class=\"token punctuation\">(</span><span class=\"token string\">\"DYNAMODB_TABLE_NAME\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>The code which updates DynamoDB items is extracted into an <code class=\"language-text\">update_hits</code> function, taking a <code class=\"language-text\">Services</code> object parameter rather than directly accessing the global variable.  This refactoring enables both mocking for unit tests and independence for future integration tests.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">update_hits</span><span class=\"token punctuation\">(</span>services<span class=\"token punctuation\">:</span> Services<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">:</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">,</span> increment<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">:</span>\n    response <span class=\"token operator\">=</span> services<span class=\"token punctuation\">.</span>dynamodb_table<span class=\"token punctuation\">.</span>update_item<span class=\"token punctuation\">(</span>\n        Key<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"PK\"</span><span class=\"token punctuation\">:</span> key<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        UpdateExpression<span class=\"token operator\">=</span><span class=\"token string\">\"ADD hits :num\"</span><span class=\"token punctuation\">,</span>\n        ExpressionAttributeValues<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\":num\"</span><span class=\"token punctuation\">:</span> increment\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        ReturnValues<span class=\"token operator\">=</span><span class=\"token string\">\"UPDATED_NEW\"</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">return</span> response<span class=\"token punctuation\">[</span><span class=\"token string\">\"Attributes\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"hits\"</span><span class=\"token punctuation\">]</span></code></pre></div>\n<p>The updated <code class=\"language-text\">lambda_handler</code> now calls <code class=\"language-text\">parse</code> and explicitly passes <code class=\"language-text\">_SERVICES</code> lazy into <code class=\"language-text\">update_hits</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">lambda_handler</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">:</span> HitCounterEvent<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">:</span> LambdaContext<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> HitCounterResponse<span class=\"token punctuation\">:</span>\n\n    <span class=\"token keyword\">try</span><span class=\"token punctuation\">:</span>\n        event <span class=\"token operator\">=</span> parse<span class=\"token punctuation\">(</span>event<span class=\"token operator\">=</span>event<span class=\"token punctuation\">,</span> model<span class=\"token operator\">=</span>HitCounterEvent<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">except</span> ValueError<span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">return</span> HitCounterResponse<span class=\"token punctuation\">(</span>count<span class=\"token operator\">=</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\"># explicitly pass _SERVICES into function</span>\n    hits <span class=\"token operator\">=</span> update_hits<span class=\"token punctuation\">(</span>\n        services<span class=\"token operator\">=</span>_SERVICES<span class=\"token punctuation\">,</span> key<span class=\"token operator\">=</span>event<span class=\"token punctuation\">.</span>key<span class=\"token punctuation\">,</span> increment<span class=\"token operator\">=</span>event<span class=\"token punctuation\">.</span>increment<span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">return</span> HitCounterResponse<span class=\"token punctuation\">(</span>count<span class=\"token operator\">=</span>hits<span class=\"token punctuation\">)</span></code></pre></div>\n<h2>Unit Testing with Mock Amazon DynamoDB</h2>\n<p>During normal execution, the Lambda function code accesses AWS resources such as a DynamoDB table.  When running tests, I want to test interactions with these services without accidentally changing live data in DynamoDB. I may also want to run tests in an environment without a connection to AWS.</p>\n<p>This solution uses the <a href=\"http://docs.getmoto.org/en/latest/index.html#\">Moto</a> third-party library to mock out AWS services, replacing them with simulated versions running locally.  Instead of using the live AWS service, DynamoDB is mocked and simulated for the entire test class using the <a href=\"http://docs.getmoto.org/en/latest/docs/services/dynamodb.html?highlight=mock_dynamodb\">moto.mock_dynamodb</a> decorator.  This both replaces the <a href=\"https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/dynamodb.html\">boto3 dynamodb resource</a> with a mock object storing data in memory and enables assertions about how that object has been used.  In the <code class=\"language-text\">TestCase</code> below, the <code class=\"language-text\">setUp</code> and <code class=\"language-text\">tearDown</code> methods construct and remove a mocked DynamoDB table and manipulate <a href=\"https://docs.python.org/3/library/sys.html#sys.modules\">sys.modules</a> to set the <code class=\"language-text\">_SERVICES</code> global to an instances of the <code class=\"language-text\">Services</code> class.  Also note there is no dependency on setting specific environment variables.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> moto\n\n<span class=\"token decorator annotation punctuation\">@moto<span class=\"token punctuation\">.</span>mock_dynamodb</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">TestHitCounterLambdaDynamoDB</span><span class=\"token punctuation\">(</span>TestCase<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># Test Set up</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">setUp</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span>\n        <span class=\"token comment\"># Set up the services: construct a (mocked!) DynamoDB table</span>\n        self<span class=\"token punctuation\">.</span>DYNAMODB_TABLE_NAME <span class=\"token operator\">=</span> <span class=\"token string\">\"unit_test_ddb\"</span>\n        dynamodb <span class=\"token operator\">=</span> boto3<span class=\"token punctuation\">.</span>resource<span class=\"token punctuation\">(</span><span class=\"token string\">\"dynamodb\"</span><span class=\"token punctuation\">,</span> region_name<span class=\"token operator\">=</span><span class=\"token string\">\"us-east-1\"</span><span class=\"token punctuation\">)</span>\n        dynamodb<span class=\"token punctuation\">.</span>create_table<span class=\"token punctuation\">(</span>\n            TableName<span class=\"token operator\">=</span>self<span class=\"token punctuation\">.</span>DYNAMODB_TABLE_NAME<span class=\"token punctuation\">,</span>\n            KeySchema<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"AttributeName\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"PK\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"KeyType\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"HASH\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n            AttributeDefinitions<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>\n                <span class=\"token punctuation\">{</span><span class=\"token string\">\"AttributeName\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"PK\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"AttributeType\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"S\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n            BillingMode<span class=\"token operator\">=</span><span class=\"token string\">\"PAY_PER_REQUEST\"</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token comment\"># set the _SERVICES global</span>\n        sys<span class=\"token punctuation\">.</span>modules<span class=\"token punctuation\">[</span><span class=\"token string\">\"src.hitcounter2.app\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>_SERVICES <span class=\"token operator\">=</span> Services<span class=\"token punctuation\">(</span>\n            dynamodb_table_name<span class=\"token operator\">=</span>self<span class=\"token punctuation\">.</span>DYNAMODB_TABLE_NAME<span class=\"token punctuation\">)</span>\n            \n    <span class=\"token comment\"># tests go here</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">tearDown</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token comment\"># [12] Remove (mocked!) DynamoDB Table</span>\n        dynamodb <span class=\"token operator\">=</span> boto3<span class=\"token punctuation\">.</span>client<span class=\"token punctuation\">(</span><span class=\"token string\">\"dynamodb\"</span><span class=\"token punctuation\">,</span> region_name<span class=\"token operator\">=</span><span class=\"token string\">\"us-east-1\"</span><span class=\"token punctuation\">)</span>\n        dynamodb<span class=\"token punctuation\">.</span>delete_table<span class=\"token punctuation\">(</span>TableName<span class=\"token operator\">=</span>self<span class=\"token punctuation\">.</span>DYNAMODB_TABLE_NAME<span class=\"token punctuation\">)</span>\n\n        sys<span class=\"token punctuation\">.</span>modules<span class=\"token punctuation\">[</span><span class=\"token string\">\"src.hitcounter2.app\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>_SERVICES <span class=\"token operator\">=</span> <span class=\"token boolean\">None</span></code></pre></div>\n<p>The following code tests the entire Lambda function at once, including the <code class=\"language-text\">lambda_handler</code> and all the extracted functions.  It passes because <code class=\"language-text\">moto.mock_dynamodb</code> implements both the DynamoDB resource creation and the update item logic.  This is more course-grained than an ideal unit test and also relies on the moto emulation of DynamoDB.</p>\n<p>For the test event data, a good practice is saving them with as separate JSON files in your project rather than hard coding them inline.  The test code also introduces a <code class=\"language-text\">load_test_event</code> helper method which allows <code class=\"language-text\">test_event</code> to be loaded from the test data location.  The <code class=\"language-text\">tests/events/SampleEvent.json</code> file used in the test below  contains the same sample event from earlier in this blog.  Externalizing test data info files also scales out test coverage without repeating similar test methods.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">    <span class=\"token keyword\">def</span> <span class=\"token function\">load_test_event</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> test_event_file_name<span class=\"token punctuation\">:</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> HitCounterEvent<span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">return</span> HitCounterEvent<span class=\"token punctuation\">.</span>parse_file<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"tests/events/</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>test_event_file_name<span class=\"token punctuation\">}</span></span><span class=\"token string\">.json\"</span></span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">test_lambda_handler</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token comment\"># invoke lambda_handler</span>\n        test_event<span class=\"token punctuation\">:</span> HitCounterEvent <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>load_test_event<span class=\"token punctuation\">(</span><span class=\"token string\">\"SampleEvent\"</span><span class=\"token punctuation\">)</span>\n        test_response<span class=\"token punctuation\">:</span> HitCounterResponse <span class=\"token operator\">=</span> lambda_handler<span class=\"token punctuation\">(</span>\n            event<span class=\"token operator\">=</span>test_event<span class=\"token punctuation\">,</span> context<span class=\"token operator\">=</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">)</span>\n\n        self<span class=\"token punctuation\">.</span>assertEqual<span class=\"token punctuation\">(</span>test_response<span class=\"token punctuation\">[</span><span class=\"token string\">\"count\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>The <code class=\"language-text\">update_hits</code> method can be tested directly. This realizes the value of passing in the <code class=\"language-text\">Services</code> object instead of taking a dependency on a Global. This test doesn’t depend on <code class=\"language-text\">lambda_handler</code> logic, but still uses <code class=\"language-text\">mock_dynamodb</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">    <span class=\"token keyword\">def</span> <span class=\"token function\">test_lambda_handler_update_hits</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token comment\"># call update_hits with explicit Services object</span>\n        services <span class=\"token operator\">=</span> Services<span class=\"token punctuation\">(</span>dynamodb_table_name<span class=\"token operator\">=</span>self<span class=\"token punctuation\">.</span>DYNAMODB_TABLE_NAME<span class=\"token punctuation\">)</span>\n        hits <span class=\"token operator\">=</span> update_hits<span class=\"token punctuation\">(</span>\n            services<span class=\"token operator\">=</span>services<span class=\"token punctuation\">,</span> key<span class=\"token operator\">=</span><span class=\"token string\">\"update_hits\"</span><span class=\"token punctuation\">,</span> increment<span class=\"token operator\">=</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span>\n        self<span class=\"token punctuation\">.</span>assertEqual<span class=\"token punctuation\">(</span>hits<span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>With <code class=\"language-text\">update_hits</code> separately tested, this enables internal testing of <code class=\"language-text\">lambda_handler</code> logic independent of <code class=\"language-text\">update_hits</code> behaviors. The code below uses <a href=\"https://docs.python.org/3/library/unittest.mock.html#unittest.mock.patch\">patch</a> decorators and a <a href=\"https://docs.python.org/3/library/unittest.mock.html#unittest.mock.MagicMock\">MagicMock</a> object from <code class=\"language-text\">unittest.mock</code>.  This sets a <code class=\"language-text\">return_value</code> for the function call and use <code class=\"language-text\">assert_called_once_with</code> to inspect the incoming parameter values.  The test still calls <code class=\"language-text\">lambda_handler</code>, but two implicit dependencies are removed: 1) Mocking <code class=\"language-text\">_SERVICES</code> with a <a href=\"https://docs.python.org/3/library/unittest.mock.html#sentinel\"><em>sentinel</em></a> removes all dependencies on <code class=\"language-text\">dynamodb</code> resources ; and 2) Mocking <code class=\"language-text\">update_hits</code> still provides a return value even when the <code class=\"language-text\">moto.mock_dynamodb</code> implementation logic emulating <a href=\"https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/Expressions.UpdateExpressions.html\">DynamoDB update expressions</a> was removed.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">    <span class=\"token comment\"># Patch _SERVICES attribute and update_hits function call</span>\n    <span class=\"token decorator annotation punctuation\">@patch</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"src.hitcounter2.app._SERVICES\"</span><span class=\"token punctuation\">,</span> sentinel<span class=\"token punctuation\">.</span>attribute<span class=\"token punctuation\">)</span>\n    <span class=\"token decorator annotation punctuation\">@patch</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"src.hitcounter2.app.update_hits\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">test_lambda_handler_mocks</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span>\n                                  mock_update_hits<span class=\"token punctuation\">:</span> MagicMock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token comment\"># Test setup - Return mocked data</span>\n        mock_update_hits<span class=\"token punctuation\">.</span>return_value <span class=\"token operator\">=</span> <span class=\"token number\">2</span>\n\n        <span class=\"token comment\"># invoke lambda_handler</span>\n        test_event<span class=\"token punctuation\">:</span> HitCounterEvent <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>load_test_event<span class=\"token punctuation\">(</span><span class=\"token string\">\"SampleEvent\"</span><span class=\"token punctuation\">)</span>\n        test_response<span class=\"token punctuation\">:</span> HitCounterResponse <span class=\"token operator\">=</span> lambda_handler<span class=\"token punctuation\">(</span>\n            event<span class=\"token operator\">=</span>test_event<span class=\"token punctuation\">,</span> context<span class=\"token operator\">=</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token comment\"># Validate function called with parameter values</span>\n        mock_update_hits<span class=\"token punctuation\">.</span>assert_called_once_with<span class=\"token punctuation\">(</span>services<span class=\"token operator\">=</span>sentinel<span class=\"token punctuation\">.</span>attribute<span class=\"token punctuation\">,</span>\n                                                 key<span class=\"token operator\">=</span>test_event<span class=\"token punctuation\">.</span>key<span class=\"token punctuation\">,</span>\n                                                 increment<span class=\"token operator\">=</span>test_event<span class=\"token punctuation\">.</span>increment<span class=\"token punctuation\">)</span>\n\n        self<span class=\"token punctuation\">.</span>assertEqual<span class=\"token punctuation\">(</span>test_response<span class=\"token punctuation\">[</span><span class=\"token string\">\"count\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h2>Running the Unit Tests</h2>\n<p>Many IDEs and other tools support running Python tests based on <a href=\"https://docs.python.org/3/library/unittest.html\">unitest</a>, including the <a href=\"https://coverage.readthedocs.io/en/6.4.2/index.html\">coverage</a> tool for measuring code coverage.  An example of running this command is below and will provide a <code class=\"language-text\">OK</code> or <code class=\"language-text\">FAIL</code> status, indicating if all the tests pass.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">coverage run <span class=\"token parameter variable\">-m</span> unittest discover</code></pre></div>\n<p>The status can be used to determine if the code should then be deployed to AWS.  Tests should be run both in your local development environment and as part of your deployment pipeline.  For example, using <a href=\"https://aws.amazon.com/codepipeline/\">AWS CodePipeline</a>, you could run these tests in an <a href=\"https://aws.amazon.com/codebuild/\">AWS CodeBuild</a> stage, which would abort any subsequent deployment steps if the tests did not pass.</p>\n<h2>Local Integration Testing using Test Events</h2>\n<p>The <a href=\"https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-cli-install.html\">AWS SAM CLI</a> makes it easy to create and manage serverless applications.  You can run an integration test with the Lambda function code running in local docker container using the <a href=\"https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/sam-cli-command-reference-sam-local-invoke.html\">sam local invoke</a> command and integrate with a deployed DynamoDB table.  In the example below, <code class=\"language-text\">env.json</code> is an <a href=\"https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-cli-using-invoke.html#serverless-sam-cli-using-invoke-environment-file\">environment variable file</a> containing the value for <code class=\"language-text\">DYNAMODB_TABLE_NAME</code> and <code class=\"language-text\">tests/events/SampleEvent.json</code> is the same JSON file as the unit test.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">sam <span class=\"token builtin class-name\">local</span> invoke <span class=\"token punctuation\">\\</span>\n  --env-vars env.json <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">--event</span> tests/events/SampleEvent.json <span class=\"token punctuation\">\\</span>\n  HitCounter2Function </code></pre></div>\n<p>The <a href=\"https://aws.amazon.com/cli/\">AWS Command Line Interface</a> (AWS CLI) has a command to invoke a Lambda function. In the example below, the deployed Lambda function name is specified, the payload uses the same <code class=\"language-text\">tests/events/SampleEvent.json</code> from earlier, and the response is saved to a <code class=\"language-text\">SampleResponse.json</code> file.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">aws lambda invoke <span class=\"token punctuation\">\\</span>\n  --cli-binary-format raw-in-base64-out <span class=\"token punctuation\">\\</span>\n  --function-name stackname-HitCounter2Function-XXXXXXXX <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">--payload</span> file://tests/events/SampleEvent.json <span class=\"token punctuation\">\\</span>\n  SampleResponse.json</code></pre></div>\n<p><a href=\"https://docs.aws.amazon.com/lambda/latest/dg/testing-functions.html\">Testing Lambda functions from the AWS console</a> is possible using either private test events or sharable test events. Lambda saves shareable test events as schemas in an <a href=\"https://docs.aws.amazon.com/eventbridge/latest/userguide/eb-schema-registry.html\">Amazon EventBridge (CloudWatch Events) schema registry</a> named <code class=\"language-text\">lambda-testevent-schemas</code>.  Sharable test events can be created either in the console or via a <a href=\"https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-eventschemas-schema.html\">AWS::EventSchemas::Schema</a> CloudFormation resource.</p>","frontmatter":{"title":"Refactoring Python-based AWS Lambda functions for testing","description":null,"date":"August 6, 2022","tags":["aws","lambda","python","codequality"],"canonical":null}}},"pageContext":{"slug":"/2022-08-06-refactoring-python-based-aws-lambda-functions-for-testing","previous":{"fields":{"slug":"/2022-06-14-my-first-aws-blog"},"frontmatter":{"tags":["aws","s3"]}},"next":{"fields":{"slug":"/2022-10-02-sequence-diagrams-with-mermaid-and-diagramsnet"},"frontmatter":{"tags":["aws","uml"]}}}},"staticQueryHashes":["2589769190","97908498"]}