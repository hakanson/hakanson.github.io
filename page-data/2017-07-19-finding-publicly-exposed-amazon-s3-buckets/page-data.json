{"componentChunkName":"component---src-templates-blog-post-js","path":"/2017-07-19-finding-publicly-exposed-amazon-s3-buckets","webpackCompilationHash":"af0e4c24d4a507da8bf9","result":{"data":{"site":{"siteMetadata":{"title":"kevinhakanson.com","author":"Kevin Hakanson"}},"markdownRemark":{"id":"bff8bf6d-01c3-52e2-96f1-6a8bc80fc12c","excerpt":"You may have read recent news about millions of Verizon customers having their data exposed (see Experts Warn Too Often AWS S3 Buckets Are Misconfigured, Leak…","html":"<p>You may have read recent news about millions of Verizon customers having their data exposed (see <a href=\"https://threatpost.com/experts-warn-too-often-aws-s3-buckets-are-misconfigured-leak-data/126826/\">Experts Warn Too Often AWS S3 Buckets Are Misconfigured, Leak Data</a>).</p>\n<p>Possibly, people are confused about what the <strong>Authenticated Users group</strong> means. From <a href=\"http://docs.aws.amazon.com/AmazonS3/latest/dev/acl-overview.html\">Access Control List (ACL) Overview - Amazon Simple Storage Service</a>:</p>\n<blockquote>\n<p>Represented by <a href=\"http://acs.amazonaws.com/groups/global/AuthenticatedUsers\">http://acs.amazonaws.com/groups/global/AuthenticatedUsers</a>.<br>\nThis group represents all AWS accounts. Access permission to this group allows any AWS account to access the resource. However, all requests must be signed (authenticated).</p>\n</blockquote>\n<p>This doesn’t just mean IAM Users from their account, but <em>any</em> user from <em>any</em> AWS account.</p>\n<p>How do we check this on our accounts?  There are a couple of options.</p>\n<p>Use a <a href=\"http://www.capitalone.io/cloud-custodian/docs/policy/resources/s3.html\">Cloud Custodian S3 filter </a> with a <code class=\"language-text\">policy.yml</code> like:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">policies</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> s3<span class=\"token punctuation\">-</span>global\n  <span class=\"token key atrule\">resource</span><span class=\"token punctuation\">:</span> s3\n  <span class=\"token key atrule\">description</span><span class=\"token punctuation\">:</span> Publicly Exposed S3 Buckets\n  <span class=\"token key atrule\">filters</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> global<span class=\"token punctuation\">-</span>grants</code></pre></div>\n<p>Then run the <a href=\"https://github.com/capitalone/cloud-custodian\">custodian</a> tool and use <a href=\"https://stedolan.github.io/jq/\">jq</a> to filter the output, I find a bucket (names changed to protect the innocent).</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ custodian run --output-dir<span class=\"token operator\">=</span>. policy.yml --region<span class=\"token operator\">=</span>us-west-2\n\n$ jq <span class=\"token string\">'.[].Name'</span> s3-global/resources.json\n<span class=\"token string\">\"project1-test-bucket1\"</span></code></pre></div>\n<p>Amazon also has a utility called <a href=\"https://aws.amazon.com/premiumsupport/trustedadvisor/\">Trusted Advisor</a> that can report on several items, including <strong>Amazon S3 Bucket Permissions</strong>.  That has both a Console UI and is callable via API or CLI (via <a href=\"http://docs.aws.amazon.com/cli/latest/reference/support/describe-trusted-advisor-check-result.html\">describe-trusted-advisor-check-result</a>):</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ aws support describe-trusted-advisor-check-result <span class=\"token punctuation\">\\</span>\n--check-id Pfx0RwqBli <span class=\"token punctuation\">\\</span>\n--query <span class=\"token string\">'result.flaggedResources[*].metadata[2]'</span>\n<span class=\"token punctuation\">[</span>\n    <span class=\"token string\">\"project1-portal-ui\"</span>,\n    <span class=\"token string\">\"project1-test-bucket1\"</span>,\n<span class=\"token punctuation\">]</span></code></pre></div>\n<p>However, that list has 2 items vs. the 1 which Cloud Custodian found using its global-grants filter.  It appears that Cloud Custodian is filtering out buckets set up for website hosting (see <a href=\"https://docs.aws.amazon.com/AmazonS3/latest/dev/WebsiteHosting.html\">Hosting a Static Website on Amazon S3</a>), which seems like a valid result.</p>\n<p><img src=\"images/pastedImage_140.png\"></p>","frontmatter":{"title":"Finding Publicly Exposed Amazon S3 Buckets","date":"July 19, 2017","tags":["aws","devops","security","s3"]}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/2017-07-19-finding-publicly-exposed-amazon-s3-buckets","previous":{"fields":{"slug":"/2017-07-06-the-geographical-center-of-the-united-states-and-ip-addresses"},"frontmatter":{"tags":["random","networking"]}},"next":{"fields":{"slug":"/2017-07-20-application-security-testing-sast-dast-and-iast"},"frontmatter":{"tags":["security","codequality"]}}}}}