{"componentChunkName":"component---src-templates-blog-post-js","path":"/2019-10-25-aws-alb-lambda-function-targets-and-multi-value-headers","result":{"data":{"site":{"siteMetadata":{"title":"kevinhakanson.com","author":"Kevin Hakanson"}},"markdownRemark":{"id":"3c922e73-58d5-5cd9-a587-fea0a8439f0b","excerpt":"I finally took the time experiment with the ability of an AWS Application Load Balancer (ALB) to target a Lambda function for HTTP requests. I decided to start…","html":"<p>I finally took the time experiment with the ability of an AWS Application Load Balancer (ALB) to <a href=\"https://docs.aws.amazon.com/en_pv/elasticloadbalancing/latest/application/lambda-functions.html\">target a Lambda function</a> for HTTP requests.</p>\n<p>I decided to start with some Python code based on the <a href=\"https://github.com/aws/elastic-load-balancing-tools/tree/master/application-load-balancer-serverless-app/whatismyip\">whatismyip</a> example.  I mapped the <code class=\"language-text\">/whatismyip</code> path to return the caller’s IP address and defaulted other paths to returning the event as JSON.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> json\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">lambda_handler</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n\n  response <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"statusCode\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">200</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"headers\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token string\">\"Content-Type\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"text/plain;\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"isBase64Encoded\"</span><span class=\"token punctuation\">:</span> <span class=\"token boolean\">False</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">if</span> event<span class=\"token punctuation\">[</span><span class=\"token string\">'path'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span> <span class=\"token string\">'/whatismyip'</span><span class=\"token punctuation\">:</span>\n    sourceip_list <span class=\"token operator\">=</span> event<span class=\"token punctuation\">[</span><span class=\"token string\">'headers'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">'x-forwarded-for'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span><span class=\"token string\">','</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> sourceip_list<span class=\"token punctuation\">:</span>\n      sourceip <span class=\"token operator\">=</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>sourceip_list<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n      response<span class=\"token punctuation\">[</span><span class=\"token string\">'body'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">=</span>sourceip\n    <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span>\n      response<span class=\"token punctuation\">[</span><span class=\"token string\">'body'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">=</span><span class=\"token string\">'?.?.?.?'</span>\n    <span class=\"token keyword\">return</span> response\n\n  response<span class=\"token punctuation\">[</span><span class=\"token string\">'body'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> json<span class=\"token punctuation\">.</span>dumps<span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">,</span> indent<span class=\"token operator\">=</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n  \n  <span class=\"token keyword\">return</span> response</code></pre></div>\n<p>The <code class=\"language-text\">/whatismyip</code> path returns my IP as expected.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">http://lambdatarget-test-1584240650.us-east-1.elb.amazonaws.com/whatismyip\n198.179.137.209</code></pre></div>\n<p>Executing against the <code class=\"language-text\">/browser</code> path reflects the event structure.</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"requestContext\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"elb\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"targetGroupArn\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"arn:aws:elasticloadbalancing:us-east-1:123456789012:targetgroup/whatismyip-target/61f1fdd113474a4b\"</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"httpMethod\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"GET\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"path\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"/browser\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"queryStringParameters\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"headers\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"accept\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"accept-encoding\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"gzip, deflate\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"accept-language\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"en-US,en;q=0.9\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"connection\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"keep-alive\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"dnt\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"host\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"lambdatarget-test-1584240650.us-east-1.elb.amazonaws.com\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"upgrade-insecure-requests\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"user-agent\"</span><span class=\"token operator\">:</span> \"Mozilla/<span class=\"token number\">5.0</span> (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/<span class=\"token number\">537.36</span> (KHTML<span class=\"token punctuation\">,</span> like Gecko) Chrome/<span class=\"token number\">78.0</span>.<span class=\"token number\">3904.70</span> Safari/<span class=\"token number\">537.36</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"x-amzn-trace-id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Root=1-5db31bde-f102927a851f3aaa17ebd23a\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"x-forwarded-for\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"198.179.137.209\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"x-forwarded-port\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"80\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"x-forwarded-proto\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"http\"</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"body\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"isBase64Encoded\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Next, I enabled <a href=\"https://docs.aws.amazon.com/en_pv/elasticloadbalancing/latest/application/lambda-functions.html#multi-value-headers\">multi-value headers</a> to see how that changes the JSON structure.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 459px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/df19a947546b782a0af63a40e738bbd2/48711/multi-value-headers.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 28.37837837837838%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsSAAALEgHS3X78AAAAq0lEQVQY04VR0QqEMAzb//+agogvwmA4RedEN31QUZg5WhA8D89AKKVZSTqRpinyPGdu2wbCcRx/eddcIay16LqOue87C0IIP8IraH7vT4q7+Fy0LAuklKjrGmVZclVKoWkannvvobUGGToNEMVTJHLbti2GYeBHfd/DGMM9YV1XTNOEeZ6/Iz/d5w3jOCJJEmRZhjiOEUURp3iM/PYp5KyqKl5CtSgKOOfwAXzq0hImnuFbAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"ALB Multi value headers Enabled\"\n        title=\"ALB Multi value headers Enabled\"\n        src=\"/static/df19a947546b782a0af63a40e738bbd2/48711/multi-value-headers.png\"\n        srcset=\"/static/df19a947546b782a0af63a40e738bbd2/12f09/multi-value-headers.png 148w,\n/static/df19a947546b782a0af63a40e738bbd2/e4a3f/multi-value-headers.png 295w,\n/static/df19a947546b782a0af63a40e738bbd2/48711/multi-value-headers.png 459w\"\n        sizes=\"(max-width: 459px) 100vw, 459px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>I hit <code class=\"language-text\">/whatismyip</code> again but received <strong>502 Bad Gateway</strong> instead of an IP address.  Looking at the CloudWatch logs, I found this <code class=\"language-text\">KeyError</code> related to <code class=\"language-text\">&#39;headers&#39;</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>ERROR<span class=\"token punctuation\">]</span> KeyError: <span class=\"token string\">'headers'</span>\nTraceback <span class=\"token punctuation\">(</span>most recent call last<span class=\"token punctuation\">)</span>:\n  File <span class=\"token string\">\"/var/task/lambda_function.py\"</span>, line <span class=\"token number\">16</span>, <span class=\"token keyword\">in</span> lambda_handler\n    sourceip_list <span class=\"token operator\">=</span> event<span class=\"token punctuation\">[</span><span class=\"token string\">'headers'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">'x-forwarded-for'</span><span class=\"token punctuation\">]</span>.split<span class=\"token punctuation\">(</span><span class=\"token string\">','</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>My problem is that I didn’t read the documentation about field names being different.</p>\n<blockquote>\n<p>The names of the fields used for headers differ depending on whether you enable multi-value headers for the target group. You must use multiValueHeaders if you have enabled multi-value headers and headers otherwise.</p>\n</blockquote>\n<p>I instead needed to check <code class=\"language-text\">event[&#39;multiValueHeaders&#39;][&#39;x-forwarded-for&#39;][0]</code> for the IP address.  However, after that change, things still didn’t work as expected: The IP didn’t appear in the browser window but was download as a file.  When I used Chrome Developer Tools to inspect the HTTP Response Headers, I saw that <code class=\"language-text\">Content-Type</code> was <code class=\"language-text\">application/octet-stream</code> and not the <code class=\"language-text\">text/plain</code> required.</p>\n<div class=\"gatsby-highlight\" data-language=\"http\"><pre class=\"language-http\"><code class=\"language-http\"><span class=\"token response-status\">HTTP/1.1 <span class=\"token property\">200 OK</span></span>\n<span class=\"token header-name keyword\">Server:</span> awselb/2.0\n<span class=\"token header-name keyword\">Date:</span> Fri, 25 Oct 2019 20:00:04 GMT\n<span class=\"token header-name keyword\">Content-Type:</span> application/octet-stream\n<span class=\"token header-name keyword\">Content-Length:</span> 15\n<span class=\"token header-name keyword\">Connection:</span> keep-alive</code></pre></div>\n<p>When multi-value headers are enabled, it affects <strong>both</strong> the Request and Response headers structures.  I need to use <code class=\"language-text\">multiValueHeaders</code> instead of <code class=\"language-text\">headers</code> and set <code class=\"language-text\">Content-Type</code> to the string array <code class=\"language-text\">[&quot;text/plain;&quot;]</code></p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">  response <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\"># ...</span>\n    <span class=\"token string\">\"multiValueHeaders\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token string\">\"Content-Type\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"text/plain;\"</span><span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token comment\"># ...</span>\n  <span class=\"token punctuation\">}</span></code></pre></div>\n<p><strong>Note:</strong> This behavior is different that a similar feature of API Gateway. According to the <a href=\"https://aws.amazon.com/blogs/compute/support-for-multi-value-parameters-in-amazon-api-gateway/\">Support for multi-value parameters in Amazon API Gateway</a> blog post:</p>\n<blockquote>\n<p>You can also pass the header key along with the multiValueHeaders key. In that case, API Gateway merges the multiValueHeaders and headers maps while processing the integration response into a single Map&#x3C;String, List<String>> value. If the same key-value pair is sent in both, it isn’t duplicated.</p>\n</blockquote>\n<p>Enabling multi-value headers in AWS ALB also affects the query string event structure.  Calling <code class=\"language-text\">/browser?a=1&amp;a=2</code> when enabled produces an event that contains an array of values under <code class=\"language-text\">multiValueQueryStringParameters</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\">  <span class=\"token property\">\"path\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"/browser\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"multiValueQueryStringParameters\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"a\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token string\">\"1\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">\"2\"</span>\n    <span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"multiValueHeaders\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span></code></pre></div>\n<p>Calling <code class=\"language-text\">/browser?a=1&amp;a=2</code> when not enabled yields only the last value or <code class=\"language-text\">a</code> under the <code class=\"language-text\">queryStringParameters</code> key.</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\">  <span class=\"token property\">\"path\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"/browser\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"queryStringParameters\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"a\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2\"</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"headers\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span></code></pre></div>\n<p>For a production workload, I would probably look to a Python web framework to abstract these details for me.  I was hoping <a href=\"https://chalice.readthedocs.io/en/latest/\">AWS Chalice</a> would work, but as of now, it only supports “Amazon API Gateway and AWS Lambda” and not AWS ALBs.  Maybe it’s time to open a GitHub issue on <a href=\"https://github.com/aws/chalice\">aws/chalice</a> and ask about the roadmap?</p>","frontmatter":{"title":"AWS ALB, Lambda Function Targets, and Multi-Value Headers","description":null,"date":"October 25, 2019","tags":["aws","http","python"],"canonical":null}}},"pageContext":{"slug":"/2019-10-25-aws-alb-lambda-function-targets-and-multi-value-headers","previous":{"fields":{"slug":"/2019-09-06-veracode-api-hmac-authentication-in-python"},"frontmatter":{"tags":["security","codequality","python"]}},"next":{"fields":{"slug":"/2019-12-05-exam-az-900-microsoft-azure-fundamentals"},"frontmatter":{"tags":["azure","career"]}}}},"staticQueryHashes":["2589769190","3567236516"]}