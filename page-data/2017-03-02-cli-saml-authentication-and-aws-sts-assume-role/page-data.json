{"componentChunkName":"component---src-templates-blog-post-js","path":"/2017-03-02-cli-saml-authentication-and-aws-sts-assume-role","webpackCompilationHash":"ea9e41e646c8f86c1300","result":{"data":{"site":{"siteMetadata":{"title":"kevinhakanson.com","author":"Kevin Hakanson"}},"markdownRemark":{"id":"de369d07-e3b6-586e-86c8-dc519c73b12b","excerpt":"When I run a CLI based SAML log in (using an internal tool), I can select from the roles available to my account (e.g., PowerUser or ReadOnly).  I think of…","html":"<p>When I run a CLI based SAML log in (using an internal tool), I can select from the roles available to my account (e.g., PowerUser or ReadOnly).  I think of these as user roles.  However, IAM roles can also be created and assigned to EC2 instances or Lambda functions.  I was trying to understand how local code could run under one of those specific IAM roles.  I decided to try out <a href=\"http://docs.aws.amazon.com/cli/latest/reference/sts/assume-role.html\">assume-role — AWS CLI 1.11.56 Command Reference</a>:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ aws sts assume-role <span class=\"token punctuation\">\\</span>\n--role-arn arn:aws:iam::123456789012:role/kjh-s3-encryption-test1-role <span class=\"token punctuation\">\\</span>\n--role-session-name cli-kjh-s3-encryption-test1-role\n\nAn error occurred <span class=\"token punctuation\">(</span>AccessDenied<span class=\"token punctuation\">)</span> when calling the AssumeRole operation: User: arn:aws:sts::123456789012:assumed-role/PowerUser/kevin.hakanson@example.com is not authorized to perform: sts:AssumeRole on resource: arn:aws:iam::123456789012:role/kjh-s3-encryption-test1-role</code></pre></div>\n<p>As you can see, that didn’t work.  <code class=\"language-text\">PowerUser</code> has the authority to <code class=\"language-text\">sts:AssumeRole</code>, but I had to add myself to that role policy so my specific <code class=\"language-text\">Principal</code> could assume <code class=\"language-text\">kjh-s3-encryption-test1-role</code>.  The default was to only allow the EC2 service to do this.  You can see the full policy below.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ aws iam get-role --role kjh-s3-encryption-test1-role\n\n<span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"Role\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"AssumeRolePolicyDocument\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"Version\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2012-10-17\"</span>,\n            <span class=\"token string\">\"Statement\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span>\n                <span class=\"token punctuation\">{</span>\n                    <span class=\"token string\">\"Action\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"sts:AssumeRole\"</span>,\n                    <span class=\"token string\">\"Effect\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"Allow\"</span>,\n                    <span class=\"token string\">\"Principal\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n                        <span class=\"token string\">\"Service\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"ec2.amazonaws.com\"</span>\n                    <span class=\"token punctuation\">}</span>\n                <span class=\"token punctuation\">}</span>,\n                <span class=\"token punctuation\">{</span>\n                    <span class=\"token string\">\"Action\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"sts:AssumeRole\"</span>,\n                    <span class=\"token string\">\"Effect\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"Allow\"</span>,\n                    <span class=\"token string\">\"Principal\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n                        <span class=\"token string\">\"AWS\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"arn:aws:sts::123456789012:assumed-role/PowerUser/kevin.hakanson@example.com\"</span>\n                    <span class=\"token punctuation\">}</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">]</span>\n        <span class=\"token punctuation\">}</span>,\n        <span class=\"token string\">\"RoleId\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"AROAXXXXXXXXXXXXXXXXX\"</span>,\n        <span class=\"token string\">\"CreateDate\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2016-08-13T16:31:08Z\"</span>,\n        <span class=\"token string\">\"RoleName\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"kjh-s3-encryption-test1-role\"</span>,\n        <span class=\"token string\">\"Path\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"/\"</span>,\n        <span class=\"token string\">\"Arn\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"arn:aws:iam::123456789012:role/kjh-s3-encryption-test1-role\"</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>After that change, I was able to perform an <code class=\"language-text\">AssumeRole</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ aws sts assume-role <span class=\"token punctuation\">\\</span>\n--role-arn arn:aws:iam::123456789012:role/kjh-s3-encryption-test1-role <span class=\"token punctuation\">\\</span>\n--role-session-name cli-kjh-s3-encryption-test1-role\n\n<span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"AssumedRoleUser\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"AssumedRoleId\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"AROAXXXXXXXXXXXXXXXXX:cli-kjh-s3-encryption-test1-role\"</span>,\n        <span class=\"token string\">\"Arn\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"arn:aws:sts::123456789012:assumed-role/kjh-s3-encryption-test1-role/cli-kjh-s3-encryption-test1-role\"</span>\n    <span class=\"token punctuation\">}</span>,\n    <span class=\"token string\">\"Credentials\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"SecretAccessKey\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"&lt;secret>\"</span>,\n        <span class=\"token string\">\"SessionToken\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"&lt;token>\"</span>,\n        <span class=\"token string\">\"Expiration\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2017-03-01T22:41:37Z\"</span>,\n        <span class=\"token string\">\"AccessKeyId\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"ASIAXXXXXXXXXXXXXXXX\"</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>However, this wasn’t as useful as I thought, since I would also need to create a profile and copy those credentials into my  <code class=\"language-text\">~/.aws/credentials</code> file.  Luckily, I discovered <a href=\"http://docs.aws.amazon.com/cli/latest/userguide/cli-roles.html\">Assuming a Role - AWS Command Line Interface</a> and just added a new profile section to my <code class=\"language-text\">~/.aws/config</code> that referenced that role ARN and my <code class=\"language-text\">saml</code> profile.</p>\n<div class=\"gatsby-highlight\" data-language=\"ini\"><pre class=\"language-ini\"><code class=\"language-ini\"><span class=\"token selector\">[profile kjh-s3-encryption-test1-role]</span>\n<span class=\"token constant\">role_arn</span> <span class=\"token attr-value\"><span class=\"token punctuation\">=</span> arn:aws:iam::123456789012:role/kjh-s3-encryption-test1-role</span>\n<span class=\"token constant\">source_profile</span> <span class=\"token attr-value\"><span class=\"token punctuation\">=</span> saml</span></code></pre></div>\n<p>After that, I was able to automatically assume that role with the CLI by specifying my new profile.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ aws s3api --profile kjh-s3-encryption-test1-role list-objects <span class=\"token punctuation\">\\</span>\n--bucket kjh-encryption-test1 <span class=\"token punctuation\">\\</span>\n--prefix cli-s3api-kms/\n\n<span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"Contents\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"LastModified\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2016-12-06T21:02:16.000Z\"</span>,\n            <span class=\"token string\">\"ETag\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>f3a07b31bc1cee5e70b6f0bbd9c5bf09<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>\"</span>,\n            <span class=\"token string\">\"StorageClass\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"STANDARD\"</span>,\n            <span class=\"token string\">\"Key\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"cli-s3api-kms/QBF.txt.enc\"</span>,\n            <span class=\"token string\">\"Size\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">45</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Interestingly, when I run that same command with my <code class=\"language-text\">saml</code> profile, I got a different result:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ aws s3api --profile saml list-objects <span class=\"token punctuation\">\\</span>\n--bucket kjh-encryption-test1 <span class=\"token punctuation\">\\</span>\n--prefix cli-s3api-kms/\n\n<span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"Contents\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"LastModified\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2016-12-06T21:02:16.000Z\"</span>,\n            <span class=\"token string\">\"ETag\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>f3a07b31bc1cee5e70b6f0bbd9c5bf09<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>\"</span>,\n            <span class=\"token string\">\"StorageClass\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"STANDARD\"</span>,\n            <span class=\"token string\">\"Key\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"cli-s3api-kms/QBF.txt.enc\"</span>,\n            <span class=\"token string\">\"Owner\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token string\">\"DisplayName\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"redacted\"</span>,\n                <span class=\"token string\">\"ID\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"redacted\"</span>\n            <span class=\"token punctuation\">}</span>,\n            <span class=\"token string\">\"Size\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">45</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Seeing the difference was the <code class=\"language-text\">Owner</code>, I added <code class=\"language-text\">s3:GetObjectAcl</code> to my policy using the AWS Console UI.  After that, I got the same result using either profile.  I also learned that if you want to see the policy document from the CLI, <code class=\"language-text\">get-policy</code> doesn’t give you that information…</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ aws iam get-policy --policy-arn arn:aws:iam::123456789012:policy/kjh-s3-encryption-test1\n\n<span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"Policy\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"PolicyName\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"kjh-s3-encryption-test1\"</span>,\n        <span class=\"token string\">\"CreateDate\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2016-08-12T22:55:52Z\"</span>,\n        <span class=\"token string\">\"AttachmentCount\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,\n        <span class=\"token string\">\"IsAttachable\"</span><span class=\"token builtin class-name\">:</span> true,\n        <span class=\"token string\">\"PolicyId\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"ANPAXXXXXXXXXXXXXXXXX\"</span>,\n        <span class=\"token string\">\"DefaultVersionId\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"v5\"</span>,\n        <span class=\"token string\">\"Path\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"/\"</span>,\n        <span class=\"token string\">\"Arn\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"arn:aws:iam::123456789012:policy/kjh-s3-encryption-test1\"</span>,\n        <span class=\"token string\">\"UpdateDate\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2017-03-01T22:15:36Z\"</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">..</span>. so you need to use <span class=\"token variable\"><span class=\"token variable\">`</span>get-policy-version<span class=\"token variable\">`</span></span> with the version <span class=\"token function\">id</span> to get that policy document.\n\n```console\n$ aws iam get-policy-version <span class=\"token punctuation\">\\</span>\n--policy-arn arn:aws:iam::123456789012:policy/kjh-s3-encryption-test1 <span class=\"token punctuation\">\\</span>\n--version-id v5\n\n<span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"PolicyVersion\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"CreateDate\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2017-03-01T22:15:36Z\"</span>,\n        <span class=\"token string\">\"VersionId\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"v5\"</span>,\n        <span class=\"token string\">\"Document\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"Version\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2012-10-17\"</span>,\n            <span class=\"token string\">\"Statement\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span>\n                <span class=\"token punctuation\">{</span>\n                    <span class=\"token string\">\"Action\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span>\n                        <span class=\"token string\">\"s3:DeleteObject\"</span>,\n                        <span class=\"token string\">\"s3:GetObject\"</span>,\n                        <span class=\"token string\">\"s3:PutObject\"</span>,\n                        <span class=\"token string\">\"s3:GetObjectAcl\"</span>\n                    <span class=\"token punctuation\">]</span>,\n                    <span class=\"token string\">\"Resource\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span>\n                        <span class=\"token string\">\"arn:aws:s3:::kjh-encryption-test1/*\"</span>\n                    <span class=\"token punctuation\">]</span>,\n                    <span class=\"token string\">\"Effect\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"Allow\"</span>\n                <span class=\"token punctuation\">}</span>,\n                <span class=\"token punctuation\">{</span>\n                    <span class=\"token string\">\"Action\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span>\n                        <span class=\"token string\">\"s3:ListBucket\"</span>\n                    <span class=\"token punctuation\">]</span>,\n                    <span class=\"token string\">\"Resource\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span>\n                        <span class=\"token string\">\"arn:aws:s3:::kjh-encryption-test1\"</span>\n                    <span class=\"token punctuation\">]</span>,\n                    <span class=\"token string\">\"Effect\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"Allow\"</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">]</span>\n        <span class=\"token punctuation\">}</span>,\n        <span class=\"token string\">\"IsDefaultVersion\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token boolean\">true</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Hopefully, this will allow me to better understand and change IAM policies in order to apply the <a href=\"https://en.wikipedia.org/wiki/Principle_of_least_privilege\">Principle of least privilege</a> and only grant the specific actions required.</p>","frontmatter":{"title":"CLI SAML Authentication and AWS STS assume-role","date":"March 02, 2017","tags":["aws","iam","cli"]}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/2017-03-02-cli-saml-authentication-and-aws-sts-assume-role","previous":{"fields":{"slug":"/2017-02-15-monotonic-time-in-javascript"},"frontmatter":{"tags":["aws","xray","javascript","monitoring"]}},"next":{"fields":{"slug":"/2017-03-08-aws-request-ids"},"frontmatter":{"tags":["aws","http","monitoring"]}}}}}