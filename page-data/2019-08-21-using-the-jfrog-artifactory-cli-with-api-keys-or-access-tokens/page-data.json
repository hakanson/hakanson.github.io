{"componentChunkName":"component---src-templates-blog-post-js","path":"/2019-08-21-using-the-jfrog-artifactory-cli-with-api-keys-or-access-tokens","webpackCompilationHash":"aaf2e98adf17fa9c33ba","result":{"data":{"site":{"siteMetadata":{"title":"kevinhakanson.com","author":"Kevin Hakanson"}},"markdownRemark":{"id":"c82021a8-72fc-53fe-8952-134e9b6725b8","excerpt":"I received early adopter access to our JFrog Artifactory instances located at https://tr1.jfrog.io.  After you log in via SSO you are redirected to https://tr…","html":"<p>I received early adopter access to our <a href=\"https://jfrog.com/artifactory/\">JFrog Artifactory</a> instances located at <a href=\"https://tr1.jfrog.io/\">https://tr1.jfrog.io</a>.  After you log in via SSO you are redirected to <a href=\"https://tr1.jfrog.io/tr1/webapp/#/home\">https://tr1.jfrog.io/tr1/webapp/#/home</a> (note that <code class=\"language-text\">/tr1/</code> path segment as this is needed for API URLs).  I wanted to try CLI access so I started with a simple unauthenticated ”<a href=\"https://www.jfrog.com/confluence/display/RTF/Artifactory+REST+API#ArtifactoryRESTAPI-SystemHealthPing\">ping</a>” using <code class=\"language-text\">curl</code> against the REST API using <a href=\"https://curl.haxx.se/docs/manpage.html#-s\">-s</a> for “silent mode” and <a href=\"https://curl.haxx.se/docs/manpage.html#-i\">-i</a> to include HTTP response header is output, but limit to the first line by piping through <code class=\"language-text\">head</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">curl</span> -s -i https://tr1.jfrog.io/tr1/api/system/ping <span class=\"token operator\">|</span> <span class=\"token function\">head</span> -n <span class=\"token number\">1</span>\nHTTP/1.1 <span class=\"token number\">200</span> OK</code></pre></div>\n<p>Success. Let’s try some negative testing of my user but with an invalid API key.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">curl</span> -s -i -u <span class=\"token string\">\"0038137:INVALID_APIKEY\"</span> <span class=\"token punctuation\">\\</span>\nhttps://tr1.jfrog.io/tr1/api/system/ping <span class=\"token operator\">|</span> <span class=\"token function\">head</span> -n <span class=\"token number\">1</span>\nHTTP/1.1 <span class=\"token number\">401</span> Unauthorized</code></pre></div>\n<p>Now let’s grab my API key and try again.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 288px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/94e55ca4dfb7dc82e2d7bccb5aee81e1/337b6/Screen%2BShot%2B2019-08-20%2Bat%2B6.00.29%2BPM.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 49.30555555555556%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAABT0lEQVQoz52Q7UoCQRiF99YsqksIKsSoxCiQpIKupfrZj8gkiqILsGiLQjTxf+aq+zUfuN+6p50hQWiLpXd4OGdm4HB4lY1aEbvXZWzVSijfVFC62kGhuonc8QJyJ4uYS5g/XcqMUrzcxuH9kQzdu91H5e5A+nx1HWsXBaye57F8tpIZpdVp4elVReO9AfXtGXX1Ac12E/XHOtQXFe1OG4RTEEYyoXQ/uhj0B6CEwjJMDAdDWKaF3mcPWk+DaZqIwhBhkA3FMAzEyWGMgXOO0WgklXGGyWQCMUJTib+ZuSu6riMIAohggW3bMtCyLPn+18Rx/AMZKNKnDV3Xhef78BOEdxwnFfE3bRZFkUR4GSiSGU0CGZc6hRDyK6JAmOxWrEh4SqksoRi6ASdyoPE+iEdAPQrbtaX+Z2TDcTyGEzjwIx9eQjAOpKbtaJa0PX4BnUbG4JcD9fsAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"JFrog Artifactory API Key\"\n        title=\"JFrog Artifactory API Key\"\n        src=\"/static/94e55ca4dfb7dc82e2d7bccb5aee81e1/337b6/Screen%2BShot%2B2019-08-20%2Bat%2B6.00.29%2BPM.png\"\n        srcset=\"/static/94e55ca4dfb7dc82e2d7bccb5aee81e1/cf440/Screen%2BShot%2B2019-08-20%2Bat%2B6.00.29%2BPM.png 148w,\n/static/94e55ca4dfb7dc82e2d7bccb5aee81e1/337b6/Screen%2BShot%2B2019-08-20%2Bat%2B6.00.29%2BPM.png 288w\"\n        sizes=\"(max-width: 288px) 100vw, 288px\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">curl</span> -s -i -u <span class=\"token string\">\"0038137:REDACTED_APIKEY\"</span> <span class=\"token punctuation\">\\</span>\nhttps://tr1.jfrog.io/tr1/api/system/ping <span class=\"token operator\">|</span> <span class=\"token function\">head</span> -n <span class=\"token number\">1</span>\nHTTP/1.1 <span class=\"token number\">200</span> OK</code></pre></div>\n<p>Notice that I’ve replaced my real API Key with REDACTED_APIKEY above.  Using the real API Key works, but it is long, hard to type, and using it that way exposes it to someone looking in my <code class=\"language-text\">.bash_history</code> file.</p>\n<p>Let’s switch to using the <a href=\"https://www.jfrog.com/confluence/display/CLI/JFrog+CLI\">JFrog CLI</a> and see how that works with my API Key.  Visit the documentation site for full install instructions, including auto-completion scripts.  This CLI works with multiple JFrog products, and <code class=\"language-text\">rt</code> is the target argument for JFrog Artifactory.  The <a href=\"https://www.jfrog.com/confluence/display/CLI/CLI+for+JFrog+Artifactory#CLIforJFrogArtifactory-Configuration\">config</a> command will create a <code class=\"language-text\">~/.jfrog/jfrog-cli.conf</code> file that is used for other CLI commands.  For the command history reason above, I recommend not to use the <code class=\"language-text\">--apikey</code> parameter and enter your API Key in interactive mode.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ jfrog --version\njfrog version <span class=\"token number\">1.27</span>.0\n\n$ jfrog rt config --url https://tr1.jfrog.io/tr1/ --user 0038137\nArtifactory server ID: tr1\nAccess token <span class=\"token punctuation\">(</span>Leave blank <span class=\"token keyword\">for</span> username and password/API key<span class=\"token punctuation\">)</span>: \nPassword/API key: \n<span class=\"token punctuation\">[</span>Info<span class=\"token punctuation\">]</span> Encrypting password<span class=\"token punctuation\">..</span>.</code></pre></div>\n<p>Similar to the REST API, the JFrog CLI supports a <a href=\"https://www.jfrog.com/confluence/display/CLI/CLI+for+JFrog+Artifactory#CLIforJFrogArtifactory-VerifyingArtifactoryisAccessible\">ping command</a> to verify that Artifactory is accessible.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ jfrog rt <span class=\"token function\">ping</span>\nOK</code></pre></div>\n<p>Taking a peek at the config file, you can see the API Key was stored in the “password” field during the interactive flow.  </p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">cat</span> ~/.jfrog/jfrog-cli.conf\n<span class=\"token punctuation\">{</span>\n  <span class=\"token string\">\"artifactory\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token string\">\"url\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"https://tr1.jfrog.io/tr1/\"</span>,\n      <span class=\"token string\">\"user\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"0038137\"</span>,\n      <span class=\"token string\">\"password\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"REDACTED_APIKEY\"</span>,\n      <span class=\"token string\">\"serverId\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"tr1\"</span>,\n      <span class=\"token string\">\"isDefault\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token boolean\">true</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">]</span>,\n  <span class=\"token string\">\"Version\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>There is also a <a href=\"https://www.jfrog.com/confluence/display/CLI/CLI+for+JFrog+Artifactory#CLIforJFrogArtifactory-RunningcUrl\">Running cUrl</a> feature to invoke REST APIs not available in the JFrog CLI.  That takes the same arguments as native curl but uses a shortened REST API path and automatically includes login credentials.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ jfrog rt <span class=\"token function\">curl</span> -X GET /api/system/ping\nOK</code></pre></div>\n<p>If you really love complicated command lines, you could inject your API Key from the config file using <code class=\"language-text\">jq</code> and still execute <code class=\"language-text\">curl</code> yourself.  Have fun!</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ jq -r <span class=\"token string\">\".artifactory[0].password\"</span> ~/.jfrog/jfrog-cli.conf\nREDACTED_APIKEY\n\n$ <span class=\"token function\">curl</span> -s -i <span class=\"token punctuation\">\\</span>\n-u <span class=\"token string\">\"0038137:<span class=\"token variable\"><span class=\"token variable\">$(</span>jq -r <span class=\"token string\">\".artifactory[0].password\"</span> ~/.jfrog/jfrog-cli.conf<span class=\"token variable\">)</span></span>\"</span> <span class=\"token punctuation\">\\</span>\nhttps://tr1.jfrog.io/tr1/api/system/ping <span class=\"token operator\">|</span> <span class=\"token function\">head</span> -n <span class=\"token number\">1</span>\nHTTP/1.1 <span class=\"token number\">200</span> OK</code></pre></div>\n<p>Now let’s trying something that is unique to my user by calling the REST API to <a href=\"https://www.jfrog.com/confluence/display/RTF/Artifactory+REST+API#ArtifactoryRESTAPI-GetAPIKey\">Get API Key</a>.  This should echo back the same REDACTED_APIKEY I have in my config file.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ jfrog rt <span class=\"token function\">curl</span> -X GET /api/security/apiKey\n<span class=\"token punctuation\">{</span><span class=\"token string\">\"apiKey\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"REDACTED_APIKEY\"</span><span class=\"token punctuation\">}</span></code></pre></div>\n<p>For my CI/CD pipelines, I don’t really want my personal API Key being used.  Luckily, JFrog also supports <a href=\"https://www.jfrog.com/confluence/display/ACC/Access+Tokens\">Access Tokens</a> “as a flexible means of authentication with a wide range of capabilities” including:</p>\n<blockquote>\n<ul>\n<li><strong>User and non-user authentication</strong><br>\nThe case for authenticating users is clear, however access tokens can also be assigned to non-user entities such as CI server jobs.</li>\n<li><strong>Flexible scope</strong><br>\nBy assigning Groups to tokens, you can control the level of access they provide.</li>\n</ul>\n</blockquote>\n<p>Let’s create an access token that is valid for the next 90 seconds and then configure a <code class=\"language-text\">tr1token</code> entry in our config file.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ jfrog rt <span class=\"token function\">curl</span> -X POST /api/security/token <span class=\"token punctuation\">\\</span>\n-d <span class=\"token string\">\"username=0038137\"</span> <span class=\"token punctuation\">\\</span>\n-d <span class=\"token string\">\"scope=member-of-groups:readers\"</span> <span class=\"token punctuation\">\\</span>\n-d <span class=\"token string\">\"expires_in=90\"</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token string\">\"scope\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"member-of-groups:readers api:*\"</span>,\n  <span class=\"token string\">\"access_token\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"REDACTED_TOKEN\"</span>,\n  <span class=\"token string\">\"expires_in\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">90</span>,\n  <span class=\"token string\">\"token_type\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"Bearer\"</span>\n<span class=\"token punctuation\">}</span>\n\n$ jfrog rt config --url https://tr1.jfrog.io/tr1/ --user 0038137\nArtifactory server ID <span class=\"token punctuation\">[</span>tr1<span class=\"token punctuation\">]</span>: tr1token\nAccess token <span class=\"token punctuation\">(</span>Leave blank <span class=\"token keyword\">for</span> username and password/API key<span class=\"token punctuation\">)</span>: </code></pre></div>\n<p>Quickly use the token with a ping command specifying the <code class=\"language-text\">tr1token</code> config, then wait for 90 seconds for the token to expire and execute another ping command.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ jfrog rt <span class=\"token function\">ping</span> --server-id tr1token\nOK\n\n$ <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"wait 90 seconds\"</span>\n<span class=\"token function\">wait</span> <span class=\"token number\">90</span> seconds\n\n$ jfrog rt <span class=\"token function\">ping</span> --server-id tr1token\n<span class=\"token punctuation\">[</span>Error<span class=\"token punctuation\">]</span> Artifactory response: <span class=\"token number\">401</span> Unauthorized\n<span class=\"token punctuation\">{</span>\n  <span class=\"token string\">\"errors\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token string\">\"status\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">401</span>,\n      <span class=\"token string\">\"message\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"Token failed verification: expired\"</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>When you inspect the JWT payload data from that token, you can see the <code class=\"language-text\">exp</code> time.</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"sub\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"jfrt@01dc27m2makwbg11a8k5sr05z2/users/0038137\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"scp\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"member-of-groups:readers api:*\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"aud\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"jfrt@01dc27m2makwbg11a8k5sr05z2\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"iss\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"jfrt@01dc27m2makwbg11a8k5sr05z2\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"exp\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1566405855</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"iat\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1566405765</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"jti\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"47e178d6-0263-4c13-969c-087f79a07a02\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Unfortunately, this still is an Access Token tied to my user account.  There is a way for Admin Users to create Access Token for “non-user entities such as CI server jobs” (mentioned above), so I need to work with our JFrog Artifactory admin to figure out the best way to move forward.</p>","frontmatter":{"title":"Using the JFrog Artifactory CLI with API Keys or Access Tokens","date":"August 21, 2019","tags":["devops","cli","security"]}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/2019-08-21-using-the-jfrog-artifactory-cli-with-api-keys-or-access-tokens","previous":{"fields":{"slug":"/2019-08-12-scanning-for-ows-sql-injection-protection"},"frontmatter":{"tags":["security","codequality","devops","powershell"]}},"next":null}}}