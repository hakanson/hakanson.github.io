{"componentChunkName":"component---src-templates-blog-post-js","path":"/2018-06-27-making-a-secure-connection-to-elasticache-redis/","result":{"data":{"site":{"siteMetadata":{"title":"kevinhakanson.com","author":"Kevin Hakanson"}},"markdownRemark":{"id":"4c086e1d-d039-5859-8a91-daaeb21fbd14","excerpt":"In Redis Security Investigation, I recommended enabling both Encryption in-transit and Redis Auth.  Below is an ElastiCache Redis server I created to test…","html":"<p>In <a href=\"../2018-06-22-redis-security-investigation\">Redis Security Investigation</a>, I recommended enabling both Encryption in-transit and Redis Auth.  Below is an ElastiCache Redis server I created to test against.  Note that instead of port 6379, I specified 6380 (which seems to be the common Redis “SSL” port).</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/0bace684c26c851bf3763ce568a6eeff/29114/pastedImage_2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 38.513513513513516%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABIUlEQVR42m1R127DMBDz/3+fUW/JtRTvleGRJ8a8VkYT9IEQpOOR1J1njMVXEEF/F2iaBlVVIU1TGGOglBJorRFFEfI8h8oVCmvkLUmS82S9rmt4ddNC2xaJLkSsbVt0XYd5nnG9XjGOI/q+l3d7mIcqhjK5GJZlicvlIkHIv9/v8EjOtTqgxYEECj0eDyFs2ybYt13O5pdDgWVZhLeu6w9n34+EB8FaKyS68s6ENCJcg4NwmhrTNGFZl7eaCLIpCALEcSxidGXBJfvbwJqbrwged8dzfd7z+URRFCJI8WEY3kQcmJQLCsNQlpNlmZxufmdCfpUJuSk2sPiZjLjdbpLO933ZLBfIlJyzG8s5Q6Yjien4+F9CmrCRQty8W8Lnl1/Kwllod5VMqgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Redis Cluster Information\"\n        title=\"\"\n        src=\"/static/0bace684c26c851bf3763ce568a6eeff/fcda8/pastedImage_2.png\"\n        srcset=\"/static/0bace684c26c851bf3763ce568a6eeff/12f09/pastedImage_2.png 148w,\n/static/0bace684c26c851bf3763ce568a6eeff/e4a3f/pastedImage_2.png 295w,\n/static/0bace684c26c851bf3763ce568a6eeff/fcda8/pastedImage_2.png 590w,\n/static/0bace684c26c851bf3763ce568a6eeff/efc66/pastedImage_2.png 885w,\n/static/0bace684c26c851bf3763ce568a6eeff/c83ae/pastedImage_2.png 1180w,\n/static/0bace684c26c851bf3763ce568a6eeff/29114/pastedImage_2.png 1920w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>However, the <code class=\"language-text\">redis-cli</code> doesn’t support encrypted connections so I had to install <code class=\"language-text\">stunnel</code> with help from <a href=\"https://help.compose.com/docs/redis-and-redis-cli#section-using-redis-cli-with-ssltls\">Using redis-cli with SSL/TLS | Compose Help</a> and <a href=\"https://docs.microsoft.com/en-us/azure/redis-cache/cache-how-to-redis-cli-tool\">How to use redis-cli with Azure Redis Cache | Microsoft Docs</a> to create my <code class=\"language-text\">stunnel.conf</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">cat</span> /etc/stunnel/stunnel.conf\r\npid <span class=\"token operator\">=</span> /run/stunnel-redis.pid\r\n\r\n<span class=\"token punctuation\">[</span>redis-cli<span class=\"token punctuation\">]</span>\r\nclient <span class=\"token operator\">=</span> <span class=\"token function\">yes</span>\r\naccept <span class=\"token operator\">=</span> <span class=\"token number\">127.0</span>.0.1:6379\r\nconnect <span class=\"token operator\">=</span> master.a204503-kjh-auth.jbfxlf.use1.cache.amazonaws.com:6380</code></pre></div>\n<p>This allowed me to connect to localhost:6379 which would be an SSL proxy to the remote Redis server.  You can also see the connection is refused without the proper AUTH token.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ redis-cli <span class=\"token parameter variable\">-h</span> <span class=\"token number\">127.0</span>.0.1 <span class=\"token parameter variable\">-p</span> <span class=\"token number\">6379</span> <span class=\"token function\">ping</span>\r\n<span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> NOAUTH Authentication required.\r\n\r\n$ redis-cli <span class=\"token parameter variable\">-h</span> <span class=\"token number\">127.0</span>.0.1 <span class=\"token parameter variable\">-p</span> <span class=\"token number\">6379</span> <span class=\"token parameter variable\">-a</span> <span class=\"token punctuation\">[</span>REDACTED<span class=\"token punctuation\">]</span> <span class=\"token function\">ping</span>\r\nPONG</code></pre></div>\n<p>Note: [REDACTED] isn’t my real AUTH token. See <a href=\"../2018-06-27-selecting-an-elasticache-redis-auth-token\">Selecting an ElastiCache (Redis) AUTH token</a> for recommendations on this topic.</p>\n<p>To show this is the server from the screenshot above, here are some select lines from the <code class=\"language-text\">info</code> command:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ redis-cli <span class=\"token parameter variable\">-h</span> <span class=\"token number\">127.0</span>.0.1 <span class=\"token parameter variable\">-p</span> <span class=\"token number\">6379</span> <span class=\"token parameter variable\">-a</span> <span class=\"token punctuation\">[</span>REDACTED<span class=\"token punctuation\">]</span> info\r\n<span class=\"token comment\"># Server</span>\r\nredis_version:4.0.10\r\nredis_mode:standalone\r\nos:Amazon ElastiCache\r\ntcp_port:6380\r\n\r\n<span class=\"token comment\"># SSL</span>\r\nssl_enabled:yes</code></pre></div>\n<p><a href=\"https://help.compose.com/docs/redis-and-python\">Redis and Python | Compose Help</a> provided me with sample Python code I also tested with.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> redis\r\n\r\n<span class=\"token comment\"># connection string and initialization</span>\r\nr <span class=\"token operator\">=</span> redis<span class=\"token punctuation\">.</span>StrictRedis<span class=\"token punctuation\">(</span>\r\n    host<span class=\"token operator\">=</span><span class=\"token string\">'master.a204503-kjh-auth.jbfxlf.use1.cache.amazonaws.com'</span><span class=\"token punctuation\">,</span>\r\n    port<span class=\"token operator\">=</span><span class=\"token number\">6380</span><span class=\"token punctuation\">,</span>\r\n    password<span class=\"token operator\">=</span><span class=\"token string\">'[REDACTED]'</span><span class=\"token punctuation\">,</span>\r\n    ssl<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>\r\n<span class=\"token punctuation\">)</span>\r\n\r\n<span class=\"token comment\">#test the connection</span>\r\nvalue <span class=\"token operator\">=</span> r<span class=\"token punctuation\">.</span>info<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span></code></pre></div>\n<p>For Java users, Jedis can use the <a href=\"https://www.iana.org/assignments/uri-schemes/prov/rediss\">rediss</a> scheme to connect. Sample code derived from <a href=\"https://github.com/xetorthio/jedis/blob/master/src/test/java/redis/clients/jedis/tests/SSLJedisTest.java\">jedis/SSLJedisTest.java</a>.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">  <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">connectWithUrl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token comment\">// The \"rediss\" scheme instructs jedis to open a SSL/TLS connection.</span>\r\n    <span class=\"token class-name\">Jedis</span> jedis <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Jedis</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"rediss://master.a204503-kjh-auth.jbfxlf.use1.cache.amazonaws.com:6380\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    jedis<span class=\"token punctuation\">.</span><span class=\"token function\">auth</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"[REDACTED]\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token function\">assertEquals</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"PONG\"</span><span class=\"token punctuation\">,</span> jedis<span class=\"token punctuation\">.</span><span class=\"token function\">ping</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    jedis<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token punctuation\">}</span></code></pre></div>\n<p>For C# users, set <a href=\"https://stackexchange.github.io/StackExchange.Redis/Configuration.html\">StackExchange.Redis</a> ConfigurationOptions this way:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> options <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">ConfigurationOptions</span>\r\n<span class=\"token punctuation\">{</span>\r\n    Endpoint <span class=\"token operator\">=</span> <span class=\"token string\">\"master.a204503-kjh-auth.jbfxlf.use1.cache.amazonaws.com\"</span><span class=\"token punctuation\">,</span>\r\n    <span class=\"token comment\">// Endpoints without an explicit port will use 6379 if ssl is not enabled, and 6380 if ssl is enabled</span>\r\n    Password <span class=\"token operator\">=</span> <span class=\"token string\">\"[Redacted]\"</span><span class=\"token punctuation\">,</span>\r\n    Ssl <span class=\"token operator\">=</span> True\r\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>","frontmatter":{"title":"Making a secure connection to ElastiCache (Redis)","description":null,"date":"June 27, 2018","tags":["aws","redis","security","networking"],"canonical":null}}},"pageContext":{"slug":"/2018-06-27-making-a-secure-connection-to-elasticache-redis/","previous":{"fields":{"slug":"/2018-06-22-redis-security-investigation/"},"frontmatter":{"tags":["aws","redis","security"]}},"next":{"fields":{"slug":"/2018-06-27-selecting-an-elasticache-redis-auth-token/"},"frontmatter":{"tags":["aws","secretsmanager","redis","security"]}}}},"staticQueryHashes":["2589769190","97908498"],"slicesMap":{}}