{"componentChunkName":"component---src-templates-blog-post-js","path":"/2017-04-14-amazons3encryptionclient-example","result":{"data":{"site":{"siteMetadata":{"title":"kevinhakanson.com","author":"Kevin Hakanson"}},"markdownRemark":{"id":"bb3744d6-bd53-5954-9c21-9d1c2d92b905","excerpt":"The following code uses the  from the  to put an encrypted object into an S3 bucket. Note: When you view this object in the S3 console, it shows “Encryption” as…","html":"<p>The following code uses the <code class=\"language-text\">AmazonS3EncryptionClient</code> from the <code class=\"language-text\">aws-java-sdk</code> to put an encrypted object into an S3 bucket.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token class-name\">String</span> bucketName <span class=\"token operator\">=</span> <span class=\"token string\">\"kjh-encryption-test1\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\">String</span> objectKey  <span class=\"token operator\">=</span> <span class=\"token string\">\"sdk-s3/ExampleKMSEncryptedObject\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\">String</span> kms_cmk_id <span class=\"token operator\">=</span> <span class=\"token string\">\"79cce4f6-7e4d-42ab-9942-9e6bb05b6121\"</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//  \"kjh-encryption-s3\";</span>\n\n<span class=\"token class-name\">KMSEncryptionMaterialsProvider</span> materialProvider <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">KMSEncryptionMaterialsProvider</span><span class=\"token punctuation\">(</span>kms_cmk_id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nencryptionClient <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">AmazonS3EncryptionClient</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">ProfileCredentialsProvider</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> materialProvider<span class=\"token punctuation\">,</span>\n        <span class=\"token keyword\">new</span> <span class=\"token class-name\">CryptoConfiguration</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">withKmsRegion</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Regions</span><span class=\"token punctuation\">.</span>US_WEST_2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">withRegion</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Region</span><span class=\"token punctuation\">.</span><span class=\"token function\">getRegion</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Regions</span><span class=\"token punctuation\">.</span>US_WEST_2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Upload object using the encryption client.</span>\n<span class=\"token keyword\">byte</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> plaintext <span class=\"token operator\">=</span> <span class=\"token string\">\"Hello World, S3 Client-side Encryption Using KMS!\"</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">getBytes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"plaintext's length: \"</span> <span class=\"token operator\">+</span> plaintext<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nencryptionClient<span class=\"token punctuation\">.</span><span class=\"token function\">putObject</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">PutObjectRequest</span><span class=\"token punctuation\">(</span>bucketName<span class=\"token punctuation\">,</span> objectKey<span class=\"token punctuation\">,</span>\n        <span class=\"token keyword\">new</span> <span class=\"token class-name\">ByteArrayInputStream</span><span class=\"token punctuation\">(</span>plaintext<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ObjectMetadata</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Note: When you view this object in the S3 console, it shows “Encryption” as “None” because it was client-side encryption and not server-side.</p>\n<blockquote>\n<p><strong>Object</strong><br>\nKey: ExampleKMSEncryptedObject<br>\nLink: <a href=\"https://s3-us-west-2.amazonaws.com/kjh-encryption-test1/sdk-s3/ExampleKMSEncryptedObject\">https://s3-us-west-2.amazonaws.com/kjh-encryption-test1/sdk-s3/ExampleKMSEncryptedObject</a></p>\n<p><strong>Properties</strong><br>\nEncryption: None</p>\n</blockquote>\n<p>When you view the Metadata, you will see the tags the SDK uses to indicate client-side encryption (see <a href=\"https://docs.aws.amazon.com/AWSJavaSDK/latest/javadoc/com/amazonaws/services/s3/package-summary.html\">Appendix: Amazon S3 client-side encryption meta information</a>).</p>\n<blockquote>\n<p><strong>x-amz-meta-x-amz-cek-alg</strong>: AES/CBC/PKCS5Padding<br>\n<strong>x-amz-meta-x-amz-iv</strong>: VeF05slNCyQ1jvAHXDyQyw==<br>\n<strong>x-amz-meta-x-amz-key-v2</strong>: AQEDAHizfom2LowDtrU53mpnuTkvNGUC8c+nPE8dtp40x+QLMAAAAH4wfAYJKoZIhvcNAQcGoG8wbQIBADBoBgkqhkiG9w0BBwEwHgYJYIZIAWUDBAEuMBEEDGsVDhAswrMNCD2PkwIBEIA7rka2dnMOLtAcqNRAShf4iXULv95cqPEjwrf9zEwjPraTfxUN9LFX8EyS3YajUe7N6flxORd0Ybs3ilg=<br>\n<strong>x-amz-meta-x-amz-matdesc</strong>: {“kms_cmk_id”:“79cce4f6-7e4d-42ab-9942-9e6bb05b6121”}<br>\n<strong>x-amz-meta-x-amz-wrap-alg</strong>: kms</p>\n</blockquote>\n<p>This uses a single KMS key, from a single AWS region.  The <a href=\"https://github.com/awslabs/aws-encryption-sdk-java\">aws-encryption-sdk-java</a> now allows for multiple KMS keys (see also <a href=\"https://aws.amazon.com/blogs/security/new-aws-encryption-sdk-for-python-simplifies-multiple-master-key-encryption/\">New AWS Encryption SDK for Python Simplifies Multiple Master Key Encryption | AWS Security Blog</a> )</p>\n<p>However, check the <a href=\"https://docs.aws.amazon.com/encryption-sdk/latest/developer-guide/faq.html#s3-encryption-client\">Frequently Asked Questions - AWS Encryption SDK</a> about the difference between this and the S3 encryption client.</p>\n<blockquote>\n<p><strong>How is the AWS Encryption SDK different from the Amazon S3 encryption client?</strong></p>\n<p>The Amazon S3 encryption client in the <a href=\"http://docs.aws.amazon.com/AWSJavaSDK/latest/javadoc/index.html?com/amazonaws/services/s3/AmazonS3EncryptionClient.html\">AWS SDK for Java</a>, <a href=\"http://docs.aws.amazon.com/sdkforruby/api/Aws/S3/Encryption/Client.html\">AWS SDK for Ruby</a>, and <a href=\"http://docs.aws.amazon.com/sdkfornet/v3/apidocs/index.html?page=S3/TS3EncryptionS3EncryptionClient.html\">AWS SDK for .NET</a> provides encryption and decryption for data that you store in Amazon Simple Storage Service (Amazon S3). These clients are tightly coupled to Amazon S3 and are intended for use only with data stored there.</p>\n<p>The AWS Encryption SDK provides encryption and decryption for data that you can store anywhere. The AWS Encryption SDK and the Amazon S3 encryption client are not compatible because they produce ciphertexts with different data formats.</p>\n</blockquote>\n<p><strong>Open Question</strong>: What is the right pattern for multi-region client-side encryption of S3 objects using KMS?</p>","frontmatter":{"title":"AmazonS3EncryptionClient example","date":"April 14, 2017","tags":["aws","java","sdk","encryption"]}}},"pageContext":{"slug":"/2017-04-14-amazons3encryptionclient-example","previous":{"fields":{"slug":"/2017-03-09-thou-shalt-not-depend-on-me-analysing-the-use-of-outdated-javascript-libraries-on-the-web"},"frontmatter":{"tags":["javascript","security"]}},"next":{"fields":{"slug":"/2017-04-19-aws-stsassumerole-and-condition-keys"},"frontmatter":{"tags":["aws","iam"]}}}}}