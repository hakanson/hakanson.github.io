{"componentChunkName":"component---src-templates-blog-post-js","path":"/2018-09-04-cloud-custodian-code-confusion","result":{"data":{"site":{"siteMetadata":{"title":"kevinhakanson.com","author":"Kevin Hakanson"}},"markdownRemark":{"id":"8ba81fb4-388d-59a9-84cf-84811592c43f","excerpt":"A coworker and I were debugging incorrect results with our  Cloud Custodian policy.  Here is the filter that gave us 3 results when we were expecting 2: One of…","html":"<p>A coworker and I were debugging incorrect results with our <code class=\"language-text\">app-elb-outdated-securitypolicy.yaml</code> Cloud Custodian policy.  Here is the filter that gave us 3 results when we were expecting 2:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\">    <span class=\"token key atrule\">filters</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> listener\n        <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> Protocol\n        <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> HTTPS\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> listener\n        <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> SslPolicy\n        <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'ELBSecurityPolicy-TLS-1-2-2017-01'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">'ELBSecurityPolicy-FS-2018-06'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">'ELBSecurityPolicy-TLS-1-2-Ext-2018-06'</span><span class=\"token punctuation\">]</span>\n        <span class=\"token key atrule\">op</span><span class=\"token punctuation\">:</span> not<span class=\"token punctuation\">-</span>in</code></pre></div>\n<p>One of the extra items should have been excluded because of the SslPolicy <code class=\"language-text\">not-in</code> clause, but still appeared in our list.  We even changed the values in the array to garbage strings and no effect. So, we did what all good programmers do; assume it was a bug in someone else’s code, and try and work around it.  This workaround did what we expected, and we got 2 results:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\">    <span class=\"token key atrule\">filters</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> listener\n        <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> Protocol\n        <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> HTTPS\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">not</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> listener\n          <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> SslPolicy\n          <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'ELBSecurityPolicy-TLS-1-2-2017-01'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">'ELBSecurityPolicy-FS-2018-06'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">'ELBSecurityPolicy-TLS-1-2-Ext-2018-06'</span><span class=\"token punctuation\">]</span>\n          <span class=\"token key atrule\">op</span><span class=\"token punctuation\">:</span> in</code></pre></div>\n<p>However, that didn’t seem right, and since Cloud Custodian is open source, we dug into the <a href=\"https://github.com/capitalone/cloud-custodian/blob/d0687ab74bd882a017d2d780ef991d5a7444836b/c7n/resources/appelb.py#L643\">code</a> and found both custom logic and this comment:</p>\n<blockquote>\n<p>Adding the `matched` flag will filter on previously matched listeners</p>\n</blockquote>\n<p>So, per the in-code documentation, we should add <code class=\"language-text\">matched: true</code> - this worked as expected.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\">    <span class=\"token key atrule\">filters</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> listener\n        <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> Protocol\n        <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> HTTPS\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> listener\n        <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> SslPolicy\n        <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'ELBSecurityPolicy-TLS-1-2-2017-01'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">'ELBSecurityPolicy-FS-2018-06'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">'ELBSecurityPolicy-TLS-1-2-Ext-2018-06'</span><span class=\"token punctuation\">]</span>\n        <span class=\"token key atrule\">op</span><span class=\"token punctuation\">:</span> not<span class=\"token punctuation\">-</span>in\n        <span class=\"token key atrule\">matched</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span></code></pre></div>\n<p>Some comments/frustrations:</p>\n<ul>\n<li>Why couldn’t the documentation have better examples?  Going into the source code is a good way to see exactly what is going on, but time-consuming.  This is a down-side of open source.</li>\n<li>Why is the home-grown yaml policy language so confusing?  I like the idea of configuration over code, unless the configuration syntax requires more mental effort than reading code.</li>\n<li>How much harder will complex filter criteria make things.  If we are already struggling, how will this rule complexity scale?</li>\n</ul>","frontmatter":{"title":"Cloud Custodian Code Confusion","date":"September 04, 2018","tags":["aws","devops","security"]}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/2018-09-04-cloud-custodian-code-confusion","previous":{"fields":{"slug":"/2018-08-31-aws-waf-aws-shield-for-ddos-protection"},"frontmatter":{"tags":["aws","waf","security"]}},"next":{"fields":{"slug":"/2018-09-05-aws-waf-vs-aws-waf-regional"},"frontmatter":{"tags":["aws","waf","security"]}}}}}