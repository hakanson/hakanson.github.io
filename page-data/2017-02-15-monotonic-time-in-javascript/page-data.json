{"componentChunkName":"component---src-templates-blog-post-js","path":"/2017-02-15-monotonic-time-in-javascript/","result":{"data":{"site":{"siteMetadata":{"title":"kevinhakanson.com","author":"Kevin Hakanson"}},"markdownRemark":{"id":"09ecab23-4e29-51a2-8f0f-360e6f39cefe","excerpt":"I was looking at the source code for The AWS X-Ray SDK for Node.js and saw these code snippets: Whenever I see  in JavaScript for performance timings, my Spider…","html":"<p>I was looking at the source code for <a href=\"http://docs.aws.amazon.com/xray/latest/devguide/xray-sdk-nodejs.html\">The AWS X-Ray SDK for Node.js</a> and saw these code snippets:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token class-name\">Segment</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">init</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token function\">init</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">name<span class=\"token punctuation\">,</span> rootId<span class=\"token punctuation\">,</span> parentId</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \r\n  <span class=\"token keyword\">var</span> traceId <span class=\"token operator\">=</span> rootId <span class=\"token operator\">||</span> <span class=\"token string\">'1-'</span> <span class=\"token operator\">+</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">round</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getTime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token number\">16</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">'-'</span> <span class=\"token operator\">+</span>\r\n    crypto<span class=\"token punctuation\">.</span><span class=\"token function\">randomBytes</span><span class=\"token punctuation\">(</span><span class=\"token number\">12</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token string\">'hex'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token keyword\">var</span> id <span class=\"token operator\">=</span> crypto<span class=\"token punctuation\">.</span><span class=\"token function\">randomBytes</span><span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token string\">'hex'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token keyword\">var</span> startTime <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getTime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">/</span><span class=\"token number\">1000</span><span class=\"token punctuation\">;</span>\r\n\r\n<span class=\"token comment\">// ... stuff removed ...</span>\r\n\r\n<span class=\"token class-name\">Segment</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">close</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">e</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>end_time<span class=\"token punctuation\">)</span>\r\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>end_time <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getTime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">/</span><span class=\"token number\">1000</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Whenever I see <code class=\"language-text\">new Date()</code> in JavaScript for performance timings, my <a href=\"http://marvelanimated.wikia.com/wiki/Spider-Sense\">Spider-Sense</a> tingles. Browsers have <code class=\"language-text\">performance.now()</code> for this, which always returns values that increase at a constant rate. Other terms you see relating to this concept are monotonically increasing, monotonic clock, and monotonic time. For more info:</p>\n<ul>\n<li><a href=\"https://developers.google.com/web/updates/2012/08/When-milliseconds-are-not-enough-performance-now\">When milliseconds are not enough: performance.now  |  Web  |  Google Developers</a> </li>\n<li><a href=\"https://developer.mozilla.org/en-US/docs/Web/API/Performance/now\">performance.now() - Web APIs | MDN</a> </li>\n<li><a href=\"http://w3c.github.io/hr-time/\">High Resolution Time Level 3</a> </li>\n</ul>\n<p>Now, the X-Ray SDK is running in Node.js and not in the browser, but <a href=\"https://nodejs.org/api/process.html#process_process_hrtime_time\"><code class=\"language-text\">process.hrtime()</code></a> and NPM packages like <a href=\"https://www.npmjs.com/package/performance-now\"><code class=\"language-text\">performance-now</code></a> ensure the reported time will be monotonically increasing.</p>\n<p>Do you remember the leap second earlier this year? Do you also remember that this caused some problems? From <a href=\"https://blog.cloudflare.com/how-and-why-the-leap-second-affected-cloudflare-dns/\">How and why the leap second affected Cloudflare DNS</a>:</p>\n<blockquote>\n<h2>A falsehood programmers believe about time</h2>\n<p>The root cause of the bug that affected our DNS service was the belief that <em>time cannot go backwards</em>. In our case, some code assumed that the <em>difference</em> between two times would always be, at worst, zero.</p>\n<p>RRDNS is written in Go and uses Go’s <a href=\"https://golang.org/pkg/time/#Now\">time.Now()</a> function to get the time. Unfortunately, this function does not guarantee monotonicity. Go currently doesn’t offer a monotonic time source (see issue <a href=\"https://github.com/golang/go/issues/12914\">12914</a> for discussion).</p>\n</blockquote>\n<p>So, not understanding that computer time can go backward causes bigger problems than invalid performance metrics. It makes me glad <a href=\"http://www.bbc.co.uk/programmes/profiles/5Dp7g7b0dSVhD2TM1xNlf7c/the-tardis\">The TARDIS</a> is a living consciousness and not written in either JavaScript or Go.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 192px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/d0e5bc67c970355861eadd34a4f92cd2/7809d/pastedImage_1.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.08108108108109%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAwACBf/EABUBAQEAAAAAAAAAAAAAAAAAAAIE/9oADAMBAAIQAxAAAAEdgDDXSp6P/8QAGhAAAgIDAAAAAAAAAAAAAAAAAQIAAxASE//aAAgBAQABBQII25WwrzMSHH//xAAVEQEBAAAAAAAAAAAAAAAAAAABEP/aAAgBAwEBPwEZ/8QAFREBAQAAAAAAAAAAAAAAAAAAEDH/2gAIAQIBAT8Bp//EABsQAAEEAwAAAAAAAAAAAAAAAAIAARARI3Fy/9oACAEBAAY/AsdKyNtQXLz/AP/EABkQAQADAQEAAAAAAAAAAAAAAAEAESFxEP/aAAgBAQABPyF4sENWZLizwa4SPTsQtn//2gAMAwEAAgADAAAAEOvv/8QAFhEBAQEAAAAAAAAAAAAAAAAAAQAR/9oACAEDAQE/EEAgMv/EABURAQEAAAAAAAAAAAAAAAAAAAEA/9oACAECAQE/EEEsrf/EABoQAQADAQEBAAAAAAAAAAAAAAEAESExQWH/2gAIAQEAAT8QW7yeLa5FAWo6o0k3cYlJWxPiVTGvvaQxB7P/2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"TARDIS\"\n        title=\"\"\n        src=\"/static/d0e5bc67c970355861eadd34a4f92cd2/7809d/pastedImage_1.jpg\"\n        srcset=\"/static/d0e5bc67c970355861eadd34a4f92cd2/a80bd/pastedImage_1.jpg 148w,\n/static/d0e5bc67c970355861eadd34a4f92cd2/7809d/pastedImage_1.jpg 192w\"\n        sizes=\"(max-width: 192px) 100vw, 192px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>","frontmatter":{"title":"Monotonic Time in JavaScript","description":null,"date":"February 15, 2017","tags":["aws","xray","javascript","monitoring"],"canonical":null}}},"pageContext":{"slug":"/2017-02-15-monotonic-time-in-javascript/","previous":{"fields":{"slug":"/2017-02-14-web-browser-secure-contexts/"},"frontmatter":{"tags":["webdev","security"]}},"next":{"fields":{"slug":"/2017-03-02-cli-saml-authentication-and-aws-sts-assume-role/"},"frontmatter":{"tags":["aws","iam","cli"]}}}},"staticQueryHashes":["2589769190","97908498"],"slicesMap":{}}