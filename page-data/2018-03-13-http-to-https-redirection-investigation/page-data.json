{"componentChunkName":"component---src-templates-blog-post-js","path":"/2018-03-13-http-to-https-redirection-investigation","webpackCompilationHash":"7d39e4954020dd9078cb","result":{"data":{"site":{"siteMetadata":{"title":"kevinhakanson.com","author":"Kevin Hakanson"}},"markdownRemark":{"id":"9bf447b6-2519-58c6-a3cb-de49c6393faa","excerpt":"The recent efforts related to Google and Mozilla are Deprecating Existing Symantec Certificates had me revisit another HTTPS topic:  HTTP to HTTPS Redirection…","html":"<p>The recent efforts related to <a href=\"https://blog.qualys.com/ssllabs/2017/09/26/google-and-mozilla-deprecating-existing-symantec-certificates\">Google and Mozilla are Deprecating Existing Symantec Certificates</a> had me revisit another HTTPS topic:  HTTP to HTTPS Redirection.</p>\n<p><strong>Redirection</strong> is one of the items checked by <a href=\"https://observatory.mozilla.org/\">Observatory by Mozilla</a> and supported by the command line scanner.  Below is partial output from <code class=\"language-text\">httpobs-local-scan app1.example.com</code> containing the redirect flow:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token property\">\"redirection\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"destination\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"https://app1.example.com/app/login?lastReqId=2362881&amp;lkn=loginAllParms\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"expectation\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"redirection-to-https\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"pass\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"redirects\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"result\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"redirection-not-to-https-on-initial-redirection\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"route\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token string\">\"http://app1.example.com/\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"http://app1.example.com/app/setcookie?lastReqId=2309797&amp;lkn=cookieSetMachine\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"http://app1.example.com/app/setcookie?lastReqId=22f4772&amp;lkn=cookieSetMachine&amp;noCookie=on\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"http://app1.example.com/app/login?lastReqId=23754c6&amp;lkn=loginAllParms\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"https://app1.example.com/app/login?lastReqId=2362881&amp;lkn=loginAllParms\"</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"score_description\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Redirects to https eventually, but initial redirection is to another http URL\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"score_modifier\"</span><span class=\"token operator\">:</span> <span class=\"token number\">-10</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"status_code\"</span><span class=\"token operator\">:</span> <span class=\"token number\">200</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>App1 is hosted in a company data center behind an F5 BIG-IP VIP, so some of the redirect logic can be found in iRules.  Notice that this rule on VIP Port 80 does a redirect based on a valid hostname.</p>\n<div class=\"gatsby-highlight\" data-language=\"tcl\"><pre class=\"language-tcl\"><code class=\"language-tcl\">ltm rule app1.example.com_REDIR <span class=\"token punctuation\">{</span>\n    when HTTP_REQUEST <span class=\"token punctuation\">{</span>\n        <span class=\"token builtin\">if</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>HTTP::host<span class=\"token punctuation\">]</span> <span class=\"token operator\">!=</span> <span class=\"token string\">\"app1.example.com\"</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">{</span>\n        HTTP::redirect <span class=\"token string\">\"http://app1.example.com[HTTP::uri]\"</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This could always just do an initial HTTPS redirect (which adds an additional redirect), but at least the cookies would be secure.  There is probably some application work in App1 to minimize the redirect counts.</p>\n<div class=\"gatsby-highlight\" data-language=\"tcl\"><pre class=\"language-tcl\"><code class=\"language-tcl\">when HTTP_REQUEST <span class=\"token punctuation\">{</span>\n    HTTP::redirect <span class=\"token string\">\"https://app1.example.com[HTTP::uri]\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>A scan of App2 passes.</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token property\">\"redirection\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"destination\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"https://app2.example.com/\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"expectation\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"redirection-to-https\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"pass\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"redirects\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"result\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"redirection-to-https\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"route\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token string\">\"http://app2.example.com/\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"https://app2.example.com/\"</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"score_description\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Initial redirection is to https on same host, final destination is https\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"score_modifier\"</span><span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"status_code\"</span><span class=\"token operator\">:</span> <span class=\"token number\">200</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>It has the expected iRule on VIP Port 80 that always redirects to HTTPS.</p>\n<div class=\"gatsby-highlight\" data-language=\"tcl\"><pre class=\"language-tcl\"><code class=\"language-tcl\">ltm rule APP2_REDIR_HTTP <span class=\"token punctuation\">{</span>\n    when HTTP_REQUEST <span class=\"token punctuation\">{</span>\n        HTTP::redirect <span class=\"token string\">\"https://app2.example.com[HTTP::uri]\"</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>A scan of App3 shows a failure.</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token property\">\"redirection\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"destination\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"http://app3.example.com/\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"expectation\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"redirection-to-https\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"pass\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"redirects\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"result\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"redirection-missing\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"route\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token string\">\"http://app3.example.com/\"</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"score_description\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Does not redirect to an https site\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"score_modifier\"</span><span class=\"token operator\">:</span> <span class=\"token number\">-20</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"status_code\"</span><span class=\"token operator\">:</span> <span class=\"token number\">200</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>But the browser shows App3 is secure, which can be explained by looking at the network graph. The full site loads, then client-side JavaScript initiates a redirect (at the performance cost of about 1/2 second).</p>\n<p>In AWS, CloudFront supports a Redirect HTTP to HTTPS (see <a href=\"https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/using-https-viewers-to-cloudfront.html\">Requiring HTTPS for Communication Between Viewers and CloudFront - Amazon CloudFront</a> )</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 370px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/85a127e5b9286ea7408fb16ea1f38f72/04e89/pastedImage_27.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 19.189189189189186%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsSAAALEgHS3X78AAAAvklEQVQY04WPXWvCQBRE8///VqulUFDZdSNi4yb7VdOYRK340GZPN/GlDy0dGAaGy+FOFkKgaRqCD8meun5n7Kw1tF0P8YvruUPrCmssPvU+vLHXmjL5p2KMZEII9kWBqQy5Umy3O8qyYpNvsKXGnuBRWpRYsRaStZQolbNcLO431pKn7PvTBM34RyY9+SAdL89PzGbzCfa6K+jaluOxndI5z+XycQcOw8CfThOIn9yuZw6HGu/cNHsE/KZx8jeiYC04bEBKPAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Viewer Protocol Policy\"\n        title=\"Viewer Protocol Policy\"\n        src=\"/static/85a127e5b9286ea7408fb16ea1f38f72/04e89/pastedImage_27.png\"\n        srcset=\"/static/85a127e5b9286ea7408fb16ea1f38f72/cf440/pastedImage_27.png 148w,\n/static/85a127e5b9286ea7408fb16ea1f38f72/d2d38/pastedImage_27.png 295w,\n/static/85a127e5b9286ea7408fb16ea1f38f72/04e89/pastedImage_27.png 370w\"\n        sizes=\"(max-width: 370px) 100vw, 370px\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>AWS ELB requires you to configure this in your web server (see <a href=\"https://aws.amazon.com/premiumsupport/knowledge-center/redirect-http-https-elb/\">Redirect HTTP Traffic to HTTPS Using ELB</a> ) but ALB now supports redirects as an option on the HTTP listener.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/5e9e4808e35ace6fe1f2819653449735/e7c6f/pastedImage_65.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 42.41645244215938%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAAA4ElEQVQoz6WS2w6DIAxA/f9v9GGCiSLeAUWjdm2VRZ3Zy0xOCr2XGumiAJmmkOc5TNOMTOC9Z0nM83y5B846Onu/+0Z930PTtKzsug7PDYzjeDjt0P2se0oYikfk6JzjgGVZYNs2+OeLFI4qEgFSSqjrGoZhAGsNGGO4EEnCWgvOOrav68rBVPwOjxzHMbyShBPSyM0h27b9QM9B76yUuiT76pCqCyH2RIjWmoMpucAiKS6M7AUuL9hCwseRHY6SZRk7B8IiaOTA/hSW+dkhOZRlCRXCsqo4+P6bEKHIrw7fQUVtJgawtswAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"ALB HTTP Listener settings\"\n        title=\"ALB HTTP Listener settings\"\n        src=\"/static/5e9e4808e35ace6fe1f2819653449735/b9e4f/pastedImage_65.png\"\n        srcset=\"/static/5e9e4808e35ace6fe1f2819653449735/cf440/pastedImage_65.png 148w,\n/static/5e9e4808e35ace6fe1f2819653449735/d2d38/pastedImage_65.png 295w,\n/static/5e9e4808e35ace6fe1f2819653449735/b9e4f/pastedImage_65.png 590w,\n/static/5e9e4808e35ace6fe1f2819653449735/e7c6f/pastedImage_65.png 778w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>The Apache rewrite rule is below and would be the recommended approach for App3.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">RewriteEngine On\nRewriteCond %{HTTP:X-Forwarded-Proto} =http\nRewriteRule .* https://%{HTTP:Host}%{REQUEST_URI} [L,R=permanent]</code></pre></div>\n<p>Now, take a couple minutes and go read <a href=\"https://scotthelme.co.uk/wifi-pineapple-karma-sslstrip/\">The WiFi Pineapple - Using Karma and SSLstrip to MiTM secure connections</a>  </p>\n<p><img src=\"https://www.troyhunt.com/content/images/2016/02/31233122are-you-my-network3.jpg\" alt=\"Karma saying it is the device&#x27;s preferred network\"></p>\n<p>Let me highlight a key point of this attack:</p>\n<blockquote>\n<p>SSLstrip works by monitoring HTTP traffic and waiting for links or redirects that use HTTPS. Once it finds a link or redirect using HTTPS it will transparently re-write it to the HTTP equivalent and pass it along to the victim.</p>\n</blockquote>\n<p>Given that HTTP to HTTPS redirection isn’t sufficient to protect our applications, what now? Make sure to leverage security focused HTTP headers, including <a href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Strict-Transport-Security\">Strict-Transport-Security</a> and <a href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy\">Content-Security-Policy</a>.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Strict-Transport-Security: max-age=31536000;\nContent-Security-Policy: upgrade-insecure-requests;</code></pre></div>\n<p>The iRule code to set these looks like</p>\n<div class=\"gatsby-highlight\" data-language=\"tcl\"><pre class=\"language-tcl\"><code class=\"language-tcl\">when HTTP_RESPONSE <span class=\"token punctuation\">{</span>\n     HTTP::header replace <span class=\"token string\">\"Strict-Transport-Security\"</span> <span class=\"token string\">\"max-age=31536000;\"</span>\n     HTTP::header replace <span class=\"token string\">\"Content-Security-Policy\"</span> <span class=\"token string\">\"upgrade-insecure-requests;\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>And for use in an Apache config</p>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>IfModule</span> <span class=\"token attr-name\">mod_headers.c</span><span class=\"token punctuation\">></span></span>\n   Header set Strict-Transport-Security \"max-age=31536000;\"\n   Header set Content-Security-Policy \"upgrade-insecure-requests;\"\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>IfModule</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>Because the browser “remembers” to always connect over HTTPS, there is both a security gain and a performance gain of skipping the first round-trip just for HTTP to HTTPS redirection.</p>\n<p>Later on, the Content-Security-Policy could be updated to ensure only https connections, but this has the side effect of not allowing inline scripts or styles.</p>\n<blockquote>\n<p>default-src https:; form-action https:; connect-src https: wss:; upgrade-insecure-requests</p>\n</blockquote>","frontmatter":{"title":"HTTP to HTTPS Redirection Investigation","date":"March 13, 2018","tags":["http","webdev","security"]}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/2018-03-13-http-to-https-redirection-investigation","previous":{"fields":{"slug":"/2018-03-08-access-logs-from-aws-services"},"frontmatter":{"tags":["aws","http","monitoring"]}},"next":{"fields":{"slug":"/2018-03-15-amazon-load-balancers-x-forwarded-headers-and-proxy-protocol-support"},"frontmatter":{"tags":["aws","http","networking"]}}}}}