{"componentChunkName":"component---src-templates-blog-post-js","path":"/2016-08-15-how-iam-roles-become-credentials-on-ec2","webpackCompilationHash":"aaf2e98adf17fa9c33ba","result":{"data":{"site":{"siteMetadata":{"title":"kevinhakanson.com","author":"Kevin Hakanson"}},"markdownRemark":{"id":"c23e735c-4972-55a8-913b-ed60e0529d0c","excerpt":"While investigating how to secure S3 buckets using IAM Roles, I was curious how the IAM Role assigned to my EC2 instance became the credentials an AWS based…","html":"<p>While investigating how to secure S3 buckets using IAM Roles, I was curious how the IAM Role assigned to my EC2 instance became the credentials an AWS based application could use.  IAM Roles for EC2 are the recommended practices, but how they worked was “magic” to me.</p>\n<p>First, I created an IAM Role with a policy that allowed Get, Put, and Delete access to my S3 bucket.</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>  \n    <span class=\"token property\">\"Version\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2012-10-17\"</span><span class=\"token punctuation\">,</span>  \n    <span class=\"token property\">\"Statement\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>  \n        <span class=\"token punctuation\">{</span>  \n            <span class=\"token property\">\"Sid\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Stmt1471042403000\"</span><span class=\"token punctuation\">,</span>  \n            <span class=\"token property\">\"Effect\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Allow\"</span><span class=\"token punctuation\">,</span>  \n            <span class=\"token property\">\"Action\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>  \n                <span class=\"token string\">\"s3:DeleteObject\"</span><span class=\"token punctuation\">,</span>  \n                <span class=\"token string\">\"s3:GetObject\"</span><span class=\"token punctuation\">,</span>  \n                <span class=\"token string\">\"s3:PutObject\"</span>  \n            <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>  \n            <span class=\"token property\">\"Resource\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>  \n                <span class=\"token string\">\"arn:aws:s3:::kjh-encryption-test1/*\"</span>  \n            <span class=\"token punctuation\">]</span>  \n        <span class=\"token punctuation\">}</span>  \n    <span class=\"token punctuation\">]</span>  \n<span class=\"token punctuation\">}</span>  </code></pre></div>\n<p>Then, I created an EC2 instance and assigned that IAM role:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 290px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/39b7f5e5d755fe4bf85cec837cb0618c/bb113/pastedImage_2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 18.965517241379313%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsSAAALEgHS3X78AAAA0UlEQVQY022Q226DMBBE+f+fq/qQNIE2AQdsU8DB5hKghVPjRupLR1qN9mhXO9poXVfYNvrOYYzBOYe1jl3dMGPaB3e314TtpsAaz1w/03Zz4P24BJ+WbyKeKrXk+HYkSzNOcRKYaibOmSNTAxc5cBYdp9RyuFg+cufd8JrU6KrnJa6p7EQkxA1zv6O1pm13V3xW1e8RJdEyR5clTV2hVYG4CZTnX8vMf4oSnyYTgjiO/bIkeU/8Uv5MrZBFEXpZSK7XlDRNg4/jI8ys6+Y/9lc/PTEu7ZPf9fcAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"IAM role and Key pair name\"\n        title=\"IAM role and Key pair name\"\n        src=\"/static/39b7f5e5d755fe4bf85cec837cb0618c/bb113/pastedImage_2.png\"\n        srcset=\"/static/39b7f5e5d755fe4bf85cec837cb0618c/cf440/pastedImage_2.png 148w,\n/static/39b7f5e5d755fe4bf85cec837cb0618c/bb113/pastedImage_2.png 290w\"\n        sizes=\"(max-width: 290px) 100vw, 290px\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>I connected to my instance over SSH…</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">ssh</span> -i kjh-tax-sandbox.pem ec2-user@54.200.155.114</code></pre></div>\n<p>…and on that instance, I followed the instruction from <a href=\"http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/iam-roles-for-amazon-ec2.html#instance-metadata-security-credentials\">IAM Roles for Amazon EC2 - Amazon Elastic Compute Cloud</a> to get the credentials the same way the AWS SDK does:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">curl</span> http://169.254.169.254/latest/meta-data/iam/security-credentials/kjh-s3-encryption-test1-role  \n<span class=\"token punctuation\">{</span>  \n  <span class=\"token string\">\"Code\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"Success\"</span>,  \n  <span class=\"token string\">\"LastUpdated\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2016-08-13T16:36:13Z\"</span>,  \n  <span class=\"token string\">\"Type\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"AWS-HMAC\"</span>,  \n  <span class=\"token string\">\"AccessKeyId\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"ASIAJ27C6XNOZEXAMPLE\"</span>,  \n  <span class=\"token string\">\"SecretAccessKey\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"rrGyOOa3TPLJQIIedUfW5hbCzPXb+EXAMPLEKEY\"</span>,  \n  <span class=\"token string\">\"Token\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"TOKEN\"</span>,  \n  <span class=\"token string\">\"Expiration\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2016-08-13T23:09:05Z\"</span>  \n<span class=\"token punctuation\">}</span>  </code></pre></div>\n<p>For a test, I edited my local <code class=\"language-text\">.aws/credentials</code> to add a new profile to match that ec2role</p>\n<div class=\"gatsby-highlight\" data-language=\"ini\"><pre class=\"language-ini\"><code class=\"language-ini\"><span class=\"token selector\">[ec2role]</span>  \n<span class=\"token constant\">aws_access_key_id</span> <span class=\"token attr-value\"><span class=\"token punctuation\">=</span> ASIAJ27C6XNOZEXAMPLE  </span>\n<span class=\"token constant\">aws_secret_access_key</span> <span class=\"token attr-value\"><span class=\"token punctuation\">=</span> rrGyOOa3TPLJQIIedUfW5hbCzPXb+EXAMPLEKEY  </span>\n<span class=\"token constant\">aws_session_token</span> <span class=\"token attr-value\"><span class=\"token punctuation\">=</span> TOKEN</span></code></pre></div>\n<p>Then, from my local machine, I did an upload using the AWS CLI S3 command and specifying that new <code class=\"language-text\">ec2role</code> profile.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ aws --profile ec2role s3 <span class=\"token function\">cp</span> quickbrownfox.txt s3://kjh-encryption-test1/cli-s3-sse/ --sse  \nupload: ./quickbrownfox.txt to s3://kjh-encryption-test1/cli-s3-sse/quickbrownfox.txt</code></pre></div>\n<p>Back on the EC2 instance, I downloaded that same file, but using the default profile</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ aws s3 <span class=\"token function\">cp</span> s3://kjh-encryption-test1/cli-s3-sse/quickbrownfox.txt quickbrownfox.txt  \ndownload: s3://kjh-encryption-test1/cli-s3-sse/quickbrownfox.txt to ./quickbrownfox.txt  </code></pre></div>\n<p>Everything worked as expected.  AWS took care of supplying IAM credentials to an EC2 instance in a way the AWS SDK could find them.  However, since I had root access via SSH, it was also easy for me to “steal” my own credentials and access that S3 bucket from outside the VPC.  For protecting customer data stored in S3, additional controls like <a href=\"http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/vpc-endpoints.html\">VPC Endpoints</a> or <a href=\"https://docs.aws.amazon.com/AmazonS3/latest/dev/ServerSideEncryptionCustomerKeys.html\">Using Server-Side Encryption with Customer-Provided Encryption Keys (SSE-C)</a> should be considered.</p>","frontmatter":{"title":"How IAM Roles Become Credentials on EC2","date":"August 15, 2016","tags":["aws","iam","security"]}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/2016-08-15-how-iam-roles-become-credentials-on-ec2","previous":{"fields":{"slug":"/2016-07-29-net-zipkin-investigation-medidatazipkintracermodule"},"frontmatter":{"tags":["dotnet","api","monitoring"]}},"next":{"fields":{"slug":"/2016-08-22-investigating-cloudtrail-for-s3-putbucketnotification"},"frontmatter":{"tags":["aws","cloudtrail","s3"]}}}}}